---
title: 'Force-based regulation of splicing during Myoblast differentiation'
subtitle: "Stage 1: Bioinformatical Analysis of Myogenic Transcripts"
author: "Andrés Gordo Ortiz @Al Jord Lab CRG"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    code_folding: show
    code_download: false  
    df_print: paged
    theme: flatly
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    number_sections: true

editor_options: 
  markdown: 
    wrap: 72
    
# NOTE: To run this R Markdown file correctly, set the Knit Directory to the Project Directory.
# You can do this by navigating to the gear icon next to the Knit button in RStudio,
# and selecting "Project Directory" as the option. This ensures paths resolve correctly. Also, to download libraries in the same version as mine, you can use the following code:
# install.packages("renv")
# renv::init()
# renv::restore()
---

```{css, echo=FALSE}
/* Custom CSS to enhance styling */
body {
  font-family: 'Gill Sans', sans-serif;
}

h1 {
  color: #2c3e50;
  font-family: 'Ubuntu', sans-serif; /* Set header font to Ubuntu */
}

h2 {
  color: #3498db;
  font-family: 'Ubuntu', sans-serif; /* Set header font to Ubuntu */
}

h3 {
  color: #7DE2D1;
  font-family: 'Ubuntu', sans-serif; /* Set header font to Ubuntu */
}
p {
  text-align: justify;
}
```

```{r setup, include=FALSE}
# Ensure a clean environment and load required libraries.
knitr::opts_chunk$set(
  echo = TRUE, 
  warning = FALSE, 
  message = FALSE
)

# Function to install and load packages dynamically.
install_load <- function(pkg) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg, dependencies = TRUE)
    library(pkg, character.only = TRUE)
  }
}

# Load required libraries
install_load("betAS")
install_load("ggplot2")
install_load("plotly")
install_load("dplyr")
install_load("tidyverse")
install_load("cowplot")
install_load("DT")
install_load("paletteer")
library("patchwork")
library("org.Mm.eg.db")
library("enrichplot")
library("DOSE")
library("clusterProfiler")
library("ReactomePA")
```

# Introduction to this Analysis

## Objective

The primary aim is to identify a list of splicing events that meet the following criteria:
1. **Differential Splicing**: Events are differentially spliced during myoblast differentiation.
2. **Spatial Relevance**: Events occur near or around nuclear speckles.

This analysis is structured into four distinct parts, each focusing on a critical step towards achieving the final goal.

---

## **Part 1: Upstream Analysis**

The upstream analysis is performed on the CRG cluster using the Bash command line. This phase involves:

1. **Data Acquisition**: 
   - Downloading `*.fastq.gz` files from five different databases.

2. **Alignment**: 
   - Aligning the sequences to the latest mouse genome release (mm10) using **Bowtie2** through the [Vast-Tools align function](https://link.springer.com/protocol/10.1007/978-1-0716-2521-7_7).

3. **Event Detection**:
   - Importing inclusion tables generated by Vast-Tools into RStudio. The tables cover the following splicing events:
     - **Exons (EX)**
     - **Introns (IN)**
     - **Alternative 5' Splice Sites (Alt5)**
     - **Alternative 3' Splice Sites (Alt3)**
     - **Microexons (MIC)**

---

## **Part 2: Statistical Analysis**

### Objective
To identify splicing events that are differentially spliced during myoblast differentiation.

### Steps

1. **Statistical Testing**: 
   - Use the [betAS package](https://rnajournal.cshlp.org/content/30/4/337) in R to perform:
     - **False Discovery Rate (FDR)**
     - **F-statistic**
     - **Probability of Differential Splicing (Pdiff)**

2. **Filtering Criteria**:
   - Retain events with:
     - **FDR ≤ 0.05**
     - **Pdiff ≥ 0.95**

3. **Batch Effect Mitigation**:
   - Each database is analyzed independently to control for batch effects and confounders.
   - A final list is generated by intersecting the splicing events identified in all five databases. This ensures the events are associated exclusively with differentiation.

4. **Integration of Results**:
   - Fourteen lists (7 for exons and 7 for introns) are generated:
     - Two databases contain multiple differentiation conditions, requiring additional ANOVA tables for more stringent filtering.
   - Shared events across lists are conserved and ranked by:
     - **F-statistic**
     - **ΔPSI (Differential Percentage Spliced In)**

5. **Candidate Selection**:
   - The top 100 ranked events are selected for downstream analysis.

---

## **Part 3: Sequence Feature Analysis**

### Objective
To characterize the sequence features of candidate events using computational tools.

### Steps

1. **Feature Extraction**:
   - Run analysis on the CRG cluster using [Matt](https://academic.oup.com/bioinformatics/article/35/1/130/5053311) to extract:
     - **CG content**
     - **Sequence length**
     - **5'/3' splice site scores**

2. **Data Integration**:
   - Return the processed dataset to R for subsequent analysis.

---

## **Part 4: Functional Annotation and Scoring**

### Objective
To determine the functional relevance of candidate splicing events in myoblast differentiation and their spatial association with nuclear speckles.

### Steps

1. **Gene Ontology and Literature Mining**:
   - Use gene ontology tools and literature review to:
     - Assess the functional role of genes.
     - Identify associations with myoblast differentiation and nuclear speckles.

2. **Scoring System**:
   - Develop a scoring framework to rank transcripts based on:
     - Functional relevance
     - Sequence features
     - Spatial proximity to nuclear speckles

---

## Data Availability

| Name              | Publisher                             | ENA Link  | Year | Study Specs                                                                                                                                                                                           | Details                                                 |
|-------------------|---------------------------------------|-----------|------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|
| Kuo Zhang         | Nature Communications                 | [SRP160431](https://www.ebi.ac.uk/ena/browser/view/SRP160431) | 2018 | Reads from knock-down and shControl cells in myoblast and myotube stages. Controls include 3 paired-end biological replicates each for myoblast and myotubes, totaling 12 fastq files.                | ~30M per biosample                                      |
| Lingjian Tao      | Molecular Biotechnology               | [SRP496253](https://www.ebi.ac.uk/ena/browser/view/SRP496253) | 2024 | Myotube formation observed after 4 days, full maturation at 7 days. 3 paired-end biological replicates per condition across 4 timepoints (0, 2, 4, 7 days), totaling 24 fastq files.                  | ~44M per biosample                                      |
| Pengcheng Lyu     | MDPI Cells (data quality verified)    | [SRP335878](https://www.ebi.ac.uk/ena/browser/view/SRP335878) | 2022 | C2C12 cells differentiated in media, with autophagy inhibition using chloroquine (10 µM or 20 µM). 2 paired-end biological replicates per condition for myoblast and myotube stages, 8 fastq files.   | ~45M per biosample                                      |
| Dominic W. Kolonay | Frontiers in Cell and Developmental Biology | [SRP471123](https://www.ebi.ac.uk/ena/browser/view/SRP471123) | 2024 | Myoblasts differentiated to myotubes in DMEM with horse serum and antibiotics over 5 days. 3 paired-end biological replicates per condition (0 days myoblast, 5 days myotube), totaling 12 fastq files. | ~90M per biosample in myotubes, ~140M per biosample in myoblasts |
| Christopher Azar  | Physiological Reports                 | [SRP198848](https://www.ebi.ac.uk/ena/browser/view/SRP198848) | 2021 | Cells differentiated for 6 days with daily media changes. 3 single-end biological replicates per condition (0 days myoblast, 6 days myotube), totaling 6 fastq files.                                 | ~30M per biosample

---

## Importing Inclusion Data

```{r inclusion tables}
# Zhang et al. 2018 data
zhang_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/Zhang_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
zhang_events <- getEvents(zhang_data, tool = "vast-tools") # Extract alternative splicing events
zhang_events <- alternativeEvents(zhang_events, minPsi = 1, maxPsi = 99) # Filter events based on PSI thresholds
zhang_exons <- filterEvents(zhang_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 3)
zhang_introns <- filterEvents(zhang_events, types = c("IR"), N = 5)

# Lyu et al. 2022 data
lyu_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/Lyu_Cells_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
lyu_events <- getEvents(lyu_data, tool = "vast-tools") # Extract alternative splicing events
lyu_events <- alternativeEvents(lyu_events, minPsi = 1, maxPsi = 99) # Filter events based on PSI thresholds
lyu_exons <- filterEvents(lyu_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 3)
lyu_introns <- filterEvents(lyu_events, types = c("IR"), N = 5)

# Tao et al. 2024 data
tao_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/Tao_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
tao_events <- getEvents(tao_data, tool = "vast-tools") # Extract alternative splicing events
tao_events <- alternativeEvents(tao_events, minPsi = 1, maxPsi = 99) # Filter events based on PSI thresholds
tao_exons <- filterEvents(tao_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 3)
tao_introns <- filterEvents(tao_events, types = c("IR"), N = 5)

# Christopher Azar 2021 data
christopher_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/Christopher_Physioreports_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
christopher_events <- getEvents(christopher_data, tool = "vast-tools") # Extract alternative splicing events
christopher_events <- alternativeEvents(christopher_events, minPsi = 1, maxPsi = 99) # Filter events based on PSI thresholds
christopher_exons <- filterEvents(christopher_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 3)
christopher_introns <- filterEvents(christopher_events, types = c("IR"), N = 5)
```


## Metadata { .tabset}

```{r metadata zhang}
# Load metadata file containing sample information
metadata_zhang <- read.csv(paste0(getwd(),"/metadata/zhang_metadata.csv"), sep = ",")
DT::datatable(metadata_zhang, options = list(pageLength = nrow(metadata_zhang), scrollX = TRUE))
```

```{r metadata lyu}
# Load metadata file containing sample information
metadata_lyu <- read.csv(paste0(getwd(),"/metadata/lyu_metadata.csv"), sep = ",")
DT::datatable(metadata_lyu, options = list(pageLength = nrow(metadata_lyu), scrollX = TRUE))
```

```{r metadata tao}
# Load metadata file containing sample information
metadata_tao <- read.csv(paste0(getwd(),"/metadata/tao_metadata.csv"), sep = ",")
DT::datatable(metadata_tao, options = list(pageLength = nrow(metadata_tao), scrollX = TRUE))
```

```{r metadata christopher}
# Load metadata file containing sample information
metadata_christopher <- read.csv(paste0(getwd(),"/metadata/christopher_metadata.csv"), sep = ",")
DT::datatable(metadata_christopher, options = list(pageLength = nrow(metadata_christopher), scrollX = TRUE))
```

---

# Splicing & Sample Quality Checking

## PSI Distribution Plots { .tabset}

### Zhang

```{r psi distribution zhang}
# Create the first plot for exon inclusion levels
bigPicturePlotExons <- bigPicturePlot(table = zhang_exons$PSI)

# Customize the first plot for professional reporting
plot1 <- bigPicturePlotExons +
  ggtitle("Exon Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Create a second plot for a hypothetical dataframe
# Replace 'hypothetical_data$PSI' with your actual dataframe and column
bigPictureIntrons <- bigPicturePlot(table = zhang_introns$PSI)

# Customize the second plot
plot2 <- bigPictureIntrons +
  ggtitle("Introns Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Combine both plots into one figure using patchwork
plot1 + plot2
```

### Lyu

```{r lyu distribution plot}
# Create the first plot for exon inclusion levels
bigPicturePlotExons <- bigPicturePlot(table = lyu_exons$PSI)

# Customize the first plot for professional reporting
plot1 <- bigPicturePlotExons +
  ggtitle("Exon Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Create a second plot for a hypothetical dataframe
# Replace 'hypothetical_data$PSI' with your actual dataframe and column
bigPictureIntrons <- bigPicturePlot(table = lyu_introns$PSI)

# Customize the second plot
plot2 <- bigPictureIntrons +
  ggtitle("Introns Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Combine both plots into one figure using patchwork
plot1 + plot2
```

### Tao

```{r tao distri plots}
# Create the first plot for exon inclusion levels
bigPicturePlotExons <- bigPicturePlot(table = tao_exons$PSI)

# Customize the first plot for professional reporting
plot1 <- bigPicturePlotExons +
  ggtitle("Exon Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Create a second plot for a hypothetical dataframe
# Replace 'hypothetical_data$PSI' with your actual dataframe and column
bigPictureIntrons <- bigPicturePlot(table = tao_introns$PSI)

# Customize the second plot
plot2 <- bigPictureIntrons +
  ggtitle("Introns Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Combine both plots into one figure using patchwork
plot1 + plot2
```

### Christopher

```{r christopher distro plots}
# Create the first plot for exon inclusion levels
bigPicturePlotExons <- bigPicturePlot(table = christopher_exons$PSI)

# Customize the first plot for professional reporting
plot1 <- bigPicturePlotExons +
  ggtitle("Exon Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Create a second plot for a hypothetical dataframe
# Replace 'hypothetical_data$PSI' with your actual dataframe and column
bigPictureIntrons <- bigPicturePlot(table = christopher_introns$PSI)

# Customize the second plot
plot2 <- bigPictureIntrons +
  ggtitle("Introns Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Combine both plots into one figure using patchwork
plot1 + plot2
```

## PCA Plot

```{r pca calculation}
# Subset and scale data
pca_zhang <- zhang_data[, c("EVENT",zhang_events$Samples)]
pca_tao <- tao_data[,  c("EVENT",tao_events$Samples)]
pca_lyu <- lyu_data[,  c("EVENT",lyu_events$Samples)]
pca_christopher <- christopher_data[,  c("EVENT",christopher_events$Samples)]
# merge pca data columns by row names
merged_pca <- pca_zhang %>%
  left_join(pca_tao, by = "EVENT") %>%
  left_join(pca_lyu, by = "EVENT") %>%
  left_join(pca_christopher, by="EVENT") %>%
  na.omit()
rownames(merged_pca)<- merged_pca$EVENT
merged_pca<-t(merged_pca[,-1])

metadata_merged<-tibble(sample=c(metadata_zhang$run_accession,metadata_tao$run_accession,metadata_lyu$run_accession,metadata_christopher$run_accession),experiment_title=c(metadata_zhang$experiment_title,metadata_tao$experiment_title,metadata_lyu$experiment_title,metadata_christopher$experiment_title))

# Reorder metadata_merged$experiment_title based on the row names of merged_pca
condition_pca <- metadata_merged$experiment_title[match(rownames(merged_pca), metadata_merged$sample)]


pca_result <- prcomp(merged_pca)  # Perform PCA

# Prepare PCA results for plotting
pca_data <- as.data.frame(pca_result$x)
pca_data$Sample <- rownames(pca_data)
pca_data$condition<-condition_pca
pca_data$data_origin<-c(rep("Zhang",ncol(pca_zhang)-1),rep("Tao",ncol(pca_tao)-1),rep("Lyu",ncol(pca_lyu)-1),rep("Christopher",ncol(pca_christopher)-1))
```

```{r pca plotting}
# Create PCA plot
pca_plot<-ggplot(pca_data, aes(x = PC1, y = PC2, color = as.factor(condition), shape=as.factor(data_origin))) +
  geom_point(size = 6) +
  labs(
    title = "PCA of Samples (PSI Data)",
    x = paste("PC1 (", round(100 * summary(pca_result)$importance[2, 1], 1), "%)", sep = ""),
    y = paste("PC2 (", round(100 * summary(pca_result)$importance[2, 2], 1), "%)", sep = "")
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_blank(),
    axis.title = element_text(size = 14)
  ) + coord_fixed()
pca_plot
```

## Total Splicing Events

```{r splicing events barplot stacked}
# Create a stacked bar plot of splicing events
splicing_events<-tibble(event_type=names(zhang_events$EventsPerType), zhang=zhang_events$EventsPerType, tao=tao_events$EventsPerType, lyu=lyu_events$EventsPerType, christopher=christopher_events$EventsPerType)

splicing_events_long<-splicing_events %>% pivot_longer(cols=c(zhang, tao, lyu, christopher), names_to="study", values_to="count")

# Combine specific event types and update the dataset
splicing_events_long <- splicing_events_long %>%
  mutate(event_type = ifelse(event_type %in% c("C1", "C2", "C3", "ANN", "S", "MIC"), "EX", event_type)) %>%
  group_by(study, event_type) %>%
  summarize(count = sum(count, na.rm = TRUE), .groups = "drop")



# Stacked bar plot (proportion)
plot_proportion <- ggplot(splicing_events_long, aes(fill = event_type, y = count, x = study)) + 
  geom_bar(position = "fill", stat = "identity") +
  labs(
    title = "Proportion of Splicing Events by Study",
    x = "",
    y = "Proportion of Events",
    fill = "Event Type"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  scale_fill_paletteer_d("MetBrewer::Hokusai3")

# Regular bar plot (absolute counts)
plot_absolute <- ggplot(splicing_events_long, aes(color = event_type, y = count, x = study)) + 
  geom_point(size=4) +
  labs(
    x = "Study",
    y = "Number of Events",
  ) +
  theme_minimal() + scale_colour_paletteer_d("MetBrewer::Hokusai3") +
  theme(
    legend.position = "none", # Remove legend
    plot.margin = margin(0, 0, 0, 0) # Remove extra spacing
  )

# Combine the two plots vertically
combined_plot <- plot_proportion / plot_absolute +
  plot_layout(heights = c(1, 0.3)) & theme(plot.margin = margin(2, -5, 4, 0))

# Display the combined plot
combined_plot
```

# Differential Splicing

```{r aux_featuregroup}
# Extract unique groups and sample IDs
groupingVariable <- "experiment_title"
# Zhang
groups_zhang <- unique(metadata_zhang[, groupingVariable])
samples_zhang <- metadata_zhang$run_accession
# Tao
groups_tao <- unique(metadata_tao[, groupingVariable])
samples_tao <- metadata_tao$run_accession
# Lyu
groups_lyu <- unique(metadata_lyu[, groupingVariable])
samples_lyu <- metadata_lyu$run_accession
# Christopher
groups_christopher <- unique(metadata_christopher[, groupingVariable])
samples_christopher <- metadata_christopher$run_accession



random_colors=c("#D8D97AFF", "#95C36EFF", "#74C8C3FF", "#5A97C1FF", "#295384FF", "#0A2E57FF")
  
# Create group list with metadata
groupList_zhang <- lapply(1:length(groups_zhang), function(i) {
  list(
    name = groups_zhang[i],
    samples = samples_zhang[metadata_zhang[, groupingVariable] == groups_zhang[i]],
    color = random_colors[i]
  )
})
names(groupList_zhang) <- groups_zhang

# Create group list with metadata for Tao, Christopher, and Lyu
groupList_tao <- lapply(1:length(groups_tao), function(i) {
  list(
    name = groups_tao[i],
    samples = samples_tao[metadata_tao[, groupingVariable] == groups_tao[i]],
    color = random_colors[i]
  )
})
names(groupList_tao) <- groups_tao

groupList_christopher <- lapply(1:length(groups_christopher), function(i) {
  list(
    name = groups_christopher[i],
    samples = samples_christopher[metadata_christopher[, groupingVariable] == groups_christopher[i]],
    color = random_colors[i]
  )
})
names(groupList_christopher) <- groups_christopher

groupList_lyu <- lapply(1:length(groups_lyu), function(i) {
  list(
    name = groups_lyu[i],
    samples = samples_lyu[metadata_lyu[, groupingVariable] == groups_lyu[i]],
    color = random_colors[i]
  )
})
names(groupList_lyu) <- groups_lyu


```

```{r groups_auxiliary}
# Define groups
groupA    <- "Myoblasts"
groupB    <- "Myotubes"
groupA_tao<-"0_days"
groupB_tao<-"7_days"
# Define samples inside each group
# Zhang
samplesA_zhang    <- groupList_zhang[[groupA]]$samples
samplesB_zhang    <- groupList_zhang[[groupB]]$samples
colsGroupA_zhang    <- convertCols(zhang_exons$PSI, samplesA_zhang)
colsGroupB_zhang    <- convertCols(zhang_exons$PSI, samplesB_zhang)

# For Tao
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_exons$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_exons$PSI, samplesB_tao)

# For Christopher
samplesA_christopher <- groupList_christopher[[groupA]]$samples
samplesB_christopher <- groupList_christopher[[groupB]]$samples
colsGroupA_christopher <- convertCols(christopher_exons$PSI, samplesA_christopher)
colsGroupB_christopher <- convertCols(christopher_exons$PSI, samplesB_christopher)

# For Lyu
samplesA_lyu <- groupList_lyu[[groupA]]$samples
samplesB_lyu <- groupList_lyu[[groupB]]$samples
colsGroupA_lyu <- convertCols(lyu_exons$PSI, samplesA_lyu)
colsGroupB_lyu <- convertCols(lyu_exons$PSI, samplesB_lyu)


set.seed(42) #Setting seed for downstream simulations of the beta distribution
```

## Exon Lists

### Calculations

```{r pdiff calculation}
# Preprae table for zhang
zhang_pdiff_exons <- prepareTableVolcano(
  psitable = zhang_exons$PSI,
  qualtable = zhang_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_zhang,
  colsB = colsGroupB_zhang,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed=TRUE, 
  CoverageWeight = FALSE)

# Prepare table for Tao
tao_pdiff_exons <- prepareTableVolcano(
  psitable = tao_exons$PSI,
  qualtable = tao_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Christopher
christopher_pdiff_exons <- prepareTableVolcano(
  psitable = christopher_exons$PSI,
  qualtable = christopher_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_christopher,
  colsB = colsGroupB_christopher,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Lyu
lyu_pdiff_exons <- prepareTableVolcano(
  psitable = lyu_exons$PSI,
  qualtable = lyu_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_lyu,
  colsB = colsGroupB_lyu,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

```

```{r f-stat}
# Preprae table for zhang
zhang_fstat_exons <- prepareTableVolcanoFstat(
  psitable = zhang_exons$PSI,
  qualtable = zhang_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_zhang,
  colsB = colsGroupB_zhang,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed=TRUE, 
  CoverageWeight = FALSE)

# Prepare table for Tao
tao_fstat_exons <- prepareTableVolcanoFstat(
  psitable = tao_exons$PSI,
  qualtable = tao_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Christopher
christopher_fstat_exons <- prepareTableVolcanoFstat(
  psitable = christopher_exons$PSI,
  qualtable = christopher_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_christopher,
  colsB = colsGroupB_christopher,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Lyu
lyu_fstat_exons <- prepareTableVolcanoFstat(
  psitable = lyu_exons$PSI,
  qualtable = lyu_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_lyu,
  colsB = colsGroupB_lyu,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

```

```{r FDR}
# Preprae table for zhang
zhang_fdr_exons <- prepareTableVolcanoFDR(
  psitable = zhang_exons$PSI,
  qualtable = zhang_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_zhang,
  colsB = colsGroupB_zhang,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100, 
  seed=TRUE, 
  CoverageWeight = FALSE) 

# Prepare table for Tao
tao_fdr_exons <- prepareTableVolcanoFDR(
  psitable = tao_exons$PSI,
  qualtable = tao_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Christopher
christopher_fdr_exons <- prepareTableVolcanoFDR(
  psitable = christopher_exons$PSI,
  qualtable = christopher_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_christopher,
  colsB = colsGroupB_christopher,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100,
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Lyu
lyu_fdr_exons <- prepareTableVolcanoFDR(
  psitable = lyu_exons$PSI,
  qualtable = lyu_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_lyu,
  colsB = colsGroupB_lyu,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  nsim = 100,
  seed = TRUE, 
  CoverageWeight = FALSE
)

```

### FDR Volcano Plots { .tabset}

#### Zhang

```{r zhang fdr volcano}
plotVolcanoFDR(betasTable =filter(zhang_fdr_exons,!is.na(EVENT)),
                            labA = groupA,
                            labB = groupB,
                            basalColor = "#89C0AE",
                            interestColor = "#E69A9C") 
```

#### Lyu

```{r lyu fdr volcano}
plotVolcanoFDR(betasTable =filter(lyu_fdr_exons,!is.na(EVENT)),
                            labA = groupA,
                            labB = groupB,
                            basalColor = "#89C0AE",
                            interestColor = "#E69A9C") 
```

#### Tao

```{r tao fdr volcano}
plotVolcanoFDR(betasTable =filter(tao_fdr_exons,!is.na(EVENT)),
                            labA = groupA_tao,
                            labB = groupB_tao,
                            basalColor = "#89C0AE",
                            interestColor = "#E69A9C") 
```

#### Christopher

```{r christopher fdr volcano}
plotVolcanoFDR(betasTable =filter(christopher_fdr_exons,!is.na(EVENT)),
                            labA = groupA,
                            labB = groupB,
                            basalColor = "#89C0AE",
                            interestColor = "#E69A9C") 
```

### Individual Combination Tables { .tabset}

#### Zhang

```{r zhang table making}
zhang_pdiff_exons_tab <- zhang_pdiff_exons[, c("GENE", "EVENT", "COORD", "Pdiff", "deltapsi")] %>%
  filter(!is.na(EVENT), Pdiff >= 0.95) %>%  # Remove rows where EVENT is NA and Pdiff >= 0.95
  arrange(desc(Pdiff), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(zhang_pdiff_exons_tab) <- 1:nrow(zhang_pdiff_exons_tab)

zhang_fstat_exons_tab <- zhang_fstat_exons[, c("GENE","EVENT","COORD","Fstat","deltapsi")] %>%
  filter(!is.na(EVENT)) %>%  # Remove rows where EVENT is NA
  arrange(desc(Fstat), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(zhang_fstat_exons_tab) <- 1:nrow(zhang_fstat_exons_tab)

zhang_fdr_exons_tab <- zhang_fdr_exons[, c("GENE","EVENT","COORD","FDR","deltapsi")] %>%
  ilter(!is.na(EVENT), FDR<=0.05) %>%  # Remove rows where EVENT is NA
  arrange((FDR), desc(abs(deltapsi)))
rownames(zhang_fdr_exons_tab) <- 1:nrow(zhang_fdr_exons_tab)

# Find common EVENTs across all tables
common_events <- Reduce(intersect, list(zhang_pdiff_exons_tab$EVENT, zhang_fstat_exons_tab$EVENT, zhang_fdr_exons_tab$EVENT))

# Filter each table to include only rows with common EVENTs
filtered_exon_diff_tab <- zhang_pdiff_exons_tab %>% filter(EVENT %in% common_events)
filtered_exon_fstat_tab <- zhang_fstat_exons_tab %>% filter(EVENT %in% common_events)
filtered_exon_fdr_tab <- zhang_fdr_exons_tab %>% filter(EVENT %in% common_events)


# Select only unique columns from each table
filtered_exon_diff_tab <- filtered_exon_diff_tab %>% select(GENE,EVENT,COORD, deltapsi,Pdiff) # Extra column is Pdiff
filtered_exon_fstat_tab <- filtered_exon_fstat_tab %>% select(EVENT, Fstat) # Extra column is Fstat
filtered_exon_fdr_tab <- filtered_exon_fdr_tab %>% select(EVENT, FDR) # Extra column is FDR

# Merge the data frames by EVENT
zhang_exon_combination_tab <- filtered_exon_diff_tab %>%
  inner_join(filtered_exon_fstat_tab, by = "EVENT") %>%
  inner_join(filtered_exon_fdr_tab, by = "EVENT") %>%
  distinct() %>%
  arrange(desc(abs(deltapsi)), desc(Fstat),desc(FDR), desc(Pdiff))
```

```{r zhang combination table}
# Render DataTable with enhancements
datatable(
  exon_diff_tab,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

output_dir <- file.path(getwd(), "results", "tables")
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
write.csv(exon_combination_tab, 
          file = file.path(output_dir, paste0("zhang_exon_combination_table_", format(Sys.Date(), "%Y%m%d"), ".csv")),
          row.names = FALSE)
```









