---
title: 'Force-based regulation of splicing during Myoblast differentiation'
subtitle: "Stage 1: Bioinformatical Analysis of Myogenic Transcripts"
author: "Andrés Gordo Ortiz @Al Jord Lab CRG"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    code_folding: hide
    code_download: false  
    df_print: paged
    theme: flatly
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    number_sections: true

editor_options: 
  markdown: 
    wrap: 72

# NOTE: To run this R Markdown file correctly, set the Knit Directory to the Project Directory.
# You can do this by navigating to the gear icon next to the Knit button in RStudio,
# and selecting "Project Directory" as the option. This ensures paths resolve correctly. Also, to download libraries in the same version as mine, you can use the following code:
# install.packages("renv")
# renv::init()
# renv::restore()

header-includes:
  - '<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">'
  - '<style>
        #logos {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        #logos img {
            height: 80px;
            margin: 0 15px;
        }
     </style>'


---


```{css, echo=FALSE}
/* Custom CSS for styling */
body {
  font-family: 'Roboto', sans-serif; /* Body font */
  color: #333; /* Neutral dark gray for body text */
}

h1, h2, h3, h4, h5, h6 {
  font-family: 'Roboto', sans-serif; /* Headers font */
  font-weight: bold;
}

/* Header Colors */
h1 {
  font-size: 2.5em;
  color: #0099CD; /* Primary blue for main headers */
}

h2 {
  font-size: 2em;
  color: #0077A3; /* Slightly darker shade of blue for secondary headers */
}

h3 {
  font-size: 1.75em;
  color: #005F8C; /* Even darker blue for tertiary headers */
}

p {
  text-align: justify;
  line-height: 1.6; /* Improve readability */
}

/* Styling for subtitle, authors, and date */
.subtitle, .author, .date {
  color: #000; /* Black text */
  font-size: 1.25em; /* Slightly larger for emphasis */
  margin-bottom: 0.5em;
  text-align: center; /* Center alignment for clean layout */
}

/* Link styling */
a {
  color: #0099CD; /* Link color */
  text-decoration: none;
}

a:hover {
  color: #005F8C; /* Darker shade on hover */
  text-decoration: underline;
}

/* Table styling */
table {
  border-collapse: collapse;
  width: 100%;
}

table th, table td {
  border: 1px solid #ddd;
  padding: 10px;
}

table th {
  background-color: #0099CD; /* Header background blue */
  color: white; /* White text for contrast */
  text-align: center;
}

table tr:nth-child(even) {
  background-color: #f9f9f9; /* Light gray for even rows */
}

table tr:hover {
  background-color: #f1f1f1; /* Subtle highlight on hover */
}
```



```{r setup, include=FALSE}
# Ensure a clean environment and load required libraries.
knitr::opts_chunk$set(
  echo = TRUE, 
  warning = FALSE, 
  message = FALSE
)

# Function to install and load packages dynamically.
install_load <- function(pkg) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg, dependencies = TRUE)
    library(pkg, character.only = TRUE)
  }
}

# Load required libraries
install_load("betAS")
install_load("ggplot2")
install_load("plotly")
install_load("dplyr")
install_load("tidyverse")
install_load("cowplot")
install_load("DT")
install_load("paletteer")
install_load("paletteer")
install_load("ggupset")
install_load("showtext")
install_load("ggtext")
library("patchwork")
library("org.Mm.eg.db")
library("enrichplot")
library("DOSE")
library("clusterProfiler")
library("ReactomePA")
# Register Google fonts
showtext_auto()
font_add_google("Roboto", "roboto")
font="roboto"
```

# Introduction to this Analysis

## Objective

The primary aim is to identify a list of splicing events that meet the following criteria:
1. **Differential Splicing**: Events are differentially spliced during myoblast differentiation.
2. **Spatial Relevance**: Events occur near or around nuclear speckles.

This analysis is structured into four distinct parts, each focusing on a critical step towards achieving the final goal.

---

## **Part 1: Upstream Analysis**

The upstream analysis is performed on the CRG cluster using the Bash command line. This phase involves:

1. **Data Acquisition**: 
   - Downloading `*.fastq.gz` files from five different databases.

2. **Alignment**: 
   - Aligning the sequences to the latest mouse genome release (mm10) using **Bowtie2** through the [Vast-Tools align function](https://link.springer.com/protocol/10.1007/978-1-0716-2521-7_7).

3. **Event Detection**:
   - Importing inclusion tables generated by Vast-Tools into RStudio. The tables cover the following splicing events:
     - **Exons (EX)**
     - **Introns (IN)**
     - **Alternative 5' Splice Sites (Alt5)**
     - **Alternative 3' Splice Sites (Alt3)**
     - **Microexons (MIC)**

---

## **Part 2: Statistical Analysis**

### Objective
To identify splicing events that are differentially spliced during myoblast differentiation.

### Steps

1. **Statistical Testing**: 
   - Use the [betAS package](https://rnajournal.cshlp.org/content/30/4/337) in R to perform:
     - **False Discovery Rate (FDR)**
     - **F-statistic**
     - **Probability of Differential Splicing (Pdiff)**

2. **Filtering Criteria**:
   - Retain events with:
     - **FDR ≤ 0.05**
     - **Pdiff ≥ 0.95**

3. **Batch Effect Mitigation**:
   - Each database is analyzed independently to control for batch effects and confounders.
   - A final list is generated by intersecting the splicing events identified in all five databases. This ensures the events are associated exclusively with differentiation. All exon related events (C1,C2,C3,S,including microexons) will be collapsed into a single list, EX. Alternative donor or acceptor sites are not taking into account for the list, as their junction will be harder to assess using RNA-FISH.

4. **Integration of Results**:
   - 12 lists (6 for exons and 6 for introns) are generated
   - Shared events across lists are conserved and ranked by:
     - **F-statistic**
     - **ΔPSI (Differential Percentage Spliced In)**

5. **Candidate Selection**:
   - The top 20 ranked events are selected for downstream analysis.

---

## **Part 3: Sequence Feature Analysis**

### Objective
To characterize the sequence features of candidate events using computational tools.

### Steps

1. **Feature Extraction**:
   - Run analysis on the CRG cluster using [Matt](https://academic.oup.com/bioinformatics/article/35/1/130/5053311) to extract:
     - **CG content**
     - **Sequence length**
     - **5'/3' splice site scores**

2. **Data Integration**:
   - Return the processed dataset to R for subsequent analysis.

---

## **Part 4: Functional Annotation and Scoring**

### Objective
To determine the functional relevance of candidate splicing events in myoblast differentiation and their spatial association with nuclear speckles.

### Steps

1. **Gene Ontology and Literature Mining**:
   - Use gene ontology tools and literature review to:
     - Assess the functional role of genes.
     - Identify associations with myoblast differentiation and nuclear speckles.

2. **Scoring System**:
   - Develop a scoring framework to rank transcripts based on:
     - Functional relevance
     - Sequence features
     - Spatial proximity to nuclear speckles

---

## Data Availability

| Name              | Publisher                             | ENA Link  | Year | Study Specs                                                                                                                                                                                           | Details                                                 |
|-------------------|---------------------------------------|-----------|------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|
| Kuo Zhang         | Nature Communications                 | [SRP160431](https://www.ebi.ac.uk/ena/browser/view/SRP160431) | 2018 | Reads from knock-down and shControl cells in myoblast and myotube stages. Controls include 3 paired-end biological replicates each for myoblast and myotubes, totaling 12 fastq files.                | ~30M per biosample                                      |
| Lingjian Tao      | Molecular Biotechnology               | [SRP496253](https://www.ebi.ac.uk/ena/browser/view/SRP496253) | 2024 | Myotube formation observed after 4 days, full maturation at 7 days. 3 paired-end biological replicates per condition across 4 timepoints (0, 2, 4, 7 days), totaling 24 fastq files.                  | ~44M per biosample                                      |
| Pengcheng Lyu     | MDPI Cells (data quality verified)    | [SRP335878](https://www.ebi.ac.uk/ena/browser/view/SRP335878) | 2022 | C2C12 cells differentiated in media, with autophagy inhibition using chloroquine (10 µM or 20 µM). 2 paired-end biological replicates per condition for myoblast and myotube stages, 8 fastq files.   | ~45M per biosample                                      |
| Dominic W. Kolonay | Frontiers in Cell and Developmental Biology | [SRP471123](https://www.ebi.ac.uk/ena/browser/view/SRP471123) | 2024 | Myoblasts differentiated to myotubes in DMEM with horse serum and antibiotics over 5 days. 3 paired-end biological replicates per condition (0 days myoblast, 5 days myotube), totaling 12 fastq files. | ~90M per biosample in myotubes, ~140M per biosample in myoblasts |
| Christopher Azar  | Physiological Reports                 | [SRP198848](https://www.ebi.ac.uk/ena/browser/view/SRP198848) | 2021 | Cells differentiated for 6 days with daily media changes. 3 single-end biological replicates per condition (0 days myoblast, 6 days myotube), totaling 6 fastq files.                                 | ~30M per biosample

---

## Importing Inclusion Data

```{r inclusion tables}
# Zhang et al. 2018 data
zhang_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/Zhang_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
zhang_events <- getEvents(zhang_data, tool = "vast-tools") # Extract alternative splicing events
zhang_events <- alternativeEvents(zhang_events, minPsi = 1, maxPsi = 99) # Filter events based on PSI thresholds
zhang_exons <- filterEvents(zhang_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 3)
zhang_introns <- filterEvents(zhang_events, types = c("IR"), N = 5)

# Lyu et al. 2022 data
lyu_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/Lyu_Cells_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
lyu_events <- getEvents(lyu_data, tool = "vast-tools") # Extract alternative splicing events
lyu_events <- alternativeEvents(lyu_events, minPsi = 1, maxPsi = 99) # Filter events based on PSI thresholds
lyu_exons <- filterEvents(lyu_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 3)
lyu_introns <- filterEvents(lyu_events, types = c("IR"), N = 5)

# Tao et al. 2024 data
tao_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/Tao_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
tao_events <- getEvents(tao_data, tool = "vast-tools") # Extract alternative splicing events
tao_events <- alternativeEvents(tao_events, minPsi = 1, maxPsi = 99) # Filter events based on PSI thresholds
tao_exons <- filterEvents(tao_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 3)
tao_introns <- filterEvents(tao_events, types = c("IR"), N = 5)

# Christopher Azar 2021 data
christopher_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/Christopher_Physioreports_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
christopher_events <- getEvents(christopher_data, tool = "vast-tools") # Extract alternative splicing events
christopher_events <- alternativeEvents(christopher_events, minPsi = 1, maxPsi = 99) # Filter events based on PSI thresholds
christopher_exons <- filterEvents(christopher_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 3)
christopher_introns <- filterEvents(christopher_events, types = c("IR"), N = 5)


# Dominic Data
dominic_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/Dominic_Frontiers_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
dominic_events <- getEvents(dominic_data, tool = "vast-tools") # Extract alternative splicing events
dominic_events <- alternativeEvents(dominic_events, minPsi = 1, maxPsi = 99) # Filter events based on PSI thresholds
dominic_exons <- filterEvents(dominic_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 3)
dominic_introns <- filterEvents(dominic_events, types = c("IR"), N = 5)
```


## Metadata { .tabset}

### Zhang

```{r metadata zhang}
# Load metadata file containing sample information
metadata_zhang <- read.csv(paste0(getwd(),"/metadata/zhang_metadata.csv"), sep = ",")
DT::datatable(metadata_zhang, options = list(pageLength = nrow(metadata_zhang), scrollX = TRUE))
```

### Lyu

```{r metadata lyu}
# Load metadata file containing sample information
metadata_lyu <- read.csv(paste0(getwd(),"/metadata/lyu_metadata.csv"), sep = ",")
DT::datatable(metadata_lyu, options = list(pageLength = nrow(metadata_lyu), scrollX = TRUE))
```
### Tao

```{r metadata tao}
# Load metadata file containing sample information
metadata_tao <- read.csv(paste0(getwd(),"/metadata/tao_metadata.csv"), sep = ",")
DT::datatable(metadata_tao, options = list(pageLength = nrow(metadata_tao), scrollX = TRUE))
```

### Christopher

```{r metadata christopher}
# Load metadata file containing sample information
metadata_christopher <- read.csv(paste0(getwd(),"/metadata/christopher_metadata.csv"), sep = ",")
DT::datatable(metadata_christopher, options = list(pageLength = nrow(metadata_christopher), scrollX = TRUE))
```

### Dominic

```{r metadata dominic}
# Load metadata file containing sample information
metadata_dominic <- read.csv(paste0(getwd(),"/metadata/dominic_metadata.csv"), sep = ",")
DT::datatable(metadata_dominic, options = list(pageLength = nrow(metadata_dominic), scrollX = TRUE))
```


---

# Splicing & Sample Quality Checking

## PSI Distribution Plots { .tabset}

### Zhang

```{r psi distribution zhang}
# Create the first plot for exon inclusion levels
bigPicturePlotExons <- bigPicturePlot(table = zhang_exons$PSI)

# Customize the first plot for professional reporting
plot1 <- bigPicturePlotExons +
  ggtitle("Exon Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Create a second plot for a hypothetical dataframe
# Replace 'hypothetical_data$PSI' with your actual dataframe and column
bigPictureIntrons <- bigPicturePlot(table = zhang_introns$PSI)

# Customize the second plot
plot2 <- bigPictureIntrons +
  ggtitle("Introns Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Combine both plots into one figure using patchwork
plot1 / plot2
```

### Lyu

```{r lyu distribution plot}
# Create the first plot for exon inclusion levels
bigPicturePlotExons <- bigPicturePlot(table = lyu_exons$PSI)

# Customize the first plot for professional reporting
plot1 <- bigPicturePlotExons +
  ggtitle("Exon Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Create a second plot for a hypothetical dataframe
# Replace 'hypothetical_data$PSI' with your actual dataframe and column
bigPictureIntrons <- bigPicturePlot(table = lyu_introns$PSI)

# Customize the second plot
plot2 <- bigPictureIntrons +
  ggtitle("Introns Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Combine both plots into one figure using patchwork
plot1 / plot2
```

### Tao

```{r tao distri plots}
# Create the first plot for exon inclusion levels
bigPicturePlotExons <- bigPicturePlot(table = tao_exons$PSI)

# Customize the first plot for professional reporting
plot1 <- bigPicturePlotExons +
  ggtitle("Exon Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Create a second plot for a hypothetical dataframe
# Replace 'hypothetical_data$PSI' with your actual dataframe and column
bigPictureIntrons <- bigPicturePlot(table = tao_introns$PSI)

# Customize the second plot
plot2 <- bigPictureIntrons +
  ggtitle("Introns Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Combine both plots into one figure using patchwork
plot1 / plot2
```

### Christopher

```{r christopher distro plots}
# Create the first plot for exon inclusion levels
bigPicturePlotExons <- bigPicturePlot(table = christopher_exons$PSI)

# Customize the first plot for professional reporting
plot1 <- bigPicturePlotExons +
  ggtitle("Exon Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Create a second plot for a hypothetical dataframe
# Replace 'hypothetical_data$PSI' with your actual dataframe and column
bigPictureIntrons <- bigPicturePlot(table = christopher_introns$PSI)

# Customize the second plot
plot2 <- bigPictureIntrons +
  ggtitle("Introns Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Combine both plots into one figure using patchwork
plot1 / plot2
```

### Dominic


```{r dominic distro plots}
# Create the first plot for exon inclusion levels
bigPicturePlotExons <- bigPicturePlot(table = dominic_exons$PSI)

# Customize the first plot for professional reporting
plot1 <- bigPicturePlotExons +
  ggtitle("Exon Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Create a second plot for a hypothetical dataframe
# Replace 'hypothetical_data$PSI' with your actual dataframe and column
bigPictureIntrons <- bigPicturePlot(table = dominic_introns$PSI)

# Customize the second plot
plot2 <- bigPictureIntrons +
  ggtitle("Introns Inclusion Levels") +
  xlab("Samples") +
  ylab("PSI Values") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.25)
  )

# Combine both plots into one figure using patchwork
plot1 / plot2 
```

## PCA Plot

```{r pca calculation}
# Subset and scale data
pca_zhang <- zhang_data[, c("EVENT",zhang_events$Samples)]
pca_tao <- tao_data[,  c("EVENT",tao_events$Samples)]
pca_lyu <- lyu_data[,  c("EVENT",lyu_events$Samples)]
pca_christopher <- christopher_data[,  c("EVENT",christopher_events$Samples)]
pca_dominic <- dominic_data[,  c("EVENT",dominic_events$Samples)]

# merge pca data columns by row names
merged_pca <- pca_zhang %>%
  left_join(pca_tao, by = "EVENT") %>%
  left_join(pca_lyu, by = "EVENT") %>%
  left_join(pca_christopher, by="EVENT") %>%
  left_join(pca_dominic, by="EVENT") %>%
  na.omit()
rownames(merged_pca)<- merged_pca$EVENT
merged_pca<-t(merged_pca[,-1])

metadata_merged<-tibble(sample=c(metadata_zhang$run_accession,metadata_tao$run_accession,metadata_lyu$run_accession,metadata_christopher$run_accession,metadata_dominic$run_accession),experiment_title=c(metadata_zhang$experiment_title,metadata_tao$experiment_title,metadata_lyu$experiment_title,metadata_christopher$experiment_title,metadata_dominic$experiment_title))

# Reorder metadata_merged$experiment_title based on the row names of merged_pca
condition_pca <- metadata_merged$experiment_title[match(rownames(merged_pca), metadata_merged$sample)]


pca_result <- prcomp(merged_pca)  # Perform PCA

# Prepare PCA results for plotting
pca_data <- as.data.frame(pca_result$x)
pca_data$Sample <- rownames(pca_data)
pca_data$condition<-condition_pca
pca_data$data_origin<-c(rep("Zhang",ncol(pca_zhang)-1),rep("Tao",ncol(pca_tao)-1),rep("Lyu",ncol(pca_lyu)-1),rep("Christopher",ncol(pca_christopher)-1),rep("Dominic",ncol(pca_dominic)-1))
```

```{r pca plotting}
# Create PCA plot
pca_plot <- ggplot(pca_data, aes(x = PC1, y = PC2, color = as.factor(condition), shape = as.factor(data_origin))) +
  geom_point(size = 6) +
  labs(
    title = "<b style='font-size:18px;'>PCA of Samples (PSI Data)</b>",
    x = paste("PC1 (", round(100 * summary(pca_result)$importance[2, 1], 1), "%)", sep = ""),
    y = paste("PC2 (", round(100 * summary(pca_result)$importance[2, 2], 1), "%)", sep = "")
  ) +
  theme_minimal(base_family = "roboto") +
  theme(
    plot.title = element_markdown(),
    plot.title.position = "plot",
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.position = "right",
    legend.title = element_blank(),
    panel.background = element_rect(fill = "gray98"),
    panel.grid = element_line(color = "gray90", size = 0.5),
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_blank()
  ) +
  scale_colour_paletteer_d("MetBrewer::Hokusai3") +
  scale_colour_manual(values = rev(paletteer::paletteer_d("MetBrewer::Hokusai3")))
  coord_fixed()

pca_plot

```

## Total Splicing Events

```{r splicing events barplot stacked}

# Adjusted version of the script
splicing_events <- tibble(
  event_type = names(zhang_events$EventsPerType), 
  zhang = zhang_events$EventsPerType, 
  tao = tao_events$EventsPerType, 
  lyu = lyu_events$EventsPerType, 
  christopher = christopher_events$EventsPerType, 
  dominic = dominic_events$EventsPerType
)

splicing_events_long <- splicing_events %>%
  pivot_longer(cols = c(zhang, tao, lyu, christopher, dominic), 
               names_to = "study", values_to = "count") %>%
  mutate(event_type = ifelse(event_type %in% c("C1", "C2", "C3", "ANN", "S", "MIC"), "EX", event_type)) %>%
  group_by(study, event_type) %>%
  summarize(count = sum(count, na.rm = TRUE), .groups = "drop")

# Proportion bar plot
plot_proportion <- ggplot(splicing_events_long, aes(fill = event_type, y = count, x = study)) + 
  geom_bar(position = "fill", stat = "identity") +
  labs(
    title = "<b style='font-size:18px;'>Proportion of Splicing Events by Study</b>",
    x = NULL,
    y = "Proportion of Events",
    fill = "Event Type"
  ) +
  theme_minimal(base_family = font) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    plot.title = element_markdown(),
    panel.background = element_rect(fill = "gray98"),
    panel.grid = element_line(color = "gray90", size = 0.5)
  ) +
  scale_fill_paletteer_d("MetBrewer::Hokusai3")

# Absolute counts plot
plot_absolute <- ggplot(splicing_events_long, aes(y = count, x = study)) + 
  geom_point(color = "#C70039", size = 3) +  # Dots
  geom_line(color = "#FF5733", size = 1) + 
  labs(
    x = "Study",
    y = "Number of Events"
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "none",
    axis.title.x = element_text(margin = margin(t = 10)),
    panel.background = element_rect(fill = "gray98"),
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_blank()
  ) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.2))) + # Extend y-range
  scale_colour_paletteer_d("MetBrewer::Hokusai3")

# Combine plots
combined_plot <- plot_proportion / plot_absolute +
  plot_layout(heights = c(1, 0.5)) & 
  theme(plot.margin = margin(0, 0, 0, 0))

# Display combined plot
combined_plot
```

# Differential Splicing Calculation

```{r aux_featuregroup}
# Extract unique groups and sample IDs
groupingVariable <- "experiment_title"
# Zhang
groups_zhang <- unique(metadata_zhang[, groupingVariable])
samples_zhang <- metadata_zhang$run_accession
# Tao
groups_tao <- unique(metadata_tao[, groupingVariable])
samples_tao <- metadata_tao$run_accession
# Lyu
groups_lyu <- unique(metadata_lyu[, groupingVariable])
samples_lyu <- metadata_lyu$run_accession
# Christopher
groups_christopher <- unique(metadata_christopher[, groupingVariable])
samples_christopher <- metadata_christopher$run_accession
# Dominic
groups_dominic <- unique(metadata_dominic[, groupingVariable])
samples_dominic <- metadata_dominic$run_accession


random_colors=c("#D8D97AFF", "#95C36EFF", "#74C8C3FF", "#5A97C1FF", "#295384FF", "#0A2E57FF")
  
# Create group list with metadata
groupList_zhang <- lapply(1:length(groups_zhang), function(i) {
  list(
    name = groups_zhang[i],
    samples = samples_zhang[metadata_zhang[, groupingVariable] == groups_zhang[i]],
    color = random_colors[i]
  )
})
names(groupList_zhang) <- groups_zhang

# Create group list with metadata for Tao, Christopher, and Lyu
groupList_tao <- lapply(1:length(groups_tao), function(i) {
  list(
    name = groups_tao[i],
    samples = samples_tao[metadata_tao[, groupingVariable] == groups_tao[i]],
    color = random_colors[i]
  )
})
names(groupList_tao) <- groups_tao

groupList_christopher <- lapply(1:length(groups_christopher), function(i) {
  list(
    name = groups_christopher[i],
    samples = samples_christopher[metadata_christopher[, groupingVariable] == groups_christopher[i]],
    color = random_colors[i]
  )
})
names(groupList_christopher) <- groups_christopher

groupList_lyu <- lapply(1:length(groups_lyu), function(i) {
  list(
    name = groups_lyu[i],
    samples = samples_lyu[metadata_lyu[, groupingVariable] == groups_lyu[i]],
    color = random_colors[i]
  )
})
names(groupList_lyu) <- groups_lyu

# Create group list with metadata
groupList_dominic <- lapply(1:length(groups_dominic), function(i) {
  list(
    name = groups_dominic[i],
    samples = samples_dominic[metadata_dominic[, groupingVariable] == groups_dominic[i]],
    color = random_colors[i]
  )
})
names(groupList_dominic) <- groups_dominic
```

```{r groups_auxiliary}
# Define groups
groupA    <- "Myoblasts"
groupB    <- "Myotubes"
groupA_tao<-"0_days"
groupB_tao<-"7_days"

# Define samples inside each group
# Zhang
samplesA_zhang    <- groupList_zhang[[groupA]]$samples
samplesB_zhang    <- groupList_zhang[[groupB]]$samples
colsGroupA_zhang    <- convertCols(zhang_exons$PSI, samplesA_zhang)
colsGroupB_zhang    <- convertCols(zhang_exons$PSI, samplesB_zhang)

# For Tao
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_exons$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_exons$PSI, samplesB_tao)

# For Christopher
samplesA_christopher <- groupList_christopher[[groupA]]$samples
samplesB_christopher <- groupList_christopher[[groupB]]$samples
colsGroupA_christopher <- convertCols(christopher_exons$PSI, samplesA_christopher)
colsGroupB_christopher <- convertCols(christopher_exons$PSI, samplesB_christopher)

# For Lyu
samplesA_lyu <- groupList_lyu[[groupA]]$samples
samplesB_lyu <- groupList_lyu[[groupB]]$samples
colsGroupA_lyu <- convertCols(lyu_exons$PSI, samplesA_lyu)
colsGroupB_lyu <- convertCols(lyu_exons$PSI, samplesB_lyu)

# Dominic
samplesA_dominic    <- groupList_dominic[[groupA]]$samples
samplesB_dominic   <- groupList_dominic[[groupB]]$samples
colsGroupA_dominic   <- convertCols(dominic_exons$PSI, samplesA_dominic)
colsGroupB_dominic    <- convertCols(dominic_exons$PSI, samplesB_dominic)

set.seed(42) #Setting seed for downstream simulations of the beta distribution
```

## Exon Lists

### Calculations

```{r pdiff calculation}
# Preprae table for zhang
zhang_pdiff_exons <- prepareTableVolcano(
  psitable = zhang_exons$PSI,
  qualtable = zhang_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_zhang,
  colsB = colsGroupB_zhang,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed=TRUE, 
  CoverageWeight = FALSE)

# Prepare table for Tao
tao_pdiff_exons <- prepareTableVolcano(
  psitable = tao_exons$PSI,
  qualtable = tao_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Christopher
christopher_pdiff_exons <- prepareTableVolcano(
  psitable = christopher_exons$PSI,
  qualtable = christopher_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_christopher,
  colsB = colsGroupB_christopher,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Lyu
lyu_pdiff_exons <- prepareTableVolcano(
  psitable = lyu_exons$PSI,
  qualtable = lyu_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_lyu,
  colsB = colsGroupB_lyu,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Preprae table for dominic
dominic_pdiff_exons <- prepareTableVolcano(
  psitable = dominic_exons$PSI,
  qualtable = dominic_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_dominic,
  colsB = colsGroupB_dominic,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed=TRUE, 
  CoverageWeight = FALSE)
```

```{r f-stat}
# Preprae table for zhang
zhang_fstat_exons <- prepareTableVolcanoFstat(
  psitable = zhang_exons$PSI,
  qualtable = zhang_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_zhang,
  colsB = colsGroupB_zhang,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed=TRUE, 
  CoverageWeight = FALSE)

# Prepare table for Tao
tao_fstat_exons <- prepareTableVolcanoFstat(
  psitable = tao_exons$PSI,
  qualtable = tao_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Christopher
christopher_fstat_exons <- prepareTableVolcanoFstat(
  psitable = christopher_exons$PSI,
  qualtable = christopher_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_christopher,
  colsB = colsGroupB_christopher,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Lyu
lyu_fstat_exons <- prepareTableVolcanoFstat(
  psitable = lyu_exons$PSI,
  qualtable = lyu_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_lyu,
  colsB = colsGroupB_lyu,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Preprae table for dominic
dominic_fstat_exons <- prepareTableVolcanoFstat(
  psitable = dominic_exons$PSI,
  qualtable = dominic_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_dominic,
  colsB = colsGroupB_dominic,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed=TRUE, 
  CoverageWeight = FALSE)
```

```{r FDR calculations}
# Preprae table for zhang
zhang_fdr_exons <- prepareTableVolcanoFDR(
  psitable = zhang_exons$PSI,
  qualtable = zhang_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_zhang,
  colsB = colsGroupB_zhang,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100, 
  seed=TRUE, 
  CoverageWeight = FALSE) 

# Prepare table for Tao
tao_fdr_exons <- prepareTableVolcanoFDR(
  psitable = tao_exons$PSI,
  qualtable = tao_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Christopher
christopher_fdr_exons <- prepareTableVolcanoFDR(
  psitable = christopher_exons$PSI,
  qualtable = christopher_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_christopher,
  colsB = colsGroupB_christopher,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100,
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Lyu
lyu_fdr_exons <- prepareTableVolcanoFDR(
  psitable = lyu_exons$PSI,
  qualtable = lyu_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_lyu,
  colsB = colsGroupB_lyu,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  nsim = 100,
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Preprae table for dominic
dominic_fdr_exons <- prepareTableVolcanoFDR(
  psitable = dominic_exons$PSI,
  qualtable = dominic_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_dominic,
  colsB = colsGroupB_dominic,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100, 
  seed=TRUE, 
  CoverageWeight = FALSE) 
```



### FDR Volcano Plots { .tabset}

#### Zhang

```{r zhang fdr volcano}
plotVolcanoFDR(betasTable =filter(zhang_fdr_exons,!is.na(EVENT)),
                            labA = groupA,
                            labB = groupB,
                            basalColor = "#89C0AE",
                            interestColor = "#E69A9C") +
  
theme(
  plot.title = element_text(size = 10),  # Title font size
  axis.title = element_text(size = 10),  # Axis title font size
  axis.text = element_text(size = 10),   # Axis text font size
  legend.text = element_text(size = 10), # Legend text font size
  legend.title = element_text(size = 10) # Legend title font size
)
```

#### Lyu

```{r lyu fdr volcano}
plotVolcanoFDR(betasTable =filter(lyu_fdr_exons,!is.na(EVENT)),
                            labA = groupA,
                            labB = groupB,
                            basalColor = "#89C0AE",
                            interestColor = "#E69A9C") +
theme(
  plot.title = element_text(size = 10),  # Title font size
  axis.title = element_text(size = 10),  # Axis title font size
  axis.text = element_text(size = 10),   # Axis text font size
  legend.text = element_text(size = 10), # Legend text font size
  legend.title = element_text(size = 10) # Legend title font size
)
```

#### Tao

```{r tao fdr volcano}
plotVolcanoFDR(betasTable =filter(tao_fdr_exons,!is.na(EVENT)),
                            labA = groupA_tao,
                            labB = groupB_tao,
                            basalColor = "#89C0AE",
                            interestColor = "#E69A9C") +
theme(
  plot.title = element_text(size = 10),  # Title font size
  axis.title = element_text(size = 10),  # Axis title font size
  axis.text = element_text(size = 10),   # Axis text font size
  legend.text = element_text(size = 10), # Legend text font size
  legend.title = element_text(size = 10) # Legend title font size
)
```

#### Christopher

```{r christopher fdr volcano}
plotVolcanoFDR(betasTable =filter(christopher_fdr_exons,!is.na(EVENT)),
                            labA = groupA,
                            labB = groupB,
                            basalColor = "#89C0AE",
                            interestColor = "#E69A9C") +
theme(
  plot.title = element_text(size = 10),  # Title font size
  axis.title = element_text(size = 10),  # Axis title font size
  axis.text = element_text(size = 10),   # Axis text font size
  legend.text = element_text(size = 10), # Legend text font size
  legend.title = element_text(size = 10) # Legend title font size
)
```

#### Dominic

```{r dominic fdr volcano}
plotVolcanoFDR(betasTable =filter(dominic_fdr_exons,!is.na(EVENT)),
                            labA = groupA,
                            labB = groupB,
                            basalColor = "#89C0AE",
                            interestColor = "#E69A9C") +
theme(
  plot.title = element_text(size = 10),  # Title font size
  axis.title = element_text(size = 10),  # Axis title font size
  axis.text = element_text(size = 10),   # Axis text font size
  legend.text = element_text(size = 10), # Legend text font size
  legend.title = element_text(size = 10) # Legend title font size
)
```

### Individual Combination Tables { .tabset}

#### Zhang

```{r zhang table making}
zhang_pdiff_exons_tab <- zhang_pdiff_exons[, c("GENE", "EVENT", "COORD", "Pdiff", "deltapsi")] %>%
  filter(!is.na(EVENT), Pdiff >= 0.95) %>%  # Remove rows where EVENT is NA and Pdiff >= 0.95
  arrange(desc(Pdiff), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(zhang_pdiff_exons_tab) <- 1:nrow(zhang_pdiff_exons_tab)

zhang_fstat_exons_tab <- zhang_fstat_exons[, c("GENE","EVENT","COORD","Fstat","deltapsi")] %>%
  filter(!is.na(EVENT)) %>%  # Remove rows where EVENT is NA
  arrange(desc(Fstat), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(zhang_fstat_exons_tab) <- 1:nrow(zhang_fstat_exons_tab)

zhang_fdr_exons_tab <- zhang_fdr_exons[, c("GENE","EVENT","COORD","FDR","deltapsi")] %>%
  filter(!is.na(EVENT), FDR<=0.05) %>%  # Remove rows where EVENT is NA
  arrange((FDR), desc(abs(deltapsi)))
rownames(zhang_fdr_exons_tab) <- 1:nrow(zhang_fdr_exons_tab)

# Find common EVENTs across all tables
common_events <- Reduce(intersect, list(zhang_pdiff_exons_tab$EVENT, zhang_fstat_exons_tab$EVENT, zhang_fdr_exons_tab$EVENT))

# Filter each table to include only rows with common EVENTs
filtered_exon_diff_tab <- zhang_pdiff_exons_tab %>% filter(EVENT %in% common_events)
filtered_exon_fstat_tab <- zhang_fstat_exons_tab %>% filter(EVENT %in% common_events)
filtered_exon_fdr_tab <- zhang_fdr_exons_tab %>% filter(EVENT %in% common_events)


# Select only unique columns from each table
filtered_exon_diff_tab <- filtered_exon_diff_tab %>% select(GENE,EVENT,COORD, deltapsi,Pdiff) # Extra column is Pdiff
filtered_exon_fstat_tab <- filtered_exon_fstat_tab %>% select(EVENT, Fstat) # Extra column is Fstat
filtered_exon_fdr_tab <- filtered_exon_fdr_tab %>% select(EVENT, FDR) # Extra column is FDR

# Merge the data frames by EVENT
zhang_exon_combination_tab <- filtered_exon_diff_tab %>%
  inner_join(filtered_exon_fstat_tab, by = "EVENT") %>%
  inner_join(filtered_exon_fdr_tab, by = "EVENT") %>%
  distinct() %>%
  arrange(desc(abs(deltapsi)), desc(Fstat),desc(FDR), desc(Pdiff))
```

```{r zhang combination table}
# Render DataTable with enhancements
datatable(
  zhang_exon_combination_tab,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

output_dir <- file.path(getwd(), "results", "tables")
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
write.csv(zhang_exon_combination_tab, 
          file = file.path(output_dir, paste0("zhang_exon_combination_table_", format(Sys.Date(), "%Y%m%d"), ".csv")),
          row.names = FALSE)
```

#### Lyu

```{r lyu table making}
lyu_pdiff_exons_tab <- lyu_pdiff_exons[, c("GENE", "EVENT", "COORD", "Pdiff", "deltapsi")] %>%
  filter(!is.na(EVENT), Pdiff >= 0.95) %>%  # Remove rows where EVENT is NA and Pdiff >= 0.95
  arrange(desc(Pdiff), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(lyu_pdiff_exons_tab) <- 1:nrow(lyu_pdiff_exons_tab)

lyu_fstat_exons_tab <- lyu_fstat_exons[, c("GENE","EVENT","COORD","Fstat","deltapsi")] %>%
  filter(!is.na(EVENT)) %>%  # Remove rows where EVENT is NA
  arrange(desc(Fstat), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(lyu_fstat_exons_tab) <- 1:nrow(lyu_fstat_exons_tab)

lyu_fdr_exons_tab <- lyu_fdr_exons[, c("GENE","EVENT","COORD","FDR","deltapsi")] %>%
  filter(!is.na(EVENT), FDR<=0.05) %>%  # Remove rows where EVENT is NA
  arrange((FDR), desc(abs(deltapsi)))
rownames(lyu_fdr_exons_tab) <- 1:nrow(lyu_fdr_exons_tab)

# Find common EVENTs across all tables
common_events <- Reduce(intersect, list(lyu_pdiff_exons_tab$EVENT, lyu_fstat_exons_tab$EVENT, lyu_fdr_exons_tab$EVENT))

# Filter each table to include only rows with common EVENTs
filtered_exon_diff_tab <- lyu_pdiff_exons_tab %>% filter(EVENT %in% common_events)
filtered_exon_fstat_tab <- lyu_fstat_exons_tab %>% filter(EVENT %in% common_events)
filtered_exon_fdr_tab <- lyu_fdr_exons_tab %>% filter(EVENT %in% common_events)


# Select only unique columns from each table
filtered_exon_diff_tab <- filtered_exon_diff_tab %>% select(GENE,EVENT,COORD, deltapsi,Pdiff) # Extra column is Pdiff
filtered_exon_fstat_tab <- filtered_exon_fstat_tab %>% select(EVENT, Fstat) # Extra column is Fstat
filtered_exon_fdr_tab <- filtered_exon_fdr_tab %>% select(EVENT, FDR) # Extra column is FDR

# Merge the data frames by EVENT
lyu_exon_combination_tab <- filtered_exon_diff_tab %>%
  inner_join(filtered_exon_fstat_tab, by = "EVENT") %>%
  inner_join(filtered_exon_fdr_tab, by = "EVENT") %>%
  distinct() %>%
  arrange(desc(abs(deltapsi)), desc(Fstat),desc(FDR), desc(Pdiff))
```

```{r lyu combination table}
# Render DataTable with enhancements
datatable(
  lyu_exon_combination_tab,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

write.csv(lyu_exon_combination_tab, 
          file = file.path(output_dir, paste0("lyu_exon_combination_table_", format(Sys.Date(), "%Y%m%d"), ".csv")),
          row.names = FALSE)
```

#### Tao

```{r tao table making}
tao_pdiff_exons_tab <- tao_pdiff_exons[, c("GENE", "EVENT", "COORD", "Pdiff", "deltapsi")] %>%
  filter(!is.na(EVENT), Pdiff >= 0.95) %>%  # Remove rows where EVENT is NA and Pdiff >= 0.95
  arrange(desc(Pdiff), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(tao_pdiff_exons_tab) <- 1:nrow(tao_pdiff_exons_tab)

tao_fstat_exons_tab <- tao_fstat_exons[, c("GENE","EVENT","COORD","Fstat","deltapsi")] %>%
  filter(!is.na(EVENT)) %>%  # Remove rows where EVENT is NA
  arrange(desc(Fstat), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(tao_fstat_exons_tab) <- 1:nrow(tao_fstat_exons_tab)

tao_fdr_exons_tab <- tao_fdr_exons[, c("GENE","EVENT","COORD","FDR","deltapsi")] %>%
  filter(!is.na(EVENT), FDR<=0.05) %>%  # Remove rows where EVENT is NA
  arrange((FDR), desc(abs(deltapsi)))
rownames(tao_fdr_exons_tab) <- 1:nrow(tao_fdr_exons_tab)

# Find common EVENTs across all tables
common_events <- Reduce(intersect, list(tao_pdiff_exons_tab$EVENT, tao_fstat_exons_tab$EVENT, tao_fdr_exons_tab$EVENT))

# Filter each table to include only rows with common EVENTs
filtered_exon_diff_tab <- tao_pdiff_exons_tab %>% filter(EVENT %in% common_events)
filtered_exon_fstat_tab <- tao_fstat_exons_tab %>% filter(EVENT %in% common_events)
filtered_exon_fdr_tab <- tao_fdr_exons_tab %>% filter(EVENT %in% common_events)


# Select only unique columns from each table
filtered_exon_diff_tab <- filtered_exon_diff_tab %>% select(GENE,EVENT,COORD, deltapsi,Pdiff) # Extra column is Pdiff
filtered_exon_fstat_tab <- filtered_exon_fstat_tab %>% select(EVENT, Fstat) # Extra column is Fstat
filtered_exon_fdr_tab <- filtered_exon_fdr_tab %>% select(EVENT, FDR) # Extra column is FDR

# Merge the data frames by EVENT
tao_exon_combination_tab <- filtered_exon_diff_tab %>%
  inner_join(filtered_exon_fstat_tab, by = "EVENT") %>%
  inner_join(filtered_exon_fdr_tab, by = "EVENT") %>%
  distinct() %>%
  arrange(desc(abs(deltapsi)), desc(Fstat),desc(FDR), desc(Pdiff))
```

```{r tao combination table}
# Render DataTable with enhancements
datatable(
  tao_exon_combination_tab,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

write.csv(tao_exon_combination_tab, 
          file = file.path(output_dir, paste0("tao_exon_combination_table_", format(Sys.Date(), "%Y%m%d"), ".csv")),
          row.names = FALSE)
```

#### Dominic

```{r dominic table making}
dominic_pdiff_exons_tab <- dominic_pdiff_exons[, c("GENE", "EVENT", "COORD", "Pdiff", "deltapsi")] %>%
  filter(!is.na(EVENT), Pdiff >= 0.95) %>%  # Remove rows where EVENT is NA and Pdiff >= 0.95
  arrange(desc(Pdiff), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(dominic_pdiff_exons_tab) <- 1:nrow(dominic_pdiff_exons_tab)

dominic_fstat_exons_tab <- dominic_fstat_exons[, c("GENE","EVENT","COORD","Fstat","deltapsi")] %>%
  filter(!is.na(EVENT)) %>%  # Remove rows where EVENT is NA
  arrange(desc(Fstat), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(dominic_fstat_exons_tab) <- 1:nrow(dominic_fstat_exons_tab)

dominic_fdr_exons_tab <- dominic_fdr_exons[, c("GENE","EVENT","COORD","FDR","deltapsi")] %>%
  filter(!is.na(EVENT), FDR<=0.05) %>%  # Remove rows where EVENT is NA
  arrange((FDR), desc(abs(deltapsi)))
rownames(dominic_fdr_exons_tab) <- 1:nrow(dominic_fdr_exons_tab)

# Find common EVENTs across all tables
common_events <- Reduce(intersect, list(dominic_pdiff_exons_tab$EVENT, dominic_fstat_exons_tab$EVENT, dominic_fdr_exons_tab$EVENT))

# Filter each table to include only rows with common EVENTs
filtered_exon_diff_tab <- dominic_pdiff_exons_tab %>% filter(EVENT %in% common_events)
filtered_exon_fstat_tab <- dominic_fstat_exons_tab %>% filter(EVENT %in% common_events)
filtered_exon_fdr_tab <- dominic_fdr_exons_tab %>% filter(EVENT %in% common_events)


# Select only unique columns from each table
filtered_exon_diff_tab <- filtered_exon_diff_tab %>% select(GENE,EVENT,COORD, deltapsi,Pdiff) # Extra column is Pdiff
filtered_exon_fstat_tab <- filtered_exon_fstat_tab %>% select(EVENT, Fstat) # Extra column is Fstat
filtered_exon_fdr_tab <- filtered_exon_fdr_tab %>% select(EVENT, FDR) # Extra column is FDR

# Merge the data frames by EVENT
dominic_exon_combination_tab <- filtered_exon_diff_tab %>%
  inner_join(filtered_exon_fstat_tab, by = "EVENT") %>%
  inner_join(filtered_exon_fdr_tab, by = "EVENT") %>%
  distinct() %>%
  arrange(desc(abs(deltapsi)), desc(Fstat),desc(FDR), desc(Pdiff))
```

```{r dominic combination table}
# Render DataTable with enhancements
datatable(
  dominic_exon_combination_tab,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


write.csv(dominic_exon_combination_tab, 
          file = file.path(output_dir, paste0("dominic_exon_combination_table_", format(Sys.Date(), "%Y%m%d"), ".csv")),
          row.names = FALSE)
```


#### Christopher

```{r christopher table making}
christopher_pdiff_exons_tab <- christopher_pdiff_exons[, c("GENE", "EVENT", "COORD", "Pdiff", "deltapsi")] %>%
  filter(!is.na(EVENT), Pdiff >= 0.95) %>%  # Remove rows where EVENT is NA and Pdiff >= 0.95
  arrange(desc(Pdiff), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(christopher_pdiff_exons_tab) <- 1:nrow(christopher_pdiff_exons_tab)

christopher_fstat_exons_tab <- christopher_fstat_exons[, c("GENE","EVENT","COORD","Fstat","deltapsi")] %>%
  filter(!is.na(EVENT)) %>%  # Remove rows where EVENT is NA
  arrange(desc(Fstat), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(christopher_fstat_exons_tab) <- 1:nrow(christopher_fstat_exons_tab)

christopher_fdr_exons_tab <- christopher_fdr_exons[, c("GENE","EVENT","COORD","FDR","deltapsi")] %>%
  filter(!is.na(EVENT), FDR<=0.05) %>%  # Remove rows where EVENT is NA
  arrange((FDR), desc(abs(deltapsi)))
rownames(christopher_fdr_exons_tab) <- 1:nrow(christopher_fdr_exons_tab)

# Find common EVENTs across all tables
common_events <- Reduce(intersect, list(christopher_pdiff_exons_tab$EVENT, christopher_fstat_exons_tab$EVENT, christopher_fdr_exons_tab$EVENT))

# Filter each table to include only rows with common EVENTs
filtered_exon_diff_tab <- christopher_pdiff_exons_tab %>% filter(EVENT %in% common_events)
filtered_exon_fstat_tab <- christopher_fstat_exons_tab %>% filter(EVENT %in% common_events)
filtered_exon_fdr_tab <- christopher_fdr_exons_tab %>% filter(EVENT %in% common_events)


# Select only unique columns from each table
filtered_exon_diff_tab <- filtered_exon_diff_tab %>% select(GENE,EVENT,COORD, deltapsi,Pdiff) # Extra column is Pdiff
filtered_exon_fstat_tab <- filtered_exon_fstat_tab %>% select(EVENT, Fstat) # Extra column is Fstat
filtered_exon_fdr_tab <- filtered_exon_fdr_tab %>% select(EVENT, FDR) # Extra column is FDR

# Merge the data frames by EVENT
christopher_exon_combination_tab <- filtered_exon_diff_tab %>%
  inner_join(filtered_exon_fstat_tab, by = "EVENT") %>%
  inner_join(filtered_exon_fdr_tab, by = "EVENT") %>%
  distinct() %>%
  arrange(desc(abs(deltapsi)), desc(Fstat),desc(FDR), desc(Pdiff))
```

```{r christopher combination table}
# Render DataTable with enhancements
datatable(
  christopher_exon_combination_tab,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

write.csv(christopher_exon_combination_tab, 
          file = file.path(output_dir, paste0("christopher_exon_combination_table_", format(Sys.Date(), "%Y%m%d"), ".csv")),
          row.names = FALSE)
```



## Intron Lists

### Calculations

```{r pdiff intron calculation}
# Preprae table for zhang
zhang_pdiff_introns <- prepareTableVolcano(
  psitable = zhang_introns$PSI,
  qualtable = zhang_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_zhang,
  colsB = colsGroupB_zhang,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed=TRUE, 
  CoverageWeight = FALSE)

# Prepare table for Tao
tao_pdiff_introns <- prepareTableVolcano(
  psitable = tao_introns$PSI,
  qualtable = tao_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Christopher
christopher_pdiff_introns <- prepareTableVolcano(
  psitable = christopher_introns$PSI,
  qualtable = christopher_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_christopher,
  colsB = colsGroupB_christopher,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Lyu
lyu_pdiff_introns <- prepareTableVolcano(
  psitable = lyu_introns$PSI,
  qualtable = lyu_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_lyu,
  colsB = colsGroupB_lyu,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Preprae table for dominic
dominic_pdiff_introns <- prepareTableVolcano(
  psitable = dominic_introns$PSI,
  qualtable = dominic_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_dominic,
  colsB = colsGroupB_dominic,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed=TRUE, 
  CoverageWeight = FALSE)
```

```{r intron f-stat}
# Preprae table for zhang
zhang_fstat_introns <- prepareTableVolcanoFstat(
  psitable = zhang_introns$PSI,
  qualtable = zhang_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_zhang,
  colsB = colsGroupB_zhang,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed=TRUE, 
  CoverageWeight = FALSE)

# Prepare table for Tao
tao_fstat_introns <- prepareTableVolcanoFstat(
  psitable = tao_introns$PSI,
  qualtable = tao_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Christopher
christopher_fstat_introns <- prepareTableVolcanoFstat(
  psitable = christopher_introns$PSI,
  qualtable = christopher_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_christopher,
  colsB = colsGroupB_christopher,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Lyu
lyu_fstat_introns <- prepareTableVolcanoFstat(
  psitable = lyu_introns$PSI,
  qualtable = lyu_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_lyu,
  colsB = colsGroupB_lyu,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Preprae table for dominic
dominic_fstat_introns <- prepareTableVolcanoFstat(
  psitable = dominic_introns$PSI,
  qualtable = dominic_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_dominic,
  colsB = colsGroupB_dominic,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  seed=TRUE, 
  CoverageWeight = FALSE)
```

```{r FDR intron calculations}
# Preprae table for zhang
zhang_fdr_introns <- prepareTableVolcanoFDR(
  psitable = zhang_introns$PSI,
  qualtable = zhang_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_zhang,
  colsB = colsGroupB_zhang,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100, 
  seed=TRUE, 
  CoverageWeight = FALSE) 

# Prepare table for Tao
tao_fdr_introns <- prepareTableVolcanoFDR(
  psitable = tao_introns$PSI,
  qualtable = tao_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100, 
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Christopher
christopher_fdr_introns <- prepareTableVolcanoFDR(
  psitable = christopher_introns$PSI,
  qualtable = christopher_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_christopher,
  colsB = colsGroupB_christopher,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100,
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Prepare table for Lyu
lyu_fdr_introns <- prepareTableVolcanoFDR(
  psitable = lyu_introns$PSI,
  qualtable = lyu_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_lyu,
  colsB = colsGroupB_lyu,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100, 
  nsim = 100,
  seed = TRUE, 
  CoverageWeight = FALSE
)

# Preprae table for dominic
dominic_fdr_introns <- prepareTableVolcanoFDR(
  psitable = dominic_introns$PSI,
  qualtable = dominic_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_dominic,
  colsB = colsGroupB_dominic,
  labA = groupA,
  labB = groupB,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim = 100, 
  seed=TRUE, 
  CoverageWeight = FALSE) 
```



### FDR Volcano Plots { .tabset}

#### Zhang

```{r zhang intron fdr volcano}
plotVolcanoFDR(betasTable =filter(zhang_fdr_introns,!is.na(EVENT)),
                            labA = groupA,
                            labB = groupB,
                            basalColor = "#89C0AE",
                            interestColor = "#E69A9C") +
  
theme(
  plot.title = element_text(size = 10),  # Title font size
  axis.title = element_text(size = 10),  # Axis title font size
  axis.text = element_text(size = 10),   # Axis text font size
  legend.text = element_text(size = 10), # Legend text font size
  legend.title = element_text(size = 10) # Legend title font size
)
```

#### Lyu

```{r lyu fdr intron volcano}
plotVolcanoFDR(betasTable =filter(lyu_fdr_introns,!is.na(EVENT)),
                            labA = groupA,
                            labB = groupB,
                            basalColor = "#89C0AE",
                            interestColor = "#E69A9C") +
theme(
  plot.title = element_text(size = 10),  # Title font size
  axis.title = element_text(size = 10),  # Axis title font size
  axis.text = element_text(size = 10),   # Axis text font size
  legend.text = element_text(size = 10), # Legend text font size
  legend.title = element_text(size = 10) # Legend title font size
)
```

#### Tao

```{r tao fdr intron volcano}
plotVolcanoFDR(betasTable =filter(tao_fdr_introns,!is.na(EVENT)),
                            labA = groupA_tao,
                            labB = groupB_tao,
                            basalColor = "#89C0AE",
                            interestColor = "#E69A9C") +
theme(
  plot.title = element_text(size = 10),  # Title font size
  axis.title = element_text(size = 10),  # Axis title font size
  axis.text = element_text(size = 10),   # Axis text font size
  legend.text = element_text(size = 10), # Legend text font size
  legend.title = element_text(size = 10) # Legend title font size
)
```

#### Christopher

```{r christopher fdr intron volcano}
plotVolcanoFDR(betasTable =filter(christopher_fdr_introns,!is.na(EVENT)),
                            labA = groupA,
                            labB = groupB,
                            basalColor = "#89C0AE",
                            interestColor = "#E69A9C") +
theme(
  plot.title = element_text(size = 10),  # Title font size
  axis.title = element_text(size = 10),  # Axis title font size
  axis.text = element_text(size = 10),   # Axis text font size
  legend.text = element_text(size = 10), # Legend text font size
  legend.title = element_text(size = 10) # Legend title font size
)
```

#### Dominic

```{r dominic fdr intron volcano}
plotVolcanoFDR(betasTable =filter(dominic_fdr_introns,!is.na(EVENT)),
                            labA = groupA,
                            labB = groupB,
                            basalColor = "#89C0AE",
                            interestColor = "#E69A9C") +
theme(
  plot.title = element_text(size = 10),  # Title font size
  axis.title = element_text(size = 10),  # Axis title font size
  axis.text = element_text(size = 10),   # Axis text font size
  legend.text = element_text(size = 10), # Legend text font size
  legend.title = element_text(size = 10) # Legend title font size
)
```

### Individual Combination Tables { .tabset}

#### Zhang

```{r zhang table intron making}
zhang_pdiff_introns_tab <- zhang_pdiff_introns[, c("GENE", "EVENT", "COORD", "Pdiff", "deltapsi")] %>%
  filter(!is.na(EVENT), Pdiff >= 0.95) %>%  # Remove rows where EVENT is NA and Pdiff >= 0.95
  arrange(desc(Pdiff), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(zhang_pdiff_introns_tab) <- 1:nrow(zhang_pdiff_introns_tab)

zhang_fstat_introns_tab <- zhang_fstat_introns[, c("GENE","EVENT","COORD","Fstat","deltapsi")] %>%
  filter(!is.na(EVENT)) %>%  # Remove rows where EVENT is NA
  arrange(desc(Fstat), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(zhang_fstat_introns_tab) <- 1:nrow(zhang_fstat_introns_tab)

zhang_fdr_introns_tab <- zhang_fdr_introns[, c("GENE","EVENT","COORD","FDR","deltapsi")] %>%
  filter(!is.na(EVENT), FDR<=0.05) %>%  # Remove rows where EVENT is NA
  arrange((FDR), desc(abs(deltapsi)))
rownames(zhang_fdr_introns_tab) <- 1:nrow(zhang_fdr_introns_tab)

# Find common EVENTs across all tables
common_events <- Reduce(intersect, list(zhang_pdiff_introns_tab$EVENT, zhang_fstat_introns_tab$EVENT, zhang_fdr_introns_tab$EVENT))

# Filter each table to include only rows with common EVENTs
filtered_intron_diff_tab <- zhang_pdiff_introns_tab %>% filter(EVENT %in% common_events)
filtered_intron_fstat_tab <- zhang_fstat_introns_tab %>% filter(EVENT %in% common_events)
filtered_intron_fdr_tab <- zhang_fdr_introns_tab %>% filter(EVENT %in% common_events)


# Select only unique columns from each table
filtered_intron_diff_tab <- filtered_intron_diff_tab %>% select(GENE,EVENT,COORD, deltapsi,Pdiff) # Extra column is Pdiff
filtered_intron_fstat_tab <- filtered_intron_fstat_tab %>% select(EVENT, Fstat) # Extra column is Fstat
filtered_intron_fdr_tab <- filtered_intron_fdr_tab %>% select(EVENT, FDR) # Extra column is FDR

# Merge the data frames by EVENT
zhang_intron_combination_tab <- filtered_intron_diff_tab %>%
  inner_join(filtered_intron_fstat_tab, by = "EVENT") %>%
  inner_join(filtered_intron_fdr_tab, by = "EVENT") %>%
  distinct() %>%
  arrange(desc(abs(deltapsi)), desc(Fstat),desc(FDR), desc(Pdiff))
```

```{r zhang combination intron table}
# Render DataTable with enhancements
datatable(
  zhang_intron_combination_tab,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

output_dir <- file.path(getwd(), "results", "tables")
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
write.csv(zhang_intron_combination_tab, 
          file = file.path(output_dir, paste0("zhang_intron_combination_table_", format(Sys.Date(), "%Y%m%d"), ".csv")),
          row.names = FALSE)
```

#### Lyu

```{r lyu table intron making}
lyu_pdiff_introns_tab <- lyu_pdiff_introns[, c("GENE", "EVENT", "COORD", "Pdiff", "deltapsi")] %>%
  filter(!is.na(EVENT), Pdiff >= 0.95) %>%  # Remove rows where EVENT is NA and Pdiff >= 0.95
  arrange(desc(Pdiff), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(lyu_pdiff_introns_tab) <- 1:nrow(lyu_pdiff_introns_tab)

lyu_fstat_introns_tab <- lyu_fstat_introns[, c("GENE","EVENT","COORD","Fstat","deltapsi")] %>%
  filter(!is.na(EVENT)) %>%  # Remove rows where EVENT is NA
  arrange(desc(Fstat), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(lyu_fstat_introns_tab) <- 1:nrow(lyu_fstat_introns_tab)

lyu_fdr_introns_tab <- lyu_fdr_introns[, c("GENE","EVENT","COORD","FDR","deltapsi")] %>%
  filter(!is.na(EVENT), FDR<=0.05) %>%  # Remove rows where EVENT is NA
  arrange((FDR), desc(abs(deltapsi)))
rownames(lyu_fdr_introns_tab) <- 1:nrow(lyu_fdr_introns_tab)

# Find common EVENTs across all tables
common_events <- Reduce(intersect, list(lyu_pdiff_introns_tab$EVENT, lyu_fstat_introns_tab$EVENT, lyu_fdr_introns_tab$EVENT))

# Filter each table to include only rows with common EVENTs
filtered_intron_diff_tab <- lyu_pdiff_introns_tab %>% filter(EVENT %in% common_events)
filtered_intron_fstat_tab <- lyu_fstat_introns_tab %>% filter(EVENT %in% common_events)
filtered_intron_fdr_tab <- lyu_fdr_introns_tab %>% filter(EVENT %in% common_events)


# Select only unique columns from each table
filtered_intron_diff_tab <- filtered_intron_diff_tab %>% select(GENE,EVENT,COORD, deltapsi,Pdiff) # Extra column is Pdiff
filtered_intron_fstat_tab <- filtered_intron_fstat_tab %>% select(EVENT, Fstat) # Extra column is Fstat
filtered_intron_fdr_tab <- filtered_intron_fdr_tab %>% select(EVENT, FDR) # Extra column is FDR

# Merge the data frames by EVENT
lyu_intron_combination_tab <- filtered_intron_diff_tab %>%
  inner_join(filtered_intron_fstat_tab, by = "EVENT") %>%
  inner_join(filtered_intron_fdr_tab, by = "EVENT") %>%
  distinct() %>%
  arrange(desc(abs(deltapsi)), desc(Fstat),desc(FDR), desc(Pdiff))
```

```{r lyu combination intron table}
# Render DataTable with enhancements
datatable(
  lyu_intron_combination_tab,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

write.csv(lyu_intron_combination_tab, 
          file = file.path(output_dir, paste0("lyu_intron_combination_table_", format(Sys.Date(), "%Y%m%d"), ".csv")),
          row.names = FALSE)
```

#### Tao

```{r tao table intron making}
tao_pdiff_introns_tab <- tao_pdiff_introns[, c("GENE", "EVENT", "COORD", "Pdiff", "deltapsi")] %>%
  filter(!is.na(EVENT), Pdiff >= 0.95) %>%  # Remove rows where EVENT is NA and Pdiff >= 0.95
  arrange(desc(Pdiff), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(tao_pdiff_introns_tab) <- 1:nrow(tao_pdiff_introns_tab)

tao_fstat_introns_tab <- tao_fstat_introns[, c("GENE","EVENT","COORD","Fstat","deltapsi")] %>%
  filter(!is.na(EVENT)) %>%  # Remove rows where EVENT is NA
  arrange(desc(Fstat), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(tao_fstat_introns_tab) <- 1:nrow(tao_fstat_introns_tab)

tao_fdr_introns_tab <- tao_fdr_introns[, c("GENE","EVENT","COORD","FDR","deltapsi")] %>%
  filter(!is.na(EVENT), FDR<=0.05) %>%  # Remove rows where EVENT is NA
  arrange((FDR), desc(abs(deltapsi)))
rownames(tao_fdr_introns_tab) <- 1:nrow(tao_fdr_introns_tab)

# Find common EVENTs across all tables
common_events <- Reduce(intersect, list(tao_pdiff_introns_tab$EVENT, tao_fstat_introns_tab$EVENT, tao_fdr_introns_tab$EVENT))

# Filter each table to include only rows with common EVENTs
filtered_intron_diff_tab <- tao_pdiff_introns_tab %>% filter(EVENT %in% common_events)
filtered_intron_fstat_tab <- tao_fstat_introns_tab %>% filter(EVENT %in% common_events)
filtered_intron_fdr_tab <- tao_fdr_introns_tab %>% filter(EVENT %in% common_events)


# Select only unique columns from each table
filtered_intron_diff_tab <- filtered_intron_diff_tab %>% select(GENE,EVENT,COORD, deltapsi,Pdiff) # Extra column is Pdiff
filtered_intron_fstat_tab <- filtered_intron_fstat_tab %>% select(EVENT, Fstat) # Extra column is Fstat
filtered_intron_fdr_tab <- filtered_intron_fdr_tab %>% select(EVENT, FDR) # Extra column is FDR

# Merge the data frames by EVENT
tao_intron_combination_tab <- filtered_intron_diff_tab %>%
  inner_join(filtered_intron_fstat_tab, by = "EVENT") %>%
  inner_join(filtered_intron_fdr_tab, by = "EVENT") %>%
  distinct() %>%
  arrange(desc(abs(deltapsi)), desc(Fstat),desc(FDR), desc(Pdiff))
```

```{r tao combination intron table}
# Render DataTable with enhancements
datatable(
  tao_intron_combination_tab,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

write.csv(tao_intron_combination_tab, 
          file = file.path(output_dir, paste0("tao_intron_combination_table_", format(Sys.Date(), "%Y%m%d"), ".csv")),
          row.names = FALSE)
```

#### Dominic

```{r dominic table intron making}
dominic_pdiff_introns_tab <- dominic_pdiff_introns[, c("GENE", "EVENT", "COORD", "Pdiff", "deltapsi")] %>%
  filter(!is.na(EVENT), Pdiff >= 0.95) %>%  # Remove rows where EVENT is NA and Pdiff >= 0.95
  arrange(desc(Pdiff), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(dominic_pdiff_introns_tab) <- 1:nrow(dominic_pdiff_introns_tab)

dominic_fstat_introns_tab <- dominic_fstat_introns[, c("GENE","EVENT","COORD","Fstat","deltapsi")] %>%
  filter(!is.na(EVENT)) %>%  # Remove rows where EVENT is NA
  arrange(desc(Fstat), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(dominic_fstat_introns_tab) <- 1:nrow(dominic_fstat_introns_tab)

dominic_fdr_introns_tab <- dominic_fdr_introns[, c("GENE","EVENT","COORD","FDR","deltapsi")] %>%
  filter(!is.na(EVENT), FDR<=0.05) %>%  # Remove rows where EVENT is NA
  arrange((FDR), desc(abs(deltapsi)))
rownames(dominic_fdr_introns_tab) <- 1:nrow(dominic_fdr_introns_tab)

# Find common EVENTs across all tables
common_events <- Reduce(intersect, list(dominic_pdiff_introns_tab$EVENT, dominic_fstat_introns_tab$EVENT, dominic_fdr_introns_tab$EVENT))

# Filter each table to include only rows with common EVENTs
filtered_intron_diff_tab <- dominic_pdiff_introns_tab %>% filter(EVENT %in% common_events)
filtered_intron_fstat_tab <- dominic_fstat_introns_tab %>% filter(EVENT %in% common_events)
filtered_intron_fdr_tab <- dominic_fdr_introns_tab %>% filter(EVENT %in% common_events)


# Select only unique columns from each table
filtered_intron_diff_tab <- filtered_intron_diff_tab %>% select(GENE,EVENT,COORD, deltapsi,Pdiff) # Extra column is Pdiff
filtered_intron_fstat_tab <- filtered_intron_fstat_tab %>% select(EVENT, Fstat) # Extra column is Fstat
filtered_intron_fdr_tab <- filtered_intron_fdr_tab %>% select(EVENT, FDR) # Extra column is FDR

# Merge the data frames by EVENT
dominic_intron_combination_tab <- filtered_intron_diff_tab %>%
  inner_join(filtered_intron_fstat_tab, by = "EVENT") %>%
  inner_join(filtered_intron_fdr_tab, by = "EVENT") %>%
  distinct() %>%
  arrange(desc(abs(deltapsi)), desc(Fstat),desc(FDR), desc(Pdiff))
```

```{r dominic combination intron table}
# Render DataTable with enhancements
datatable(
  dominic_intron_combination_tab,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


write.csv(dominic_intron_combination_tab, 
          file = file.path(output_dir, paste0("dominic_intron_combination_table_", format(Sys.Date(), "%Y%m%d"), ".csv")),
          row.names = FALSE)
```


#### Christopher

```{r christopher table intron making}
christopher_pdiff_introns_tab <- christopher_pdiff_introns[, c("GENE", "EVENT", "COORD", "Pdiff", "deltapsi")] %>%
  filter(!is.na(EVENT), Pdiff >= 0.95) %>%  # Remove rows where EVENT is NA and Pdiff >= 0.95
  arrange(desc(Pdiff), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(christopher_pdiff_introns_tab) <- 1:nrow(christopher_pdiff_introns_tab)

christopher_fstat_introns_tab <- christopher_fstat_introns[, c("GENE","EVENT","COORD","Fstat","deltapsi")] %>%
  filter(!is.na(EVENT)) %>%  # Remove rows where EVENT is NA
  arrange(desc(Fstat), desc(abs(deltapsi)))  # Sort by Pdiff and abs(deltapsi)
rownames(christopher_fstat_introns_tab) <- 1:nrow(christopher_fstat_introns_tab)

christopher_fdr_introns_tab <- christopher_fdr_introns[, c("GENE","EVENT","COORD","FDR","deltapsi")] %>%
  filter(!is.na(EVENT), FDR<=0.05) %>%  # Remove rows where EVENT is NA
  arrange((FDR), desc(abs(deltapsi)))
rownames(christopher_fdr_introns_tab) <- 1:nrow(christopher_fdr_introns_tab)

# Find common EVENTs across all tables
common_events <- Reduce(intersect, list(christopher_pdiff_introns_tab$EVENT, christopher_fstat_introns_tab$EVENT, christopher_fdr_introns_tab$EVENT))

# Filter each table to include only rows with common EVENTs
filtered_intron_diff_tab <- christopher_pdiff_introns_tab %>% filter(EVENT %in% common_events)
filtered_intron_fstat_tab <- christopher_fstat_introns_tab %>% filter(EVENT %in% common_events)
filtered_intron_fdr_tab <- christopher_fdr_introns_tab %>% filter(EVENT %in% common_events)


# Select only unique columns from each table
filtered_intron_diff_tab <- filtered_intron_diff_tab %>% select(GENE,EVENT,COORD, deltapsi,Pdiff) # Extra column is Pdiff
filtered_intron_fstat_tab <- filtered_intron_fstat_tab %>% select(EVENT, Fstat) # Extra column is Fstat
filtered_intron_fdr_tab <- filtered_intron_fdr_tab %>% select(EVENT, FDR) # Extra column is FDR

# Merge the data frames by EVENT
christopher_intron_combination_tab <- filtered_intron_diff_tab %>%
  inner_join(filtered_intron_fstat_tab, by = "EVENT") %>%
  inner_join(filtered_intron_fdr_tab, by = "EVENT") %>%
  distinct() %>%
  arrange(desc(abs(deltapsi)), desc(Fstat),desc(FDR), desc(Pdiff))
```

```{r christopher combination intron table}
# Render DataTable with enhancements
datatable(
  christopher_intron_combination_tab,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

write.csv(christopher_intron_combination_tab, 
          file = file.path(output_dir, paste0("christopher_intron_combination_table_", format(Sys.Date(), "%Y%m%d"), ".csv")),
          row.names = FALSE)
```



# Unsorted Intron Candidates List

```{r merging final intron lists intron, warning=FALSE}
# List of data frames to compare
dataframes <- list(
  christopher = christopher_intron_combination_tab,
  tao = tao_intron_combination_tab,
  lyu = lyu_intron_combination_tab,
  zhang= zhang_intron_combination_tab,
  dominic=dominic_intron_combination_tab
)

# Extract unique EVENTS for each data frame
events_list <- lapply(dataframes, function(df) unique(df$EVENT))

# Function to calculate unique and shared counts for a given combination of data frames
compute_shared_and_unique <- function(indices) {
  combo_names <- names(events_list)[indices]
  combined_events <- events_list[indices]
  
  # Compute shared and unique values
  shared <- Reduce(intersect, combined_events)
  unique_events <- lapply(combined_events, function(events) {
    setdiff(events, unlist(combined_events[-which(combined_events == events)]))
  })
  
  # Return result even if one combination is empty
  list(
    combination = combo_names, # Store as list of dataset names
    shared_count = length(shared),
    unique_counts = sapply(unique_events, length)
  )
}

# Iterate through all subsets of data frames
all_combinations <- lapply(1:length(events_list), function(k) {
  combn(seq_along(events_list), k, compute_shared_and_unique, simplify = FALSE)
})

# Flatten the list of results
all_combinations <- unlist(all_combinations, recursive = FALSE)

# Ensure all results have consistent structure
introns_candidates <- do.call(rbind, lapply(all_combinations, function(res) {
  # Handle cases with no unique values gracefully
  data.frame(
    Combination = I(list(res$combination)), # Store combination as list object
    Shared = res$shared_count,
    Unique = I(list(res$unique_counts)),   # Store unique counts as list object
    row.names = NULL
  )
}))
introns_candidates<-as.tibble(introns_candidates)

# Check if lengths match
if (length(introns_candidates$Combination) != length(introns_candidates$Shared)) {
  stop("Lengths of Combination and Shared are not the same.")
}

# Apply mutate safely
introns_candidates <- introns_candidates %>%
  mutate(Combination = map2(Combination, Shared, ~rep(list(.x), .y))) %>%
  unnest(Combination)


```


```{r plot venn diagram intron}
counts <- introns_candidates %>%
  count(Combination)

upset_intron_plot<-introns_candidates %>%
  ggplot(aes(x = Combination)) +
  geom_bar(fill = "#D8D97AFF", color = "black") +  # Polished bar colors
  geom_text(data = counts, aes(x = Combination, y = n, label = n),
            vjust = -0.5, size = 3.5) +  # Add count labels
  scale_x_upset(n_intersections = 31) +
  labs(
    title = paste("UpSet Plot of Intron Candidates (", Sys.Date(), ")", sep = ""),
    x = "Intron Combinations",
    y = "Count"
  ) +
  theme_minimal() +  # Professional font
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    panel.grid.major = element_line(color = "white", size = 0.7),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    plot.background = element_rect(fill = "white"),
    strip.text = element_text(size = 12, face = "bold")
  ) 

upset_intron_plot
```
```{r shared events final list intron}
# Extract the shared events in all dataframes
shared_events <- Reduce(intersect, lapply(dataframes, function(df) df$EVENT))

tao_shared<-tao_intron_combination_tab[tao_intron_combination_tab$EVENT %in% shared_events,]
lyu_shared<-lyu_intron_combination_tab[lyu_intron_combination_tab$EVENT %in% shared_events,]
zhang_shared<-zhang_intron_combination_tab[zhang_intron_combination_tab$EVENT %in% shared_events,]
christopher_shared<-christopher_intron_combination_tab[christopher_intron_combination_tab$EVENT %in% shared_events,]
dominic_shared<-dominic_intron_combination_tab[dominic_intron_combination_tab$EVENT %in% shared_events,]


combined_data <- bind_rows(
  tao_shared %>% mutate(Source = "tao_shared"),
  lyu_shared %>% mutate(Source = "lyu_shared"),
  zhang_shared %>% mutate(Source = "zhang_shared"),
  christopher_shared %>% mutate(Source = "christopher_shared"),
  dominic_shared<-dominic_intron_combination_tab[dominic_intron_combination_tab$EVENT %in% shared_events,]
)

# Calculate average per EVENT
averaged_data <- combined_data %>%
  group_by(EVENT) %>%
  summarise(
    avg_deltapsi = mean(deltapsi, na.rm = TRUE),
    avg_Fstat = mean(Fstat, na.rm = TRUE),
    avg_Pdiff = mean(Pdiff, na.rm = TRUE),
    avg_FDR = mean(FDR, na.rm = TRUE)
  )

final_intron_list<-averaged_data 
final_intron_list$GENE <- tao_shared$GENE[match(final_intron_list$EVENT, tao_shared$EVENT)]
final_intron_list$COORD <- tao_shared$COORD[match(final_intron_list$EVENT, tao_shared$EVENT)]
final_intron_list<- final_intron_list %>%
  select(GENE, EVENT, COORD, everything()) %>%
  arrange(desc(abs(avg_deltapsi))) %>%
  mutate(avg_deltapsi = round(avg_deltapsi, 3),
         avg_Fstat = round(avg_Fstat, 3),
         avg_Pdiff = round(avg_Pdiff, 3),
         avg_FDR = round(avg_FDR, 3))

```

```{r output final list intron}
# Render DataTable with enhancements
datatable(
  final_intron_list,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "avg_Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "avg_deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)




write.csv(final_intron_list, 
          file = file.path(output_dir, paste0("final_intron_list_unsorted_", format(Sys.Date(), "%Y%m%d"), ".csv")),
          row.names = FALSE)
```




# Unsorted Exon Candidates List

```{r merging final lists, warning=FALSE}
# List of data frames to compare
dataframes <- list(
  christopher = christopher_exon_combination_tab,
  tao = tao_exon_combination_tab,
  lyu = lyu_exon_combination_tab,
  zhang= zhang_exon_combination_tab,
  dominic=dominic_exon_combination_tab
)

# Extract unique EVENTS for each data frame
events_list <- lapply(dataframes, function(df) unique(df$EVENT))

# Function to calculate unique and shared counts for a given combination of data frames
compute_shared_and_unique <- function(indices) {
  combo_names <- names(events_list)[indices]
  combined_events <- events_list[indices]
  
  # Compute shared and unique values
  shared <- Reduce(intersect, combined_events)
  unique_events <- lapply(combined_events, function(events) {
    setdiff(events, unlist(combined_events[-which(combined_events == events)]))
  })
  
  # Return result even if one combination is empty
  list(
    combination = combo_names, # Store as list of dataset names
    shared_count = length(shared),
    unique_counts = sapply(unique_events, length)
  )
}

# Iterate through all subsets of data frames
all_combinations <- lapply(1:length(events_list), function(k) {
  combn(seq_along(events_list), k, compute_shared_and_unique, simplify = FALSE)
})

# Flatten the list of results
all_combinations <- unlist(all_combinations, recursive = FALSE)

# Ensure all results have consistent structure
exons_candidates <- do.call(rbind, lapply(all_combinations, function(res) {
  # Handle cases with no unique values gracefully
  data.frame(
    Combination = I(list(res$combination)), # Store combination as list object
    Shared = res$shared_count,
    Unique = I(list(res$unique_counts)),   # Store unique counts as list object
    row.names = NULL
  )
}))
exons_candidates<-as.tibble(exons_candidates)

# Check if lengths match
if (length(exons_candidates$Combination) != length(exons_candidates$Shared)) {
  stop("Lengths of Combination and Shared are not the same.")
}

# Apply mutate safely
exons_candidates <- exons_candidates %>%
  mutate(Combination = map2(Combination, Shared, ~rep(list(.x), .y))) %>%
  unnest(Combination)


```


```{r plot venn diagram}
counts <- exons_candidates %>%
  count(Combination)

upset_exon_plot<-exons_candidates %>%
  ggplot(aes(x = Combination)) +
  geom_bar(fill = "#D8D97AFF", color = "black") +  # Polished bar colors
  geom_text(data = counts, aes(x = Combination, y = n, label = n),
            vjust = -0.5, size = 3.5) +  # Add count labels
  scale_x_upset(n_intersections = 31) +
  labs(
    title = paste("UpSet Plot of Exon Candidates (", Sys.Date(), ")", sep = ""),
    x = "Exon Combinations",
    y = "Count"
  ) +
  theme_minimal() +  # Professional font
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    panel.grid.major = element_line(color = "white", size = 0.7),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "lightblue"),  # Set background color
    plot.background = element_rect(fill = "white"),
    strip.text = element_text(size = 12, face = "bold")
  ) 

upset_exon_plot
```

```{r shared events final list}
# Extract the shared events in all dataframes
shared_events <- Reduce(intersect, lapply(dataframes, function(df) df$EVENT))

tao_shared<-tao_exon_combination_tab[tao_exon_combination_tab$EVENT %in% shared_events,]
lyu_shared<-lyu_exon_combination_tab[lyu_exon_combination_tab$EVENT %in% shared_events,]
zhang_shared<-zhang_exon_combination_tab[zhang_exon_combination_tab$EVENT %in% shared_events,]
christopher_shared<-christopher_exon_combination_tab[christopher_exon_combination_tab$EVENT %in% shared_events,]
dominic_shared<-dominic_exon_combination_tab[dominic_exon_combination_tab$EVENT %in% shared_events,]


combined_data <- bind_rows(
  tao_shared %>% mutate(Source = "tao_shared"),
  lyu_shared %>% mutate(Source = "lyu_shared"),
  zhang_shared %>% mutate(Source = "zhang_shared"),
  christopher_shared %>% mutate(Source = "christopher_shared"),
  dominic_shared<-dominic_exon_combination_tab[dominic_exon_combination_tab$EVENT %in% shared_events,]
)

# Calculate average per EVENT
averaged_data <- combined_data %>%
  group_by(EVENT) %>%
  summarise(
    avg_deltapsi = mean(deltapsi, na.rm = TRUE),
    avg_Fstat = mean(Fstat, na.rm = TRUE),
    avg_Pdiff = mean(Pdiff, na.rm = TRUE),
    avg_FDR = mean(FDR, na.rm = TRUE)
  )

final_exon_list<-averaged_data 
final_exon_list$GENE <- tao_shared$GENE[match(final_exon_list$EVENT, tao_shared$EVENT)]
final_exon_list$COORD <- tao_shared$COORD[match(final_exon_list$EVENT, tao_shared$EVENT)]
final_exon_list<- final_exon_list %>%
  select(GENE, EVENT, COORD, everything()) %>%
  arrange(desc(abs(avg_deltapsi))) %>%
  mutate(avg_deltapsi = round(avg_deltapsi, 3),
         avg_Fstat = round(avg_Fstat, 3),
         avg_Pdiff = round(avg_Pdiff, 3),
         avg_FDR = round(avg_FDR, 3))

```

```{r output final list}
# Render DataTable with enhancements
datatable(
  final_exon_list,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "avg_Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "avg_deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)




write.csv(final_exon_list, 
          file = file.path(output_dir, paste0("final_exon_list_unsorted_", format(Sys.Date(), "%Y%m%d"), ".csv")),
          row.names = FALSE)
```

## Event Densities

```{r densities_per_event, fig.width=14, fig.height=10, out.width="100%", warning=FALSE, message=FALSE}
# Adjust your plotting function
plots <- lapply(1:12, function(i) {
  eventID <- final_exon_list$EVENT[i]
  geneName <- final_exon_list$GENE[i]
  
  # Create the plot for each row using the provided parameters
  tdensities <- plotIndividualDensitiesList(
    eventID = eventID,
    npoints = 500,
    psitable = tao_exons$PSI,
    qualtable = tao_exons$Qual,
    groupList = groupList_tao,
    maxDevTable = maxDevSimulationN100, 
    seed = TRUE, 
    CoverageWeight = FALSE
  )
  
  # Modify the plot with ggtitle using the GENE and EVENT from the row
  plot_with_title <- tdensities + 
    theme_minimal(base_family = font) + 
    theme(
      plot.title = element_text(size = 14, face = "bold"),  # Increase title size
      axis.text = element_text(size = 12),  # Increase axis label size
      axis.title = element_text(size = 14),  # Increase axis text size
      axis.text.y = element_blank(),  # Remove Y-axis text
      axis.title.y = element_blank(),  # Remove Y-axis title
      axis.ticks.y = element_blank()   # Remove Y-axis tick
    ) + 
    ggtitle(paste(geneName, eventID))
  
  return(plot_with_title)
})

# Adjust the number of columns for wrapping and add the Y-axis once per row
final_figure <- wrap_plots(plots, ncol = 3, byrow = TRUE) + 
  plot_layout(guides = 'collect') + 
  theme(plot.margin = margin(0, 0, 0, 0))  # Adjust margins for consistent spacing

# Display the combined figure
final_figure

```


# Gene Ontology of Filtered Splicing Events

```{r gene ontology}
gene_entrez <- bitr(union(final_exon_list$GENE, final_intron_list$GENE), fromType = "ALIAS", toType = "ENTREZID", OrgDb = org.Mm.eg.db)

# GO Enrichment Analysis
go_enrich <- enrichGO(gene = gene_entrez$ENTREZID,
                      OrgDb = org.Mm.eg.db,
                      ont = "ALL",
                      pAdjustMethod = "BH",
                      pvalueCutoff = 0.05,
                      qvalueCutoff = 0.05)

# KEGG Pathway Enrichment
kegg_enrich <- enrichKEGG(gene = gene_entrez$ENTREZID,
                          organism = "mmu",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05)

# Reactome Pathway Enrichment Guangchuang Yu, Qing-Yu He. ReactomePA: an R/Bioconductor package for reactome pathway analysis and visualization. Molecular BioSystems 2016, 12(2):477-479
reactome_enrich <- enrichPathway(gene = gene_entrez$ENTREZID,
                                 organism = "mouse",
                                 pAdjustMethod = "BH",
                                 pvalueCutoff = 0.05)
# Dot plot for GO terms
dotplot(go_enrich, showCategory = 20) + ggtitle("GO Enrichment Analysis")
```



