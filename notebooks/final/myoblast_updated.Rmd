---
title: 'Force-based regulation of splicing during Myoblast differentiation'
subtitle: "Stage 1: Bioinformatical Analysis of Myogenic Transcripts"
author: "Andrés Gordo Ortiz @Al Jord Lab CRG"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    code_folding: hide
    code_download: false
    df_print: paged
    theme: flatly
    highlight: tango
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    number_sections: true

editor_options:
  markdown:
    wrap: 72


# Finally, you must have the Mus musculus (mm10 build) EVENT_INFO-mm10.tab and SPLICE_SITE_SCORES-mm10.tab files downloaded and unzipped in the root folder of this project repository. You can download them here:https://vastdb.crg.eu/wiki/Downloads
# The supplementary tables from Wu et al. 2024 are also needed in the root idirectory: https://www.science.org/doi/suppl/10.1126/sciadv.adp7727/suppl_file/sciadv.adp7727_tables_s1_to_s6.zip


header-includes:
  - '<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">'
  - '<style>
        #logos {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        #logos img {
            height: 80px;
            margin: 0 15px;
        }
     </style>'


---


```{css, echo=FALSE}
/* Custom CSS for styling */
body {
  font-family: 'Roboto', sans-serif; /* Body font */
  color: #333; /* Neutral dark gray for body text */
}

h1, h2, h3, h4, h5, h6 {
  font-family: 'Roboto', sans-serif; /* Headers font */
  font-weight: bold;
}

/* Header Colors */
h1 {
  font-size: 2.5em;
  color: #0099CD; /* Primary blue for main headers */
}

h2 {
  font-size: 2em;
  color: #0077A3; /* Slightly darker shade of blue for secondary headers */
}

h3 {
  font-size: 1.75em;
  color: #005F8C; /* Even darker blue for tertiary headers */
}

p {
  text-align: justify;
  line-height: 1.6; /* Improve readability */
}

/* Styling for subtitle, authors, and date */
.subtitle, .author, .date {
  color: #000; /* Black text */
  font-size: 1.25em; /* Slightly larger for emphasis */
  margin-bottom: 0.5em;
  text-align: center; /* Center alignment for clean layout */
}

/* Link styling */
a {
  color: #0099CD; /* Link color */
  text-decoration: none;
}

a:hover {
  color: #005F8C; /* Darker shade on hover */
  text-decoration: underline;
}

/* Table styling */
table {
  border-collapse: collapse;
  width: 100%;
}

table th, table td {
  border: 1px solid #ddd;
  padding: 10px;
}

table th {
  background-color: #0099CD; /* Header background blue */
  color: white; /* White text for contrast */
  text-align: center;
}

table tr:nth-child(even) {
  background-color: #f9f9f9; /* Light gray for even rows */
}

table tr:hover {
  background-color: #f1f1f1; /* Subtle highlight on hover */
}
```



```{r setup, include=FALSE}
# Ensure a clean environment and load required libraries.
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE
)


# Load required libraries
library("betAS")
library("ggplot2")
library("plotly")
library("dplyr")
library("tidyverse")
library("cowplot")
library("DT")
library("paletteer")
library("ggupset")
library("showtext")
library("ggtext")
library("readxl")
library("biomaRt")
library("patchwork")
library("org.Mm.eg.db")
library("org.Hs.eg.db")
library("enrichplot")
library("DOSE")
library("clusterProfiler")
library("ReactomePA")
library("ComplexHeatmap")
library("enrichR")
library("colorRamp2")
library("dendextend")


# Register Google fonts
showtext_auto()
font_add_google("Roboto", "roboto")
font="roboto"
```

# Introduction to this Analysis

## Objective

The primary aim is to identify a list of splicing events that meet the following criteria:
1. **Differential Splicing**: Events are differentially spliced during myoblast differentiation.
2. **Spatial Relevance**: Events occur near or around nuclear speckles.
This analysis is structured into two distinct parts, the first performed in the Bash Command     Line, and the second in R. This report shows the second part.

---

## Part 1: Upstream Analysis

The upstream analysis is performed on the CRG cluster using the Bash command line. This phase involves:

1. **Data Acquisition**:
   - Downloading `*.fastq.gz` files from five different databases.

2. **Alignment**:
   - Aligning the sequences to the latest mouse genome release (mm10) using **Bowtie2** through the [Vast-Tools align function](https://link.springer.com/protocol/10.1007/978-1-0716-2521-7_7).

3. **Event Detection**:
   - Importing inclusion tables generated by Vast-Tools into RStudio. The tables cover the following splicing events:
     - **Exons (EX)**
     - **Introns (IN)**
     - **Alternative 5' Splice Sites (Alt5)**
     - **Alternative 3' Splice Sites (Alt3)**
     - **Microexons (MIC)**

---

## Part 2: Statistical Analysis

### Objective
To identify splicing events that are differentially spliced during myoblast differentiation, and sorting them out according to how likely they are found close to nuclear speckles.

### Steps

1. **Statistical Testing**:
   - Use the [betAS package](https://rnajournal.cshlp.org/content/30/4/337) in R to perform:
     - **False Discovery Rate (FDR)**
     - **F-statistic**
     - **Probability of Differential Splicing (Pdiff)**

2. **Filtering Criteria**:
   - Retain events with:
     - **FDR ≤ 0.05**
     - **Pdiff ≥ 0.95**

3. **Batch Effect Mitigation**:
   - Each database is analyzed independently to control for batch effects and confounders.
   - A final list is generated by intersecting the splicing events identified in all five databases. This ensures the events are associated exclusively with differentiation. All exon related events (C1,C2,C3,S,including microexons) will be collapsed into a single list, EX. Alternative donor or acceptor sites are not taking into account for the list, as their junction will be harder to assess using RNA-FISH.

4. **Integration of Results**:
   - 10 lists (5 for exons and 5 for introns) are generated
   - Shared events across lists are conserved and ranked by:
     - **F-statistic**
     - **ΔPSI (Differential Percentage Spliced In)**

5. **Candidate Selection**:
   - Splicing events shared in all list are selected for the sorting stage.

6. **Feature Extraction**:
   - Features were obtained through the [VastDB](https://vastdb.crg.eu/) wiki:
     - **CG content**
     - **Sequence length**
     - **5'/3' splice site scores**
   - Gene Ontology related to Nuclear Speckles were obtained from [Wu et al. 2024](https://www.science.org/doi/10.1126/sciadv.adp7727) and [Baructu et al. 2022](https://www.cell.com/molecular-cell/fulltext/S1097-2765(21)01072-8):
     - **Speckles Gene Ontology**
     - **Gene List retained in Speckles**

The final plots showcase potentially promising events found in myoblast differentiation and related to speckles.

---

### Data Availability

| Name               | Publisher                             | ENA Link                                                                                     | Year | Study Specs                                                                                                                                                                                           | Details                                                 |
|--------------------|---------------------------------------|---------------------------------------------------------------------------------------------|------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|
| Kuo Zhang          | Nature Communications                 | [SRP160431](https://www.ebi.ac.uk/ena/browser/view/SRP160431)                               | 2018 | Reads from knock-down and shControl cells in myoblast and myotube stages. Controls include 3 paired-end biological replicates each for myoblast and myotubes, totaling 12 fastq files.                | ~30M per biosample                                      |
| Lingjian Tao       | Molecular Biotechnology               | [SRP496253](https://www.ebi.ac.uk/ena/browser/view/SRP496253)                               | 2024 | Myotube formation observed after 4 days, full maturation at 7 days. 3 paired-end biological replicates per condition across 4 timepoints (0, 2, 4, 7 days), totaling 24 fastq files.                  | ~44M per biosample                                      |
| Pengcheng Lyu      | MDPI Cells (data quality verified)    | [SRP335878](https://www.ebi.ac.uk/ena/browser/view/SRP335878)                               | 2022 | C2C12 cells differentiated in media, with autophagy inhibition using chloroquine (10 µM or 20 µM). 2 paired-end biological replicates per condition for myoblast and myotube stages, 8 fastq files.   | ~45M per biosample                                      |
| Dominic W. Kolonay | Frontiers in Cell and Developmental Biology | [SRP471123](https://www.ebi.ac.uk/ena/browser/view/SRP471123)                               | 2024 | Myoblasts differentiated to myotubes in DMEM with horse serum and antibiotics over 5 days. 3 paired-end biological replicates per condition (0 days myoblast, 5 days myotube), totaling 12 fastq files. | ~90M per biosample in myotubes, ~140M per biosample in myoblasts |
| Christopher Azar   | Physiological Reports                 | [SRP198848](https://www.ebi.ac.uk/ena/browser/view/SRP198848)                               | 2021 | Cells differentiated for 6 days with daily media changes. 3 single-end biological replicates per condition (0 days myoblast, 6 days myotube), totaling 6 fastq files.                                 | ~30M per biosample                                      |
| Kan                | Scientific Reports                   | [PRJNA388391](https://www.ebi.ac.uk/ena/browser/view/PRJNA388391)                           | 2018    | 3 technical replicates per condition (myoblasts and myotubes).                                                                                                                                        | ~44M reads (22M paired-end)                             |

---

## Importing Inclusion Data

```{r inclusion tables}

# Tao et al. 2024 data
tao_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/Tao_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
tao_events <- getEvents(tao_data, tool = "vast-tools") # Extract alternative splicing events
#tao_events <- alternativeEvents(tao_events, minPsi = 0, maxPsi = 100) # Filter events based on PSI thresholds
tao_exons <- filterEvents(tao_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 2)
tao_introns <- filterEvents(tao_events, types = c("IR"), N = 2)

# Christopher Azar 2021 data
christopher_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/Christopher_Physioreports_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
christopher_events <- getEvents(christopher_data, tool = "vast-tools") # Extract alternative splicing events
#christopher_events <- alternativeEvents(christopher_events, minPsi = 1, maxPsi = 99) # Filter events based on PSI thresholds
christopher_exons <- filterEvents(christopher_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 2)
christopher_introns <- filterEvents(christopher_events, types = c("IR"), N = 2)


# Dominic Data
dominic_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/Dominic_Frontiers_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
dominic_events <- getEvents(dominic_data, tool = "vast-tools") # Extract alternative splicing events
#dominic_events <- alternativeEvents(dominic_events, minPsi = 1, maxPsi = 99) # Filter events based on PSI thresholds
dominic_exons <- filterEvents(dominic_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 2)
dominic_introns <- filterEvents(dominic_events, types = c("IR"), N = 2)

# Kan Data
kan_data <- getDataset(pathTables = paste0(getwd(),"/inclusion_tables/kan_scientific_reports_INCLUSION_LEVELS_FULL-mm10.tab"), tool = "vast-tools")
kan_events <- getEvents(kan_data, tool = "vast-tools") # Extract alternative splicing events
#kan_events <- alternativeEvents(kan_events, minPsi = 1, maxPsi = 99) # Filter events based on PSI thresholds
kan_exons <- filterEvents(kan_events, types = c("C1", "C2", "C3", "S", "MIC"), N = 2)
kan_introns <- filterEvents(kan_events, types = c("IR"), N = 2)



```


## Metadata { .tabset}


### Tao

```{r metadata tao}
# Load metadata file containing sample information
metadata_tao <- read.csv(paste0(getwd(),"/metadata/tao_metadata.csv"), sep = ",")
DT::datatable(metadata_tao, options = list(pageLength = nrow(metadata_tao), scrollX = TRUE))
```

### Christopher

```{r metadata christopher}
# Load metadata file containing sample information
metadata_christopher <- read.csv(paste0(getwd(),"/metadata/christopher_metadata.csv"), sep = ",")
metadata_christopher$experiment_title <- gsub("Myoblasts", "0_days", metadata_christopher$experiment_title)
metadata_christopher$experiment_title <- gsub("Myotubes", "6_days", metadata_christopher$experiment_title)
DT::datatable(metadata_christopher, options = list(pageLength = nrow(metadata_christopher), scrollX = TRUE))
```

### Dominic

```{r metadata dominic}
# Load metadata file containing sample information
metadata_dominic <- read.csv(paste0(getwd(),"/metadata/dominic_metadata.csv"), sep = ",")
metadata_dominic$experiment_title <- gsub("Myoblasts", "0_days", metadata_dominic$experiment_title)
metadata_dominic$experiment_title <- gsub("Myotubes", "5_days", metadata_dominic$experiment_title)
DT::datatable(metadata_dominic, options = list(pageLength = nrow(metadata_dominic), scrollX = TRUE))
```

### Kan

```{r metadata kan}
# Load metadata file containing sample information
metadata_kan <- read.csv(paste0(getwd(),"/metadata/kan_metadata.csv"), sep = ",")
metadata_kan$experiment_title <- gsub("Myoblasts", "0_days", metadata_kan$experiment_title)
metadata_kan$experiment_title <- gsub("Myotubes", "5_days", metadata_kan$experiment_title)
DT::datatable(metadata_kan, options = list(pageLength = nrow(metadata_kan), scrollX = TRUE))
```


---

# Splicing & Sample Quality Checking

Splicing inclusion plots look like a ***U*** when looking at the *exons*, as normally most of them are spliced out completely (dPSI=0) or constitutively spliced in (dPSI=100), but some of them are in between and those are the most interesting for the analysis. On the other hand, *introns* are ussually not included (that is their definiiton), but in a few cases they are included. Thus, the intron plot looks like the exponential distribution.



## PCA Plot All Studies

As it can be seen, most dataframe sinclude only two conditions; *Myoblasts* or *Myotubes*, where Tao has different time points. However, all of them are clustered properly in the PCA plot. PCA was done on the PSI matrix of each study as they come out from *Vast Combine*.


```{r pca calculation, results='hide'}
# Subset and scale data
pca_tao <- tao_data[,  c("EVENT",tao_events$Samples)]
pca_christopher <- christopher_data[,  c("EVENT",christopher_events$Samples)]
pca_dominic <- dominic_data[,  c("EVENT",dominic_events$Samples)]
pca_kan <- kan_data[,  c("EVENT",kan_events$Samples)]
# merge pca data columns by row names
merged_pca <- pca_tao %>%
  left_join(pca_christopher, by="EVENT") %>%
  left_join(pca_dominic, by="EVENT") %>%
  left_join(pca_kan, by="EVENT") %>%
  na.omit()
rownames(merged_pca)<- merged_pca$EVENT
merged_pca<-t(merged_pca[,-1])

metadata_merged<-tibble(sample=c(metadata_tao$run_accession,metadata_christopher$run_accession,metadata_dominic$run_accession,metadata_kan$run_accession),experiment_title=c(metadata_tao$experiment_title,metadata_christopher$experiment_title,metadata_dominic$experiment_title,metadata_kan$experiment_title))

# Reorder metadata_merged$experiment_title based on the row names of merged_pca
condition_pca <- metadata_merged$experiment_title[match(rownames(merged_pca), metadata_merged$sample)]


pca_result <- prcomp(merged_pca)  # Perform PCA

# Prepare PCA results for plotting
pca_data <- as.data.frame(pca_result$x)
pca_data$Sample <- rownames(pca_data)
pca_data$condition<-condition_pca
pca_data$data_origin<-c(rep("Tao",ncol(pca_tao)-1),rep("Christopher",ncol(pca_christopher)-1),rep("Dominic",ncol(pca_dominic)-1),rep("Kan",ncol(pca_kan)-1))
```

```{r pca plotting}
# Create PCA plot
pca_plot <- ggplot(pca_data, aes(x = PC1, y = PC2, color = as.factor(condition), shape = as.factor(data_origin))) +
  geom_point(size = 6) +
  labs(
    title = "<b style='font-size:18px;'>PCA of Samples (PSI Data)</b>",
    x = paste("PC1 (", round(100 * summary(pca_result)$importance[2, 1], 1), "%)", sep = ""),
    y = paste("PC2 (", round(100 * summary(pca_result)$importance[2, 2], 1), "%)", sep = ""),
    caption = paste0("Created by AG on ", Sys.Date()), size=3
  ) +
  theme_minimal(base_family = "roboto") +
  theme(
    plot.title = element_markdown(),
    plot.title.position = "plot",
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.position = "right",
    legend.title = element_blank(),
    panel.background = element_rect(fill = "gray98"),
    panel.grid = element_line(color = "gray90", size = 0.5),
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_blank()
  ) +
  scale_colour_paletteer_d("tvthemes::Alexandrite") +
  coord_fixed()

pca_plot

```

## PCA Plot Only Tao

As it can be seen, most dataframe sinclude only two conditions; *Myoblasts* or *Myotubes*, where Tao has different time points. However, all of them are clustered properly in the PCA plot. PCA was done on the PSI matrix of each study as they come out from *Vast Combine*.


```{r pca calculation tao, results='hide'}
# Subset and scale data
pca_tao <- na.omit(tao_data[,  c("EVENT",tao_events$Samples)])


rownames(pca_tao)<- pca_tao$EVENT
pca_tao<-t(pca_tao[,-1])

metadata_merged<-tibble(sample=c(metadata_tao$run_accession),experiment_title=c(metadata_tao$experiment_title))

# Reorder metadata_merged$experiment_title based on the row names of merged_pca
condition_pca <- metadata_merged$experiment_title[match(rownames(pca_tao), metadata_merged$sample)]


pca_result <- prcomp(pca_tao)  # Perform PCA

# Prepare PCA results for plotting
pca_data <- as.data.frame(pca_result$x)
pca_data$Sample <- rownames(pca_data)
pca_data$condition<-condition_pca
```

```{r pca plotting tao}
# Create PCA plot
pca_plot <- ggplot(pca_data, aes(x = PC1, y = PC2, color = as.factor(condition))) +
  geom_point(size = 6) +
  labs(
    title = "<b style='font-size:18px;'>PCA of Tao Samples (PSI Data)</b>",
    x = paste("PC1 (", round(100 * summary(pca_result)$importance[2, 1], 1), "%)", sep = ""),
    y = paste("PC2 (", round(100 * summary(pca_result)$importance[2, 2], 1), "%)", sep = ""),
    caption = paste0("Created by AG on ", Sys.Date()), size=3
  ) +
  theme_minimal(base_family = "roboto") +
  theme(
    plot.title = element_markdown(),
    plot.title.position = "plot",
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.position = "right",
    legend.title = element_blank(),
    panel.background = element_rect(fill = "gray98"),
    panel.grid = element_line(color = "gray90", size = 0.5),
    panel.grid.major = element_line(color = "gray90", size = 0.5),
    panel.grid.minor = element_blank()
  ) +
  scale_colour_paletteer_d("lisa::OskarSchlemmer") +
  coord_fixed()

pca_plot

```

## Total Splicing Events

As it can be observed below, the dominic dataset has the highest number of splicing events, what can be explained by the higher number of reads (90M in myotubes and 140M in myoblasts).


```{r splicing events barplot stacked}

# Adjusted version of the script
splicing_events <- tibble(
  event_type = names(tao_events$EventsPerType),
  tao = tao_events$EventsPerType,
  christopher = christopher_events$EventsPerType,
  dominic = dominic_events$EventsPerType,
  kan = kan_events$EventsPerType
)

splicing_events_long <- splicing_events %>%
  pivot_longer(cols = c( tao, christopher, dominic, kan),
               names_to = "study", values_to = "count") %>%
  mutate(event_type = ifelse(event_type %in% c("C1", "C2", "C3", "ANN", "S", "MIC"), "EX", event_type)) %>%
  group_by(study, event_type) %>%
  summarize(count = sum(count, na.rm = TRUE), .groups = "drop")

# Proportion bar plot
plot_proportion <- ggplot(splicing_events_long, aes(fill = event_type, y = count, x = study)) +
  geom_bar(position = "fill", stat = "identity") +
  labs(
    title = "<b style='font-size:18px;'>Proportion of Splicing Events by Study</b>",
    x = NULL,
    y = "Proportion of Events",
    fill = "Event Type"
  ) +
  theme_minimal(base_family = font) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    plot.title = element_markdown(),
    panel.background = element_rect(fill = "gray98"),
    panel.grid = element_line(color = "gray90", size = 0.5)
  ) +
  scale_fill_paletteer_d("MetBrewer::Hokusai3")

splicing_events_long_sum<-splicing_events_long %>%
  dplyr::group_by(study) %>%
  summarize(count = sum(count))


# Absolute counts plot
plot_absolute <- ggplot(splicing_events_long_sum, aes(y = count, x = study)) +
  geom_point(color = "#C70039", size = 3) +
  geom_text(aes(label = count), vjust = -1, size = 4, check_overlap = TRUE) +
  labs(
    x = "Study",
    y = "Number of Events",
    caption = paste0("Created by AG on ", Sys.Date()), size=3
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "none",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text( size=15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3)
  ) +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.2)))


# Combine plots
combined_plot <- plot_proportion / plot_absolute +
  plot_layout(heights = c(1, 0.5)) &
  theme(plot.margin = margin(5,5, 0, 5))

# Display combined plot
combined_plot
```

```{r general stats}
vastdb_events<-read.table("EVENT_INFO-mm10.tab", header = TRUE, sep = "\t")
bin_exons <- function(n) {
  if (is.na(n)) return(NA) # Handle missing values
  else if (n < 6) return("1-5")
  else if (n < 11) return("6-10")
  else if (n < 21) return("11-20")
  else return("21+")
}

#subset vastdb events if they contin the word "EX" in the column EVENT
vastdb_exons<-vastdb_events[grep("EX", vastdb_events$EVENT),]
# Add exon group information
apply_bin_exons <- function(item) {
  gene_counts <- table(item$GENE) # Count exons per gene
  item$exon_group <- sapply(item$GENE, function(gene) bin_exons(gene_counts[gene]))
  item
}

vastdb_exons<-apply_bin_exons(vastdb_exons)

#subset vastdb events if they contin the word "EX" in the column EVENT
vastdb_introns<-vastdb_events[grep("IN", vastdb_events$EVENT),]
# Add exon group information
apply_bin_exons <- function(item) {
  gene_counts <- table(item$GENE) # Count exons per gene
  item$intron_group <- sapply(item$GENE, function(gene) bin_exons(gene_counts[gene]))
  item
}

vastdb_introns<-apply_bin_exons(vastdb_introns)

```


# Does the number of exons of a gene affect Inclusion? { .tabset}

First I classified the genes according to the number of exons they contain from VASTDB. Then I plotted the dPSI of all exons grouped by that classification.

## Exons { .tabset}

```{r inclusionumber of exons tao}
tao_exons_df<-na.omit(tao_exons$PSI)
tao_exons_df<-tao_exons_df[,c(colnames(tao_exons_df)[1:6],metadata_tao$run_accession)]
tao_exons_df$exon_group<-vastdb_exons$exon_group[match(tao_exons_df$EVENT,vastdb_exons$EVENT)]

```

### 7days vs 0 days

```{r 7 vs 0 exons}
# Function to compute the difference for a single dataframe
compute_difference <- function(df) {
  avg_7d <- rowMeans(df[, 16:18])
  avg_0d <- rowMeans(df[, 7:9])
  avg_7d - avg_0d
}

# Compute the difference and group by exon groups
tao_exons_df$difference <- compute_difference(tao_exons_df)

tao_exons_df$exon_group<-factor(tao_exons_df$exon_group, levels = c("1-5","6-10","11-20","21+"))
# Plot distribution of PSI difference for each exon group with fixed axis
plot_psi_distribution <- ggplot(
  na.omit(tao_exons_df[abs(tao_exons_df$difference) >= 10,]), 
  aes(y=..density..,x = difference, fill = ifelse(difference < 0, "Skipped", "Included"))
) +
  geom_histogram(bins = 50, position = "identity") +
  facet_wrap(~exon_group, scales = "fixed") +  # Change scales to "fixed"
  labs(
    title = "PSI Difference Distribution Grouped by Number of Exons present in a Gene",
    subtitle = "dPSI = avg_7d - avg_0d",
    x = "ΔPSI (DKO - WT)",
    y = "Density",
    fill = "|ΔPSI| >= 0.1",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1")


print(plot_psi_distribution)


```

### 4days vs 0 days

```{r 4 vs 0 exons}
# Function to compute the difference for a single dataframe
compute_difference <- function(df) {
  avg_4d <- rowMeans(df[, 13:15])
  avg_0d <- rowMeans(df[, 7:9])
  avg_4d - avg_0d
}

# Compute the difference and group by exon groups
tao_exons_df$difference <- compute_difference(tao_exons_df)

tao_exons_df$exon_group<-factor(tao_exons_df$exon_group, levels = c("1-5","6-10","11-20","21+"))
# Plot distribution of PSI difference for each exon group with fixed axis
plot_psi_distribution <- ggplot(
  na.omit(tao_exons_df[abs(tao_exons_df$difference) >= 10,]), 
  aes(y=..density..,x = difference, fill = ifelse(difference < 0, "Skipped", "Included"))
) +
  geom_histogram(bins = 50, position = "identity") +
  facet_wrap(~exon_group, scales = "fixed") +  # Change scales to "fixed"
  labs(
    title = "PSI Difference Distribution Grouped by Number of Exons present in a Gene",
    subtitle = "dPSI = avg_4d - avg_0d",
    x = "ΔPSI (DKO - WT)",
    y = "Density",
    fill = "|ΔPSI| >= 0.1",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1")


print(plot_psi_distribution)


```

### 7days vs 4 days

```{r 7 vs 4 exons}
# Function to compute the difference for a single dataframe
compute_difference <- function(df) {
  avg_4d <- rowMeans(df[, 13:15])
  avg_7d <- rowMeans(df[, 16:18])
  avg_7d - avg_4d
}

# Compute the difference and group by exon groups
tao_exons_df$difference <- compute_difference(tao_exons_df)

tao_exons_df$exon_group<-factor(tao_exons_df$exon_group, levels = c("1-5","6-10","11-20","21+"))
# Plot distribution of PSI difference for each exon group with fixed axis
plot_psi_distribution <- ggplot(
  na.omit(tao_exons_df[abs(tao_exons_df$difference) >= 10,]), 
  aes(y=..density..,x = difference, fill = ifelse(difference < 0, "Skipped", "Included"))
) +
  geom_histogram(bins = 50, position = "identity") +
  facet_wrap(~exon_group, scales = "fixed") +  # Change scales to "fixed"
  labs(
    title = "PSI Difference Distribution Grouped by Number of Exons present in a Gene",
    subtitle = "dPSI = avg_7d - avg_4d",
    x = "ΔPSI (DKO - WT)",
    y = "Density",
    fill = "|ΔPSI| >= 0.1",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1")


print(plot_psi_distribution)


```

### 4days vs 2 days

```{r 4 vs 2 exons}
# Function to compute the difference for a single dataframe
compute_difference <- function(df) {
  avg_4d <- rowMeans(df[, 13:15])
  avg_2d <- rowMeans(df[, 10:12])
  avg_4d - avg_2d
}

# Compute the difference and group by exon groups
tao_exons_df$difference <- compute_difference(tao_exons_df)

tao_exons_df$exon_group<-factor(tao_exons_df$exon_group, levels = c("1-5","6-10","11-20","21+"))
# Plot distribution of PSI difference for each exon group with fixed axis
plot_psi_distribution <- ggplot(
  na.omit(tao_exons_df[abs(tao_exons_df$difference) >= 10,]), 
  aes(y=..density..,x = difference, fill = ifelse(difference < 0, "Skipped", "Included"))
) +
  geom_histogram(bins = 50, position = "identity") +
  facet_wrap(~exon_group, scales = "fixed") +  # Change scales to "fixed"
  labs(
    title = "PSI Difference Distribution Grouped by Number of Exons present in a Gene",
    subtitle = "dPSI = avg_4d - avg_2d",
    x = "ΔPSI (DKO - WT)",
    y = "Density",
    fill = "|ΔPSI| >= 0.1",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1")


print(plot_psi_distribution)


```








# Differential Splicing Calculation

```{r aux_featuregroup}
# Extract unique groups and sample IDs
groupingVariable <- "experiment_title"

# Tao
groups_tao <- unique(metadata_tao[, groupingVariable])
samples_tao <- metadata_tao$run_accession

# Christopher
groups_christopher <- unique(metadata_christopher[, groupingVariable])
samples_christopher <- metadata_christopher$run_accession
# Dominic
groups_dominic <- unique(metadata_dominic[, groupingVariable])
samples_dominic <- metadata_dominic$run_accession

# Kan
groups_kan <- unique(metadata_kan[, groupingVariable])
samples_kan <- metadata_kan$run_accession

random_colors=c("#D8D97AFF", "#95C36EFF", "#74C8C3FF", "#5A97C1FF", "#295384FF", "#0A2E57FF")


# Create group list with metadata for Tao, Christopher, and Lyu
groupList_tao <- lapply(1:length(groups_tao), function(i) {
  list(
    name = groups_tao[i],
    samples = samples_tao[metadata_tao[, groupingVariable] == groups_tao[i]],
    color = random_colors[i]
  )
})
names(groupList_tao) <- groups_tao

groupList_christopher <- lapply(1:length(groups_christopher), function(i) {
  list(
    name = groups_christopher[i],
    samples = samples_christopher[metadata_christopher[, groupingVariable] == groups_christopher[i]],
    color = random_colors[i]
  )
})
names(groupList_christopher) <- groups_christopher


# Create group list with metadata
groupList_dominic <- lapply(1:length(groups_dominic), function(i) {
  list(
    name = groups_dominic[i],
    samples = samples_dominic[metadata_dominic[, groupingVariable] == groups_dominic[i]],
    color = random_colors[i]
  )
})
names(groupList_dominic) <- groups_dominic

# Create group list with metadata
groupList_kan <- lapply(1:length(groups_kan), function(i) {
  list(
    name = groups_kan[i],
    samples = samples_kan[metadata_kan[, groupingVariable] == groups_kan[i]],
    color = random_colors[i]
  )
})
names(groupList_kan) <- groups_kan
```

```{r groups_auxiliary}
# Define groups
groupA    <- "0_days"
groupB    <- "5_days"
groupA_tao<-"0_days"
groupB_tao<-"7_days"

groupB_christopher<-"6_days"



# For Tao
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_exons$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_exons$PSI, samplesB_tao)

# For Christopher
samplesA_christopher <- groupList_christopher[[groupA]]$samples
samplesB_christopher <- groupList_christopher[[groupB_christopher]]$samples
colsGroupA_christopher <- convertCols(christopher_exons$PSI, samplesA_christopher)
colsGroupB_christopher <- convertCols(christopher_exons$PSI, samplesB_christopher)



# Dominic
samplesA_dominic    <- groupList_dominic[[groupA]]$samples
samplesB_dominic   <- groupList_dominic[[groupB]]$samples
colsGroupA_dominic   <- convertCols(dominic_exons$PSI, samplesA_dominic)
colsGroupB_dominic    <- convertCols(dominic_exons$PSI, samplesB_dominic)

# Kan
samplesA_kan   <- groupList_kan[[groupA]]$samples
samplesB_kan   <- groupList_kan[[groupB]]$samples
colsGroupA_kan   <- convertCols(kan_exons$PSI, samplesA_kan)
colsGroupB_kan   <- convertCols(kan_exons$PSI, samplesB_kan)

set.seed(42) #Setting seed for downstream simulations of the beta distribution
```

## Exon Lists

### Calculations

```{r pdiff calculation}
groupA_tao<-"0_days"
groupB_tao<-"7_days"
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_exons$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_exons$PSI, samplesB_tao)


# Prepare table for Tao
tao_pdiff_exons <- prepareTableVolcanoFDR(
  psitable = tao_exons$PSI,
  qualtable = tao_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim=1000,
  seed = TRUE,
  CoverageWeight = FALSE
)

groupA_tao<-"0_days"
groupB_tao<-"2_days"
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_exons$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_exons$PSI, samplesB_tao)

tao_pdiff_exons_2d <- prepareTableVolcanoFDR(
  psitable = tao_exons$PSI,
  qualtable = tao_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim=1000,
  seed = TRUE,
  CoverageWeight = FALSE
)

groupA_tao<-"0_days"
groupB_tao<-"4_days"
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_exons$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_exons$PSI, samplesB_tao)

tao_pdiff_exons_4d <- prepareTableVolcanoFDR(
  psitable = tao_exons$PSI,
  qualtable = tao_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim=1000,
  seed = TRUE,
  CoverageWeight = FALSE
)

groupA_tao<-"2_days"
groupB_tao<-"4_days"
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_exons$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_exons$PSI, samplesB_tao)

tao_pdiff_exons_4dvs2d <- prepareTableVolcanoFDR(
  psitable = tao_exons$PSI,
  qualtable = tao_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim=1000,
  seed = TRUE,
  CoverageWeight = FALSE
)

groupA_tao<-"4_days"
groupB_tao<-"7_days"
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_exons$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_exons$PSI, samplesB_tao)

tao_pdiff_exons_7dvs4d <- prepareTableVolcanoFDR(
  psitable = tao_exons$PSI,
  qualtable = tao_exons$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim=1000,
  seed = TRUE,
  CoverageWeight = FALSE
)


write.csv(tao_pdiff_exons, "tao_pdiff_exons.csv")
write.csv(tao_pdiff_exons_2d,"tao_pdiff_exons_2d.csv")
write.csv(tao_pdiff_exons_4d,"tao_pdiff_exons_4d.csv")
write.csv(tao_pdiff_exons_4dvs2d,"tao_pdiff_exons_4dvs2d.csv")


groupA_tao<-"0_days"
groupB_tao<-"7_days"
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_introns$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_introns$PSI, samplesB_tao)


# Prepare table for Tao
tao_pdiff_introns <- prepareTableVolcanoFDR(
  psitable = tao_introns$PSI,
  qualtable = tao_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim=1000,
  seed = TRUE,
  CoverageWeight = FALSE
)

groupA_tao<-"0_days"
groupB_tao<-"2_days"
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_introns$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_introns$PSI, samplesB_tao)

tao_pdiff_introns_2d <- prepareTableVolcanoFDR(
  psitable = tao_introns$PSI,
  qualtable = tao_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim=1000,
  seed = TRUE,
  CoverageWeight = FALSE
)

groupA_tao<-"0_days"
groupB_tao<-"4_days"
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_introns$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_introns$PSI, samplesB_tao)

tao_pdiff_introns_4d <- prepareTableVolcanoFDR(
  psitable = tao_introns$PSI,
  qualtable = tao_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim=1000,
  seed = TRUE,
  CoverageWeight = FALSE
)

groupA_tao<-"2_days"
groupB_tao<-"4_days"
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_introns$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_introns$PSI, samplesB_tao)

tao_pdiff_introns_4dvs2d <- prepareTableVolcanoFDR(
  psitable = tao_introns$PSI,
  qualtable = tao_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim=1000,
  seed = TRUE,
  CoverageWeight = FALSE
)

groupA_tao<-"4_days"
groupB_tao<-"7_days"
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_introns$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_introns$PSI, samplesB_tao)

tao_pdiff_introns_7dvs4d <- prepareTableVolcanoFDR(
  psitable = tao_introns$PSI,
  qualtable = tao_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  nsim=1000,
  seed = TRUE,
  CoverageWeight = FALSE
)


write.csv(tao_pdiff_introns, "tao_pdiff_introns.csv")
write.csv(tao_pdiff_introns_2d,"tao_pdiff_introns_2d.csv")
write.csv(tao_pdiff_introns_4d,"tao_pdiff_introns_4d.csv")
write.csv(tao_pdiff_introns_4dvs2d,"tao_pdiff_introns_4dvs2d.csv")

```




### FDR Volcano Plots { .tabset}

Volcano Plots of the FDR corrected exons for each study. In pink are the exons with a deltaPSI>=0.1.



#### Tao

```{r tao fdr volcano 4 days}

# INtersecting dhared exons between 10mm vs control and 1mm vs control
differential_exons_2d<-na.omit(tao_pdiff_exons_2d[tao_pdiff_exons_2d$FDR >= 0.90 & abs(tao_pdiff_exons_2d$deltapsi) >= 0.1,])
differential_exons_4d<-na.omit(tao_pdiff_exons_4d[tao_pdiff_exons_4d$FDR >= 0.90 & abs(tao_pdiff_exons_4d$deltapsi) >= 0.1,])
differential_exons_4dvs2d<-na.omit(tao_pdiff_exons_4dvs2d[tao_pdiff_exons_4dvs2d$Pdiff >= 0.90 & abs(tao_pdiff_exons_4dvs2d$deltapsi) >= 0.1,])
differential_exons_7dvs4d<-na.omit(tao_pdiff_exons_7dvs4d[tao_pdiff_exons_7dvs4d$Pdiff >= 0.90 & abs(tao_pdiff_exons_7dvs4d$deltapsi) >= 0.1,])

shared_exons<-differential_exons_4d$EVENT[differential_exons_4d$EVENT %in% differential_exons_2d$EVENT]
# Volcano plot
library(ggrepel)
tao_pdiff_exons_4d<-na.omit(tao_pdiff_exons_4d)
# Add a Shared column based on the shared_exons
tao_pdiff_exons_4d$Shared <- ifelse(tao_pdiff_exons_4d$EVENT %in% shared_exons, "Shared", "Not Shared")

# Classify significance
tao_pdiff_exons_4d$Significant <- ifelse(
  tao_pdiff_exons_4d$Pdiff >= 0.90 & tao_pdiff_exons_4d$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    tao_pdiff_exons_4d$Pdiff >= 0.90 & tao_pdiff_exons_4d$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
tao_pdiff_exons_4d$negLogpvalue <- -log10(1 - tao_pdiff_exons_4d$Pdiff)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(tao_pdiff_exons_4d, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](1 - Pdiff)),
    title = "(4 Days - 0 Days) Exons",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot
```

```{r tao fdr volcano 2 days}

tao_pdiff_exons_2d<-na.omit(tao_pdiff_exons_2d)
# Add a Shared column based on the shared_exons
tao_pdiff_exons_2d$Shared <- ifelse(tao_pdiff_exons_2d$EVENT %in% shared_exons, "Shared", "Not Shared")

# Classify significance
tao_pdiff_exons_2d$Significant <- ifelse(
  tao_pdiff_exons_2d$Pdiff >= 0.90 & tao_pdiff_exons_2d$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    tao_pdiff_exons_2d$Pdiff >= 0.90 & tao_pdiff_exons_2d$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
tao_pdiff_exons_2d$negLogpvalue <- -log10(1 - tao_pdiff_exons_2d$Pdiff)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(tao_pdiff_exons_2d, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](1 - Pdiff)),
    title = "(2 Days - 0 Days) Exons",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot
```

```{r tao fdr volcano 4 to 2 days}

tao_pdiff_exons_4dvs2d<-na.omit(tao_pdiff_exons_4dvs2d)
# Add a Shared column based on the shared_exons
tao_pdiff_exons_4dvs2d$Shared <- ifelse(tao_pdiff_exons_4dvs2d$EVENT %in% shared_exons, "Shared", "Not Shared")

# Classify significance
tao_pdiff_exons_4dvs2d$Significant <- ifelse(
  tao_pdiff_exons_4dvs2d$Pdiff >= 0.90 & tao_pdiff_exons_4dvs2d$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    tao_pdiff_exons_4dvs2d$Pdiff >= 0.90 & tao_pdiff_exons_4dvs2d$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
tao_pdiff_exons_4dvs2d$negLogpvalue <- -log10(1 - tao_pdiff_exons_4dvs2d$Pdiff)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(tao_pdiff_exons_4dvs2d, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](1 - Pdiff)),
    title = "(4 Days - 2 Days) Exons",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot
```


```{r tao fdr volcano 7 vs 4 days}

tao_pdiff_exons_7dvs4d<-na.omit(tao_pdiff_exons_7dvs4d)
# Add a Shared column based on the shared_exons
tao_pdiff_exons_7dvs4d$Shared <- FALSE

# Classify significance
tao_pdiff_exons_7dvs4d$Significant <- ifelse(
  tao_pdiff_exons_7dvs4d$Pdiff >= 0.90 & tao_pdiff_exons_7dvs4d$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    tao_pdiff_exons_7dvs4d$Pdiff >= 0.90 & tao_pdiff_exons_7dvs4d$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
tao_pdiff_exons_7dvs4d$negLogpvalue <- -log10(1 - tao_pdiff_exons_7dvs4d$Pdiff)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(tao_pdiff_exons_7dvs4d, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared exons
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared exons
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](1 - Pdiff)),
    title = "(7 Days - 4 Days) Exons",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot
```

### Individual Combination Tables { .tabset}

These tables show the Exons that show a FDR<=0.05 and PDiff (1-pvalue)>=0.95 in the pairwise comparison of Myotubes-Myoblasts, for each study.

#### Tao


```{r tao combination table}
# Render DataTable with enhancements
datatable(
  tao_pdiff_exons,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)


```


## Intron Lists

### Calculations

```{r pdiff intron calculation}

# Prepare table for Tao
tao_pdiff_introns <- prepareTableVolcano(
  psitable = tao_introns$PSI,
  qualtable = tao_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  seed = TRUE,
  CoverageWeight = FALSE
)

groupA_tao<-"0_days"
groupB_tao<-"2_days"
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_introns$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_introns$PSI, samplesB_tao)

tao_pdiff_introns_2d <- prepareTableVolcano(
  psitable = tao_introns$PSI,
  qualtable = tao_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  seed = TRUE,
  CoverageWeight = FALSE
)

groupA_tao<-"0_days"
groupB_tao<-"4_days"
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_introns$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_introns$PSI, samplesB_tao)

tao_pdiff_introns_4d <- prepareTableVolcano(
  psitable = tao_introns$PSI,
  qualtable = tao_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  seed = TRUE,
  CoverageWeight = FALSE
)

groupA_tao<-"2_days"
groupB_tao<-"4_days"
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_introns$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_introns$PSI, samplesB_tao)

tao_pdiff_introns_4dvs2d <- prepareTableVolcano(
  psitable = tao_introns$PSI,
  qualtable = tao_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  seed = TRUE,
  CoverageWeight = FALSE
)

groupA_tao<-"4_days"
groupB_tao<-"7_days"
samplesA_tao <- groupList_tao[[groupA_tao]]$samples
samplesB_tao <- groupList_tao[[groupB_tao]]$samples
colsGroupA_tao <- convertCols(tao_introns$PSI, samplesA_tao)
colsGroupB_tao <- convertCols(tao_introns$PSI, samplesB_tao)

tao_pdiff_introns_7dvs4d <- prepareTableVolcano(
  psitable = tao_introns$PSI,
  qualtable = tao_introns$Qual,
  npoints = 500,
  colsA = colsGroupA_tao,
  colsB = colsGroupB_tao,
  labA = groupA_tao,
  labB = groupB_tao,
  basalColor = "#89C0AE",
  interestColor = "#E69A9C",
  maxDevTable = maxDevSimulationN100,
  seed = TRUE,
  CoverageWeight = FALSE
)


write.csv(tao_pdiff_introns, "tao_pdiff_introns.csv")
write.csv(tao_pdiff_introns_2d,"tao_pdiff_introns_2d.csv")
write.csv(tao_pdiff_introns_4d,"tao_pdiff_introns_4d.csv")
write.csv(tao_pdiff_introns_4dvs2d,"tao_pdiff_introns_4dvs2d.csv")



```




### FDR Volcano Plots { .tabset}

Volcano Plots of the FDR corrected introns for each study. In pink are the exons with a deltaPSI>=0.1.



#### Tao

```{r tao fdr volcano 4 days}

# INtersecting dhared introns between 10mm vs control and 1mm vs control
differential_introns_2d<-na.omit(tao_pdiff_introns_2d[tao_pdiff_introns_2d$Pdiff >= 0.90 & abs(tao_pdiff_introns_2d$deltapsi) >= 0.1,])
differential_introns_4d<-na.omit(tao_pdiff_introns_4d[tao_pdiff_introns_4d$Pdiff >= 0.90 & abs(tao_pdiff_introns_4d$deltapsi) >= 0.1,])
differential_introns_4dvs2d<-na.omit(tao_pdiff_introns_4dvs2d[tao_pdiff_introns_4dvs2d$Pdiff >= 0.90 & abs(tao_pdiff_introns_4dvs2d$deltapsi) >= 0.1,])
differential_introns_7dvs4d<-na.omit(tao_pdiff_introns_7dvs4d[tao_pdiff_introns_7dvs4d$Pdiff >= 0.90 & abs(tao_pdiff_introns_7dvs4d$deltapsi) >= 0.1,])

shared_introns<-differential_introns_4d$EVENT[differential_introns_4d$EVENT %in% differential_introns_2d$EVENT]
# Volcano plot
library(ggrepel)
tao_pdiff_introns_4d<-na.omit(tao_pdiff_introns_4d)
# Add a Shared column based on the shared_introns
tao_pdiff_introns_4d$Shared <- ifelse(tao_pdiff_introns_4d$EVENT %in% shared_introns, "Shared", "Not Shared")

# Classify significance
tao_pdiff_introns_4d$Significant <- ifelse(
  tao_pdiff_introns_4d$Pdiff >= 0.90 & tao_pdiff_introns_4d$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    tao_pdiff_introns_4d$Pdiff >= 0.90 & tao_pdiff_introns_4d$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
tao_pdiff_introns_4d$negLogpvalue <- -log10(1 - tao_pdiff_introns_4d$Pdiff)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(tao_pdiff_introns_4d, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared introns
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared introns
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](1 - Pdiff)),
    title = "(4 Days - 0 Days) Introns",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot
```


```{r tao fdr volcano 2 days}

tao_pdiff_introns_2d<-na.omit(tao_pdiff_introns_2d)
# Add a Shared column based on the shared_introns
tao_pdiff_introns_2d$Shared <- ifelse(tao_pdiff_introns_2d$EVENT %in% shared_introns, "Shared", "Not Shared")

# Classify significance
tao_pdiff_introns_2d$Significant <- ifelse(
  tao_pdiff_introns_2d$Pdiff >= 0.90 & tao_pdiff_introns_2d$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    tao_pdiff_introns_2d$Pdiff >= 0.90 & tao_pdiff_introns_2d$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
tao_pdiff_introns_2d$negLogpvalue <- -log10(1 - tao_pdiff_introns_2d$Pdiff)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(tao_pdiff_introns_2d, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared introns
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared introns
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](1 - Pdiff)),
    title = "(2 Days - 0 Days) Introns",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot
```

```{r tao fdr volcano 4 to 2 days}

tao_pdiff_introns_4dvs2d<-na.omit(tao_pdiff_introns_4dvs2d)
# Add a Shared column based on the shared_introns
tao_pdiff_introns_4dvs2d$Shared <- ifelse(tao_pdiff_introns_4dvs2d$EVENT %in% shared_introns, "Shared", "Not Shared")

# Classify significance
tao_pdiff_introns_4dvs2d$Significant <- ifelse(
  tao_pdiff_introns_4dvs2d$Pdiff >= 0.90 & tao_pdiff_introns_4dvs2d$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    tao_pdiff_introns_4dvs2d$Pdiff >= 0.90 & tao_pdiff_introns_4dvs2d$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
tao_pdiff_introns_4dvs2d$negLogpvalue <- -log10(1 - tao_pdiff_introns_4dvs2d$Pdiff)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(tao_pdiff_introns_4dvs2d, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared introns
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared introns
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](1 - Pdiff)),
    title = "(4 Days - 2 Days) Introns",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot
```

```{r tao fdr volcano 7 to 4 days}

tao_pdiff_introns_7dvs4d<-na.omit(tao_pdiff_introns_7dvs4d)
# Add a Shared column based on the shared_introns
tao_pdiff_introns_7dvs4d$Shared <- ifelse(tao_pdiff_introns_7dvs4d$EVENT %in% shared_introns, "Shared", "Not Shared")

# Classify significance
tao_pdiff_introns_7dvs4d$Significant <- ifelse(
  tao_pdiff_introns_7dvs4d$Pdiff >= 0.90 & tao_pdiff_introns_7dvs4d$deltapsi >= 0.1, "Overrepresented",
  ifelse(
    tao_pdiff_introns_7dvs4d$Pdiff >= 0.90 & tao_pdiff_introns_7dvs4d$deltapsi <= -0.1, "Underrepresented",
    "Not Significant"
  )
)

# Convert FDR to -log10 scale for y-axis
tao_pdiff_introns_7dvs4d$negLogpvalue <- -log10(1 - tao_pdiff_introns_7dvs4d$Pdiff)


# Updated volcano plot with improved fonts and axis styling
volcano_plot <- ggplot(tao_pdiff_introns_7dvs4d, aes(x = deltapsi, y = negLogpvalue)) +
  geom_point(aes(
    color = ifelse(Shared == "Shared", "Shared", Significant),
    alpha = ifelse(Shared == "Shared", "Shared", Significant),
    size = ifelse(Shared == "Shared", "Shared", Significant)
  )) +
  scale_color_manual(values = c(
    "Shared" = "yellow",
    "Overrepresented" = "#E00E73",
    "Underrepresented" = "#3E2672",
    "Not Significant" = "gray"
  )) +
  scale_alpha_manual(values = c(
    "Shared" = 1.0,  # Fully opaque for shared introns
    "Overrepresented" = 0.6,
    "Underrepresented" = 0.6,
    "Not Significant" = 0.3
  )) +
  scale_size_manual(values = c(
    "Shared" = 3,  # Larger size for shared introns
    "Overrepresented" = 2,
    "Underrepresented" = 2,
    "Not Significant" = 1
  )) +
  labs(
    x = "Delta PSI",
    y = expression(-log[10](1 - Pdiff)),
    title = "(7 Days - 4 Days) Introns",
    subtitle = "Shared events are highlighted in golden"
  ) +
  theme_minimal(base_size = 14, base_family = "sans") +  # Set base font
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 18, face = "bold", color = "black"
    ),  # Centered and bold title
    plot.subtitle = element_text(
      hjust = 0.5, size = 14, face = "italic", color = "gray30"
    ),  # Italicized subtitle
    axis.text = element_text(size = 12, color = "black"),  # Axis text styling
    axis.title = element_text(size = 14, face = "bold", color = "black"),  # Axis title styling
    legend.text = element_text(size = 12),  # Larger legend text
    legend.title = element_blank(),  # Remove legend title
    panel.grid.major = element_line(color = "gray90"),  # Subtle grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add border to plot area
  ) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))  # Extend y-axis dynamically

# Display the plot
volcano_plot
```

### Individual Combination Tables { .tabset}

These tables show the Introns that show a FDR<=0.05 and PDiff (1-pvalue)>=0.95 in the pairwise comparison of Myotubes-Myoblasts, for each study.


#### Tao


```{r tao combination intron table}
# Render DataTable with enhancements
datatable(
  tao_intron_combination_tab,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
) %>%
  formatStyle(
    columns = "Pdiff",
    color = styleInterval(0.99, c("black", "green")),
    fontWeight = styleEqual(0.99, "bold")  # Ensure consistent styling
  ) %>%
  formatStyle(
  columns = "deltapsi",
  color = styleInterval(c(-0.5, 0.5), c("black", "red", "black")),  # Three colors for two intervals
  fontWeight = styleInterval(c(-0.5, 0.5), c("normal", "bold", "normal"))  # Three weights for two intervals
)

```


# PSI Distribution Plots { .tabset}

These plots aim to explore any enrichment of either (intron/exon) retention or (intron/exon) exclusion. Symmetric plots show that inclusion and retention are equally common between conditions. Only showing events with |dPSI|>=0.1 for higher clarity. Transparency shows different studies.

```{r splicing distribution plot, fig.width=10}

# List of dataframes with metadata
dfs <- list(
  list(df = differential_exons_4d, group = "Exons", study = "Tao"),
  list(df = differential_introns_4d, group = "Introns", study = "Tao")
)

# Add metadata columns to each dataframe beforehand
dfs_with_metadata <- lapply(dfs, function(x) {
  x$df %>%
    mutate(Group = x$group, Study = x$study)
})

# Combine all dataframes into one using bind_rows() for faster merging
final_df <- bind_rows(dfs_with_metadata) %>%
  dplyr::select(EVENT, Group, Study, deltapsi) %>%
  dplyr::filter(abs(deltapsi)>=0.1) %>%
  na.omit()# Adjust this line if other columns should be prioritized


plot_psi_distribution <- ggplot(final_df, aes(y=..density..,x = deltapsi, fill = ifelse(deltapsi < 0, "Skipped", "Included"))) +
  geom_histogram( bins = 50, position = "identity") +
  labs(
    title = "PSI Distribution",
    x = "ΔPSI (Myotubes-Myoblasts)",
    y = "Density",
    fill = "|ΔPSI| >= 0.1",
    caption = paste0("Created by AG on ", Sys.Date())
  ) +
  theme_minimal(base_family = font) +
  theme(
    legend.position = "right",
    axis.title.x = element_text(margin = margin(t = 10)),
    axis.text.x = element_text(size = 15),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "gray80", size = 0.5),
    panel.grid.minor = element_line(color = "gray95", size = 0.3),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1.5, "lines")  # Increase the distance between facets
  ) +
  scale_fill_brewer(palette = "Set1") +
  facet_wrap(~Group)

plot_psi_distribution
```


```{r loading data from vastdb}
events_info<-read.table("EVENT_INFO-mm10.tab", header = TRUE, sep = "\t")
splice_scores<-read.table("SPLICE_SITE_SCORES-mm10.tab", header = FALSE, sep = "\t")
```



# Sorting Out according to features

```{r gc content function}
calculate_GC_percent <- function(df, sequence_column) {
  # Ensure the specified column exists
  if (!sequence_column %in% colnames(df)) {
    stop("The specified column does not exist in the dataframe.")
  }

  # Function to calculate GC content for a single sequence
  gc_content <- function(sequence) {
    # Count G and C in the sequence
    gc_count <- sum(tolower(strsplit(sequence, NULL)[[1]]) %in% c('g', 'c'))
    # Calculate the GC percentage
    gc_percentage <- (gc_count / nchar(sequence)) * 100
    return(gc_percentage)
  }

  # Apply the GC content function to each row's sequence
  df$GC_percent <- sapply(df[[sequence_column]], gc_content)

  return(df)
}
```

```{r splice score site extraction function}
# Function to extract V3 values based on EVENT
extract_V3_for_event <- function(event_value, splice_scores) {
  # Filter rows where V1 matches the event_value
  filtered_rows <- splice_scores %>%
    filter(V1 == event_value)

  # Extract the V3 column and return as a list
  return(list(filtered_rows$V3))
}

```


```{r final list features extraction}
# Exon List features
differential_exons_4d$sequence<-events_info$Seq_A[match(differential_exons_4d$EVENT, events_info$EVENT)]

differential_exons_4d$splice_scores <- apply(differential_exons_4d, 1, function(row) {
  # Get the event value from the current row
  event_value <- row["EVENT"]

  # Call the function to extract the V3 values
  extract_V3_for_event(event_value, splice_scores)
})

# Unnest the list in V3_values into two separate columns
differential_exons_4d <- differential_exons_4d %>%
  unnest(cols = splice_scores) %>%
  separate(splice_scores, into = c("splice_score_3", "splice_score_5"), sep = ",")

# If necessary, clean up the new columns
differential_exons_4d$splice_score_3 <- gsub("[c()]", "", differential_exons_4d$splice_score_3)
differential_exons_4d$splice_score_5 <- gsub("[c()]", "", differential_exons_4d$splice_score_5)
differential_exons_4d$splice_score_3 <- as.numeric(differential_exons_4d$splice_score_3)
differential_exons_4d$splice_score_5 <- as.numeric(differential_exons_4d$splice_score_5)

differential_exons_4d<-calculate_GC_percent(differential_exons_4d,"sequence")

# Intron List features
differential_introns_4d$sequence<-events_info$Seq_A[match(differential_introns_4d$EVENT, events_info$EVENT)]

differential_introns_4d$splice_scores <- apply(differential_introns_4d, 1, function(row) {
  # Get the event value from the current row
  event_value <- row["EVENT"]

  # Call the function to extract the V3 values
  extract_V3_for_event(event_value, splice_scores)
})

# Unnest the list in V3_values into two separate columns
differential_introns_4d <- differential_introns_4d %>%
  unnest(cols = splice_scores) %>%
  separate(splice_scores, into = c("splice_score_3", "splice_score_5"), sep = ",")

# If necessary, clean up the new columns
differential_introns_4d$splice_score_3 <- gsub("[c()]", "", differential_introns_4d$splice_score_3)
differential_introns_4d$splice_score_5 <- gsub("[c()]", "", differential_introns_4d$splice_score_5)
differential_introns_4d$splice_score_3 <- as.numeric(differential_introns_4d$splice_score_3)
differential_introns_4d$splice_score_5 <- as.numeric(differential_introns_4d$splice_score_5)

differential_introns_4d<-calculate_GC_percent(differential_introns_4d,"sequence")

```




## Enrichment Analysis with EnrichR of Candidate Genes { .tabset}


```{r pladb enrichr}
enrichdata<-enrichr(unique(c(differential_exons_4d$GENE,differential_introns_4d$GENE)), databases = c("GO_Biological_Process_2023","GO_Cellular_Component_2023","GO_Molecular_Function_2023"))

```

### GO Biological Process

```{r pladb bioprocess, fig.width=10, fig.height=8}
plotEnrich(enrichdata[[1]])
```

### GO Cellular Component

```{r pladb cellcomponent, fig.width=10, fig.height=8}
plotEnrich(enrichdata[[2]])
```


### GO Molecular Function

```{r pladb molfunction, fig.width=10, fig.height=8}
plotEnrich(enrichdata[[3]])
```


```{r ENTREZ}
exon_go <- bitr(differential_exons_4d$GENE, fromType = "ALIAS", toType = "ENTREZID", OrgDb = org.Mm.eg.db)
names(exon_go)<-c("GENE","ENTREZID")
differential_exons_4d <- differential_exons_4d %>%
  left_join(as.data.frame(exon_go), by = "GENE")

intron_go <- bitr(differential_introns_4d$GENE, fromType = "ALIAS", toType = "ENTREZID", OrgDb = org.Mm.eg.db)
names(intron_go)<-c("GENE","ENTREZID")
differential_introns_4d <- differential_introns_4d %>%
  left_join(as.data.frame(intron_go), by = "GENE")




```


## Speckle Gene Groups

```{r Wun et al. list of genes}
groupA_genelist <- read_excel("Table S1_GroupABC gene list.xlsx",
    sheet = "Group A", skip = 1)[,-1]$Geneid %>%
  lapply(function(x) gsub("\\.\\d+", "", x)) %>%
  unlist()

groupB_genelist <- read_excel("Table S1_GroupABC gene list.xlsx",
    sheet = "Group B")[,-1]$Geneid %>%
  lapply(function(x) gsub("\\.\\d+", "", x)) %>%
  unlist()

groupC_genelist <- read_excel("Table S1_GroupABC gene list.xlsx",
    sheet = "Group C")[,-1]$Geneid %>%
  lapply(function(x) gsub("\\.\\d+", "", x)) %>%
  unlist()



human = useMart("ensembl", dataset = "hsapiens_gene_ensembl")
attributes = c("ensembl_gene_id", "mmusculus_homolog_ensembl_gene", "mmusculus_homolog_perc_id_r1")
orth.mouse = getBM(attributes, values=TRUE, mart = human, uniqueRows=TRUE)

groupA_genelist_mouse <- orth.mouse[orth.mouse$ensembl_gene_id %in% groupA_genelist, "mmusculus_homolog_ensembl_gene"] %>%
  unlist()
groupB_genelist_mouse <- orth.mouse[orth.mouse$ensembl_gene_id %in% groupB_genelist, "mmusculus_homolog_ensembl_gene"] %>%
  unlist()
groupC_genelist_mouse <- orth.mouse[orth.mouse$ensembl_gene_id %in% groupC_genelist, "mmusculus_homolog_ensembl_gene"] %>%
  unlist()

groupA_genelist_mouse <- bitr(groupA_genelist_mouse, fromType = "ENSEMBL", toType = "ENTREZID", OrgDb = org.Mm.eg.db)
groupB_genelist_mouse <- bitr(groupB_genelist_mouse, fromType = "ENSEMBL", toType = "ENTREZID", OrgDb = org.Mm.eg.db)
groupC_genelist_mouse <- bitr(groupC_genelist_mouse, fromType = "ENSEMBL", toType = "ENTREZID", OrgDb = org.Mm.eg.db)

# Exon list analysis
differential_exons_4d$GroupA <- ifelse(differential_exons_4d$ENTREZID %in% groupA_genelist_mouse$ENTREZID, TRUE, FALSE)

differential_exons_4d$GroupB <- ifelse(differential_exons_4d$ENTREZID %in% groupB_genelist_mouse$ENTREZID, TRUE, FALSE)

differential_exons_4d$GroupC <- ifelse(differential_exons_4d$ENTREZID %in% groupC_genelist_mouse$ENTREZID, TRUE, FALSE)

# Intron list analysis
differential_introns_4d$GroupA <- ifelse(differential_introns_4d$ENTREZID %in% groupA_genelist_mouse$ENTREZID, TRUE, FALSE)

differential_introns_4d$GroupB <- ifelse(differential_introns_4d$ENTREZID %in% groupB_genelist_mouse$ENTREZID, TRUE, FALSE)

differential_introns_4d$GroupC <- ifelse(differential_introns_4d$ENTREZID %in% groupC_genelist_mouse$ENTREZID, TRUE, FALSE)






splice_factors<-read_xlsx("SFs_list_ensembl_ID.xlsx")

differential_exons_4d$splicing_factor<-tolower(differential_exons_4d$GENE) %in% tolower(splice_factors$symbol)
differential_introns_4d$splicing_factor<-tolower(differential_introns_4d$GENE) %in% tolower(splice_factors$symbol)

speckle_protein<-read_tsv("nuclear_speckles_protein_human_atlas.tsv")

differential_exons_4d$HPA_speckle_protein<-tolower(differential_exons_4d$GENE) %in% tolower(speckle_protein$Gene)
differential_introns_4d$HPA_speckle_protein<-tolower(differential_introns_4d$GENE) %in% tolower(speckle_protein$Gene)

mouse_tf <- read_excel("mouse_tf.xlsx", 
    sheet = "TFs_Mouse")

differential_exons_4d$transcription_factor<-tolower(differential_exons_4d$GENE) %in% tolower(mouse_tf$`Gene Symbol`)
differential_introns_4d$transcription_factor<-tolower(differential_introns_4d$GENE) %in% tolower(mouse_tf$`Gene Symbol`)


speckle_introns_go <- enrichdata$GO_Biological_Process_2023[
  grepl("RNA|Cell Cycle|Translation", enrichdata$GO_Biological_Process_2023$Term, ignore.case = TRUE), 
]

# Extract and split the genes into a single vector
speckle_introns_go_genes <- unique(unlist(strsplit(speckle_introns_go$Genes, ";")))
differential_exons_4d$intron_speckle_go<-tolower(differential_exons_4d$GENE) %in% tolower(speckle_introns_go_genes)
differential_introns_4d$intron_speckle_go<-tolower(differential_introns_4d$GENE) %in% tolower(speckle_introns_go_genes)


```


# Rbfox2 Splicing Analysis

```{r final arrange exons}
differential_exons_4d <- differential_exons_4d[!duplicated(differential_exons_4d$EVENT), ] %>%
  arrange(desc(GroupB),desc(intron_speckle_go),desc(abs(deltapsi)),GroupC)


event_list_corr<-c(differential_exons_4d$splicing_factor,differential_introns_4d$splicing_factor)
correlation_matrix<-rbind(differential_exons_4d[,-c(3:6,19:34)],differential_introns_4d[,-c(3:6,19:34)])



correlation_matrix<-correlation_matrix[, c(colnames(correlation_matrix)[1:2], metadata_tao$run_accession)]
subset_genes <- correlation_matrix[event_list_corr, ]
rest_genes <- correlation_matrix[!event_list_corr, ]
subset_matrix <- as.matrix(subset_genes[, 3:14])
rest_matrix <- as.matrix(rest_genes[, 3:14])


results <- data.frame(
  Gene1 = character(),
  Gene2 = character(),
  Correlation = numeric(),
  P_value = numeric(),
  Adjusted_P_value = numeric(),
  stringsAsFactors = FALSE
)

# Compute correlations and p-values
all_p_values <- c()
for (i in 1:nrow(subset_matrix)) {
  for (j in 1:nrow(rest_matrix)) {
    # Perform correlation test
    test <- cor.test(subset_matrix[i, ], rest_matrix[j, ], method = "pearson")
    
    # Store the raw p-values for later adjustment
    all_p_values <- c(all_p_values, test$p.value)
    
    # Temporarily store the results (to be adjusted later)
    results <- rbind(results, data.frame(
      Gene1 = subset_genes$GENE[i],
      Gene2 = rest_genes$GENE[j],
      Correlation = test$estimate,
      P_value = test$p.value,
      Adjusted_P_value = NA  # Placeholder for the adjusted p-value
    ))
  }
}

# Apply multiple testing correction (Benjamini-Hochberg)
adjusted_p_values <- p.adjust(all_p_values, method = "BH")

# Update the results data frame with adjusted p-values
results$Adjusted_P_value <- adjusted_p_values

# Filter significant results (adjusted p-value < 0.05)
significant_results <- results[results$Adjusted_P_value < 0.01 & abs(results$Correlation) >=0.9, ]

# Plot heatmap
corr_plot<-ggplot(significant_results, aes(x = Gene1, y = Gene2, fill = Correlation)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red", midpoint = 0,
    name = "Correlation"
  ) +
  labs(
    title = "Significant Correlations of Splicing",
    x = "Splicing Factors",
    y = "Splicing Events"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text.y = element_text(size = 0)
  ) 

corr_plot


# Assign numeric indices to non-splicing factor genes
gene2_index <- data.frame(Gene2 = unique(significant_results$Gene2))
gene2_index$Index <- 1:nrow(gene2_index)

# Merge with significant results
plot_data <- significant_results %>%
  left_join(gene2_index, by = "Gene2") %>%
  group_by(Gene1) %>%
  arrange(Index) %>%
  mutate(Cumulative_Count = row_number())

# Generate a sufficient number of colors
num_genes <- length(unique(plot_data$Gene1))
palette_colors <- colorRampPalette(RColorBrewer::brewer.pal(8, "Set2"))(num_genes) 

# Create the plot
corr_plot <- ggplot(plot_data, aes(x = Index, y = Cumulative_Count, group = Gene1, color = Gene1)) +
  geom_line(size = 2) +  # Thicker lines for visibility
  labs(
    title = "Cumulative Significant Interactions per Splicing Factor",
    x = "Significant Splicing Events in Myogenesis",
    y = "Cumulative Count of SFs Interactions"
  ) +
  theme_classic(base_size = 16) +  # Increase base size for readability
  theme(
    text = element_text(family = "Source Sans Pro"),  # Set font
    axis.title = element_text(size = 18, face = "bold"),  # Make axis titles more visible
    axis.text = element_text(size = 14),
    plot.title = element_text(size = 22, face = "bold", hjust = 0.5),
    legend.position = "none"  # Remove legend
  ) +
  scale_color_manual(values = palette_colors) +  # Dynamically apply colors
  geom_text_repel(data = plot_data %>% group_by(Gene1) %>% slice_tail(n = 1),
                  aes(label = Gene1), 
                  size = 5, hjust = -0.2, fontface = "bold") +
  annotate("text", x = max(plot_data$Index) * 0.1, y = max(plot_data$Cumulative_Count) * 0.9,
           label = "Interaction defined as:\nPearson index > 0.9\nFDR < 0.01",
           size = 7, hjust = 0, fontface = "italic", family = "Source Sans Pro")  

# Print the plot
print(corr_plot)
```

```{r rbfox characteristics gc}
rbfox_genes<-significant_results$Gene2[significant_results$Gene1 =="Rbfox2"]
all_events_4d<-rbind(differential_exons_4d,differential_introns_4d)





# Separate non-Rbfox events
non_rbfox_introns <-  differential_introns_4d %>%
  filter(!GENE %in% c("Rbfox2",rbfox_genes)) %>% 
  mutate(Group = "Non-Rbfox")

# Combine data for plotting
rbfox_introns <- differential_introns_4d %>%
  filter(GENE %in% c("Rbfox2",rbfox_genes)) %>% 
  mutate(Group = "Rbfox")

combined_data <- rbind(rbfox_introns, non_rbfox_introns)

rbfox_introns_filtered<-filter(combined_data, LENGTH<=7000, deltapsi>0)
# Perform ANOVA
anova_result <- aov(GC_percent ~ intron_speckle_go, data = differential_introns_4d)

# Extract the p-value from the ANOVA summary
anova_summary <- summary(anova_result)
p_value <- anova_summary[[1]]["Pr(>F)"][[1]][1]

# Create the boxplot with the p-value
library(ggplot2)

ggplot(differential_introns_4d, aes(x = intron_speckle_go, y = GC_percent, fill = intron_speckle_go)) +
  geom_boxplot() +
  labs(
    title = "GC Content Comparison",
    subtitle = paste("ANOVA p-value:", signif(p_value, digits = 3)),
    x = "Group",
    y = "GC Content (%)"
  ) +
  theme_minimal() +
  scale_fill_manual(values = c("Rbfox" = "blue", "Non-Rbfox" = "gray"))

```

```{r anova length}
# Perform ANOVA
anova_result <- aov(LENGTH ~ intron_speckle_go, data = differential_introns_4d)

# Extract the p-value from the ANOVA summary
anova_summary <- summary(anova_result)
p_value <- anova_summary[[1]]["Pr(>F)"][[1]][1]

# Create the boxplot with the p-value
library(ggplot2)

ggplot(differential_introns_4d, aes(x = intron_speckle_go, y = LENGTH, fill = intron_speckle_go)) +
  geom_boxplot() +
  labs(
    title = "Intron Length Comparison",
    subtitle = paste("ANOVA p-value:", signif(p_value, digits = 3)),
    x = "Group",
    y = "Length"
  ) +
  theme_minimal() +
  scale_fill_manual(values = c("Rbfox" = "blue", "Non-Rbfox" = "gray"))
```

```{r plot splicing factors correlation}
# Subset the rows based on the selected events
subset_events <- correlation_matrix[event_list_corr, ]

# Extract the corresponding gene names for these events
gene_names <- subset_events$GENE

# Extract the numeric columns (expression values for events) - columns 3 to 14 in this example
subset_matrix <- as.matrix(subset_events[,-c(1:2)])
rownames(subset_matrix) <- subset_events$EVENT
# Compute the correlation matrix for the selected events (genes are rows)
cor_matrix <- cor(t(subset_matrix), method = "pearson", use = "complete.obs")

# Perform hierarchical clustering on the correlation matrix (both rows and columns)
distance_matrix <- dist(1 - cor_matrix)  # Compute distance as 1 - correlation
hc <- hclust(distance_matrix, method = "complete")  # Hierarchical clustering

# Reorder the correlation matrix based on the clustering result
ordered_cor_matrix <- cor_matrix[hc$order, hc$order]

# Convert the reordered correlation matrix into a long-format data frame for ggplot2
library(reshape2)
cor_df <- melt(ordered_cor_matrix)

# Create a data frame for event names with gene names appended
ordered_event_names <- rownames(ordered_cor_matrix)
ordered_event_labels <- paste(ordered_event_names, gene_names[hc$order], sep = " - ")

# Plot the clustered heatmap with gene names next to the event names
library(ggplot2)
ggplot(cor_df, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile(color = "white") +  # Tiles with white borders
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red", midpoint = 0,
    name = "Correlation"
  ) +
  labs(
    title = "Clustered Correlation Heatmap Among Selected Genes",
    x = "Genes",
    y = "Genes"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels
    axis.text.y = element_text(size = 10)  # Keep y-axis labels simple for now
  ) +
  scale_x_discrete(labels = ordered_event_labels) +  # Set x-axis labels to include gene names
  scale_y_discrete(labels = ordered_event_labels) +  # Set y-axis labels to include gene names
  geom_text(aes(label = round(value, 2)), size = 3, color = "black")  # Add correlation values


tmp<-read_tsv("results/clust_results_tao_exons/Clusters_Objects.tsv")[-1,]

```



```{r final arrange introns}
differential_introns_4d <- differential_introns_4d[!duplicated(differential_introns_4d$EVENT), ] %>%
  arrange(desc(GroupB),desc(intron_speckle_go),desc(abs(deltapsi)),GroupC)

event_list_corr<-c("MmuEX0039032","MmuEX0039029","MmuEX0039030","MmuEX0039092")
correlation_matrix_exons<-differential_introns_4d[,-c(3:6,19:34)]

correlation_matrix_exons<-correlation_matrix_exons[, c(colnames(correlation_matrix_exons)[1:2], metadata_tao$run_accession)]
subset_genes <- correlation_matrix_exons[correlation_matrix_exons$EVENT %in% differential_introns_4d$EVENT[differential_introns_4d$splicing_factor], ]
rest_genes <- correlation_matrix_exons[!correlation_matrix_exons$EVENT %in% differential_introns_4d$EVENT[differential_introns_4d$splicing_factor], ]
subset_matrix <- as.matrix(subset_genes[, 3:14])
rest_matrix <- as.matrix(rest_genes[, 3:14])


results <- data.frame(
  Gene1 = character(),
  Gene2 = character(),
  Correlation = numeric(),
  P_value = numeric(),
  Adjusted_P_value = numeric(),
  stringsAsFactors = FALSE
)

# Compute correlations and p-values
all_p_values <- c()
for (i in 1:nrow(subset_matrix)) {
  for (j in 1:nrow(rest_matrix)) {
    # Perform correlation test
    test <- cor.test(subset_matrix[i, ], rest_matrix[j, ], method = "pearson")
    
    # Store the raw p-values for later adjustment
    all_p_values <- c(all_p_values, test$p.value)
    
    # Temporarily store the results (to be adjusted later)
    results <- rbind(results, data.frame(
      Gene1 = subset_genes$GENE[i],
      Gene2 = rest_genes$GENE[j],
      Correlation = test$estimate,
      P_value = test$p.value,
      Adjusted_P_value = NA  # Placeholder for the adjusted p-value
    ))
  }
}

# Apply multiple testing correction (Benjamini-Hochberg)
adjusted_p_values <- p.adjust(all_p_values, method = "BH")

# Update the results data frame with adjusted p-values
results$Adjusted_P_value <- adjusted_p_values

# Filter significant results (adjusted p-value < 0.05)
significant_results <- results[results$Adjusted_P_value < 0.01 & abs(results$Correlation) >=0.9, ]

# Plot heatmap
corr_plot<-ggplot(significant_results, aes(x = Gene1, y = Gene2, fill = Correlation)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red", midpoint = 0,
    name = "Correlation"
  ) +
  labs(
    title = "Significant Correlations After Multiple Testing Correction",
    x = "Subset Genes (Gene1)",
    y = "Rest Genes (Gene2)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text.y = element_text(size = 10)
  ) +
  geom_text(aes(label = round(Correlation, 2)), size = 3, color = "black")
```

```{r plot splicing factors correlation introns}
# Subset the rows based on the selected events
subset_events <- differential_introns_4d[differential_introns_4d$EVENT %in% event_list_corr, ]

# Extract the corresponding gene names for these events
gene_names <- subset_events$GENE

# Extract the numeric columns (expression values for events) - columns 3 to 14 in this example
subset_matrix <- as.matrix(subset_events[,-c(1:6,19:34)])
rownames(subset_matrix) <- subset_events$EVENT
# Compute the correlation matrix for the selected events (genes are rows)
cor_matrix <- cor(t(subset_matrix), method = "pearson", use = "complete.obs")

# Perform hierarchical clustering on the correlation matrix (both rows and columns)
distance_matrix <- dist(1 - cor_matrix)  # Compute distance as 1 - correlation
hc <- hclust(distance_matrix, method = "complete")  # Hierarchical clustering

# Reorder the correlation matrix based on the clustering result
ordered_cor_matrix <- cor_matrix[hc$order, hc$order]

# Convert the reordered correlation matrix into a long-format data frame for ggplot2
library(reshape2)
cor_df <- melt(ordered_cor_matrix)

# Create a data frame for event names with gene names appended
ordered_event_names <- rownames(ordered_cor_matrix)
ordered_event_labels <- paste(ordered_event_names, gene_names[hc$order], sep = " - ")

# Plot the clustered heatmap with gene names next to the event names
library(ggplot2)
ggplot(cor_df, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile(color = "white") +  # Tiles with white borders
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red", midpoint = 0,
    name = "Correlation"
  ) +
  labs(
    title = "Clustered Correlation Heatmap Among Selected Genes",
    x = "Genes",
    y = "Genes"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels
    axis.text.y = element_text(size = 10)  # Keep y-axis labels simple for now
  ) +
  scale_x_discrete(labels = ordered_event_labels) +  # Set x-axis labels to include gene names
  scale_y_discrete(labels = ordered_event_labels) +  # Set y-axis labels to include gene names
  geom_text(aes(label = round(value, 2)), size = 3, color = "black")  # Add correlation values

```


```{r motif enrichment fasta prep}
library(BSgenome.Mmusculus.UCSC.mm10)  # mm10 genome sequence
library(GenomicFeatures)               # For handling genomic features
library(Biostrings)                    # For DNA sequence handling
library(org.Mm.eg.db)                  # Mouse gene annotation
library(AnnotationDbi)   
BiocManager::install("TxDb.Mmusculus.UCSC.mm10.knownGene")
library(TxDb.Mmusculus.UCSC.mm10.knownGene)



non_rbfox_genes<-head(unique(significant_results$Gene2[!significant_results$Gene1 =="Rbfox2"]), 370)

txdb <- TxDb.Mmusculus.UCSC.mm10.knownGene

# Convert gene symbols to Entrez IDs
entrez_ids <- mapIds(org.Mm.eg.db, keys = non_rbfox_genes, column = "ENTREZID", keytype = "SYMBOL", multiVals = "first")

# Remove missing (NA) mappings
valid_indices <- !is.na(entrez_ids)
entrez_ids <- entrez_ids[valid_indices]
valid_gene_list <- gene_list[valid_indices]  # Keep only valid genes

# Get gene coordinates
gene_coords <- genes(txdb)[names(genes(txdb)) %in% entrez_ids]

# Extract sequences from mm10 genome
mm10_genome <- BSgenome.Mmusculus.UCSC.mm10
gene_sequences <- getSeq(mm10_genome, gene_coords)

# Ensure the names are assigned correctly
if (length(gene_sequences) == length(valid_gene_list)) {
    names(gene_sequences) <- valid_gene_list  # Assign only matching names
} else {
    warning("Mismatch between extracted sequences and gene names. Check manually.")
}

# Write to a FASTA file
output_fasta <- "non_rbfox_genes.fasta"
writeXStringSet(gene_sequences, filepath = output_fasta, format = "fasta")


rbfox_genes<-unique(significant_results$Gene2[significant_results$Gene1 =="Rbfox2"])


# Convert gene symbols to Entrez IDs
entrez_ids <- mapIds(org.Mm.eg.db, keys = rbfox_genes, column = "ENTREZID", keytype = "SYMBOL", multiVals = "first")

# Remove missing (NA) mappings
valid_indices <- !is.na(entrez_ids)
entrez_ids <- entrez_ids[valid_indices]
valid_gene_list <- gene_list[valid_indices]  # Keep only valid genes

# Get gene coordinates
gene_coords <- genes(txdb)[names(genes(txdb)) %in% entrez_ids]

# Extract sequences from mm10 genome
gene_sequences <- getSeq(mm10_genome, gene_coords)

# Ensure the names are assigned correctly
if (length(gene_sequences) == length(valid_gene_list)) {
    names(gene_sequences) <- valid_gene_list  # Assign only matching names
} else {
    warning("Mismatch between extracted sequences and gene names. Check manually.")
}

# Write to a FASTA file
output_fasta <- "rbfox_genes.fasta"
writeXStringSet(gene_sequences, filepath = output_fasta, format = "fasta")

```



# Final Candidates List Sorted { .tabset}

These final lists show all the events found to be significant in all studies (in a pairwise comparison, myotubes vs myoblasts). Moreover, they are sorted by their average dPSI (the of dPSI across studies) an the average F statistic, and features such as the event length, splice scores, GC percent, whether it has an ontology related to Speckles (according to Apex2 and ARTR-seq papers) and if the gene containing the event appears in the gene lists (GroupA: permanently closed to speckles, groupB: transiently closed to speckles, GroupC: never closed to speckles) found by *Wu, J. et al. Dynamics of RNA localization to nuclear speckles are connected to splicing efficiency. Science Advances 10, eadp7727 (2024)*.


## Exons

```{r final sorted exons table}
# Render DataTable with enhancements
datatable(
  select(final_exon_list, -ENTREZID, -avg_Pdiff, -sequence, -avg_FDR, -COORD),
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
)


write.csv(final_exon_list,
          file = file.path(output_dir, paste0("sorted_final_exon_list_", format(Sys.Date(), "%Y%m%d"), ".csv")),
          row.names = FALSE)
```

## Introns

```{r final sorted intron table}
# Render DataTable with enhancements
datatable(
  select(final_intron_list, -ENTREZID, -avg_Pdiff, -sequence,-avg_FDR, -COORD),
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
    columnDefs = list(
      list(targets = "_all", className = "dt-center"),    # Center-align all columns
      list(
        targets = 3,  # Highlight significant Pdiff
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && parseFloat(data) > 0.99) {
               return '<span style=\"color: green; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      ),
      list(
        targets = 4,  # Highlight large deltapsi values
        render = JS(
          "function(data, type, row) {
             if (type === 'display' && Math.abs(parseFloat(data)) > 0.5) {
               return '<span style=\"color: red; font-weight: bold;\">' + data + '</span>';
             }
             return data;
           }"
        )
      )
    )
  ),
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
)


write.csv(final_intron_list,
          file = file.path(output_dir, paste0("sorted_final_intron_list_", format(Sys.Date(), "%Y%m%d"), ".csv")),
          row.names = FALSE)
```


# Splicing Dynamics Heatmap of RBFOX2 correlated genes

```{r heatmap prep, results='hide', fig.show='hide'}
set.seed(45)

# Extract all events
tao_all <- filterEvents(
  tao_events,
  types = c("C1", "C2", "C3", "S", "MIC", "IR"),
  N = 2
)

# Convert PSI values to a matrix and set row names
tao_matrix <- tao_all$PSI[, 7:18] %>%
  as.matrix()
rownames(tao_matrix) <- tao_all$PSI$EVENT

# Filter rows based on the final event lists
filtered_events <- unique(c(
  differential_exons_4d$EVENT[differential_exons_4d$GENE %in% rbfox_genes],
  differential_introns_4d$EVENT[differential_introns_4d$GENE %in% rbfox_genes]
))
tao_matrix <- tao_matrix[rownames(tao_matrix) %in% filtered_events, ]

# Arrange columns based on metadata
metadata_tao <- arrange(metadata_tao, experiment_title)
tao_matrix <- tao_matrix[, metadata_tao$run_accession]

# Create a dendrogram for the columns
col_dend <- hclust(dist(t(tao_matrix))) %>%
  as.dendrogram() %>%
  color_branches(k = 4) # Color branches with 4 clusters

# Check if row names contain "EX"
contains_EX <- grepl("EX", rownames(tao_matrix))

# Define an improved color gradient for the heatmap
col_fun <- colorRamp2(
  c(0, 50, 100),
  c("purple", "white", "orange")
)

number_splices<-8

reference_table<-data.frame(EVENT=c(differential_exons_4d$EVENT,differential_introns_4d$EVENT),GENE=c(differential_exons_4d$GENE,differential_introns_4d$GENE))


ht<-Heatmap(
  tao_matrix, name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns  = col_dend,
  column_title = "Myoblast Samples at Different stages f development",
  row_title = "Splicing Events",
  column_names_rot = 45,
  column_labels = metadata_tao$experiment_title,
  column_dend_reorder = 1:12,
  row_km = number_splices,
  row_dend_reorder = F,
  rect_gp = gpar(col = "white", lwd = 0.3),
  column_names_gp = gpar(fontsize = 16),
  show_row_names = FALSE,

)
ht = draw(ht); clustered_events<-row_order(ht)
text_list<-list()
# Loop through clustered events and assign dynamic names
for (i in 1:length(clustered_events)) {
  enrich_events <- enrichr(
    reference_table$GENE[reference_table$EVENT %in% rownames(tao_matrix)[clustered_events[[i]]]],
    databases = c("GO_Biological_Process_2023", "GO_Cellular_Component_2023", "GO_Molecular_Function_2023")
  )

  # Assign the dynamic name and value
  text_list[[paste0("text", i)]] <- paste(
    enrich_events$GO_Cellular_Component_2023$Term[1],
    enrich_events$GO_Cellular_Component_2023$Term[2],
    enrich_events$GO_Cellular_Component_2023$Term[3],
    enrich_events$GO_Molecular_Function_2023$Term[1],
    enrich_events$GO_Molecular_Function_2023$Term[2],
    enrich_events$GO_Molecular_Function_2023$Term[3],
    sep = "; \n"
  )
}

protein_impact <- read.table("PROT_IMPACT-mm10-v2.3.tab", sep = "\t", 
                             header = TRUE, stringsAsFactors = FALSE, fill = TRUE, quote = "")

events_for_impact<-rownames(tao_matrix)

final_impact <- protein_impact %>%
  filter(EventID %in% events_for_impact) %>%
  arrange(match(EventID, events_for_impact)) %>%
  mutate(ONTO = ifelse(grepl("isoform", ONTO, ignore.case = TRUE), "-1", ONTO)) %>%
  mutate(ONTO = ifelse(grepl("UTR", ONTO, ignore.case = TRUE), "-2", ONTO)) %>%
  mutate(ONTO = case_when(
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("inclusion", ONTO, ignore.case = TRUE) ~ "2",
    grepl("ORF", ONTO, ignore.case = TRUE) & grepl("exclusion", ONTO, ignore.case = TRUE) ~ "1",
    TRUE ~ ONTO
  )) %>%
  mutate(ONTO = as.numeric(ONTO)) %>%
  replace_na(list(ONTO = 0))

# Remove non-annotated EVENTS from tao_matrix
tao_matrix <- tao_matrix[rownames(tao_matrix) %in% final_impact$EventID, ]

# Define the left annotation (points) with axis labels
left_annotation <- rowAnnotation(
  Impact = anno_points(
    final_impact$ONTO,
    width = unit(4, "cm"),  # Adjusted width
    size = unit(4, "mm"),   # Adjusted size of points
    axis_param = list(
      side = "top",
      at = -2:2, # Numeric values to label
      labels = c(
        "Regulatory (5´UTR)",
        "Alternative Isoform",
        "Unknown/NonCoding",
        "ORF disruption upon exclusion",
        "ORF disruption upon inclusion"
      ),
      labels_rot = 45, # Rotation of labels
      gp = gpar(fontsize = 15) # Text style
    )
  )
)

# Define the right annotation (foo)
right_annotation <- rowAnnotation(
  foo = anno_empty(
    border = FALSE,
    width = max_text_width(unlist(text_list)) + unit(4, "mm")
  )
)
```

### Heatmap showcasing the PSI of every candidate EX and IN

**Note**: Gene ontology of *Cellular Component* and *Molecular Function* for each of the clustered blocks (splicing events that the *pearson* algorithm has found they behave similarly) appears on the right. The impact of that Event at protein level is shown on the left.

```{r heatmap_plot, fig.width=30, fig.height=25, echo=TRUE, out.width="100%"}
set.seed(45)

ht <- Heatmap(
  tao_matrix, 
  name = "PSI",
  clustering_distance_rows = "pearson",
  col = col_fun,
  cluster_columns = col_dend,
  column_title = "C2C12 Samples at Different Stages of Development",
  column_title_gp = gpar(fontsize = 25, fontface = "bold"),
  row_title = "Splicing Events",
  row_title_gp = gpar(fontsize = 16, fontface = "italic"),
  column_names_rot = 45,
  column_dend_reorder = c(1:12),
  column_labels = metadata_tao$experiment_title,
  row_km = number_splices,
  left_annotation = left_annotation,   # Add the points on the left
  right_annotation = right_annotation, # Add foo on the right
  row_dend_reorder = F,
  column_names_gp = gpar(fontsize = 18, fontface = "bold", col = "darkblue"),
  show_row_names = FALSE,
  row_gap = unit(6, "mm"), # Adjust the gap size between rows
  column_gap = unit(4, "mm"), # Adjust the gap size between columns
  heatmap_legend_param = list(
    title = "PSI Value",
    title_gp = gpar(fontsize = 40),
    labels_gp = gpar(fontsize = 10),
    legend_position = c(-20, 0),  # Move the legend closer to the center (x, y coordinates)
    legend_direction = "vertical" # Align the legend horizontally
  )
)

# Draw the heatmap
ht <- draw(ht)

# Decorate the "foo" annotation slices (on the right)
for (i in seq_along(clustered_events)) {
  decorate_annotation("foo", slice = i, {
    grid.rect(x = 0, width = unit(2, "mm"), gp = gpar(fill = i, col = NA), just = "left")
    grid.text(paste(text_list[[i]], collapse = "\n"), x = unit(4, "mm"), just = "left", gp = gpar(fontsize = 15))
  })
}
```

### Table of Events from Heatmap

```{r, table heatmap final}
row_order <- unlist(row_order(ht), use.names = F)
col_order <- unlist(column_order(ht), use.names = F)

cluster_index <- unlist(lapply(seq_along(row_order(ht)), function(i) rep(i, length(row_order(ht)[[i]]))))

# Reorder the original matrix based on clustering
clustered_matrix <- tao_matrix[row_order, col_order]
final_impact_string<-protein_impact %>%
  filter(EventID %in% events_for_impact) %>%
  arrange(match(EventID, events_for_impact))
final_impact_string<- final_impact_string[match(rownames(clustered_matrix),final_impact_string$EventID),]


heatmap_dataframe<-tibble(EVENT=rownames(clustered_matrix), heatmap_cluster=cluster_index, protein_impact=final_impact_string$ONTO)
heatmap_dataframe$GENE<-reference_table$GENE[match(heatmap_dataframe$EVENT, reference_table$EVENT)]
heatmap_dataframe<-select(heatmap_dataframe, GENE, EVENT, protein_impact, heatmap_cluster)

# Render DataTable with enhancements
datatable(
  heatmap_dataframe,
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))


```

### Enrichment of ORF Disrupted Genes { .tabset}

Note that interpretation should be done taking into account whether that specific ORF-disrupting events is being spliced in or out. This just may give an idea of the ontology of disrupted proteins.

```{r orf enrichr}
enrichdata<-enrichr(unique(reference_table$GENE[reference_table$EVENT %in% final_impact$EventID[final_impact$ONTO %in% c(1,2)]]), databases = c("GO_Biological_Process_2023","GO_Cellular_Component_2023","GO_Molecular_Function_2023"))

orf_comparingcontrol_events<-unique(reference_table$EVENT[reference_table$EVENT %in% final_impact$EventID[final_impact$ONTO %in% c(1,2)]])
```

#### GO Biological Process

```{r orf bioprocess fmndko, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[1]])
datatable(
  enrichdata[[1]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Cellular Component

```{r orf cellcomponent fmndko, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[2]])
datatable(
  enrichdata[[2]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

#### GO Molecular Function

```{r orf molfunction fmndko, fig.width=15, fig.height=8}
plotEnrich(enrichdata[[3]])
datatable(
  enrichdata[[3]],
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

# Rbfox2 correlated genes Dataframe { .tabset}

## Exons

```{r final df}

speckles_molecularcell<-read_xlsx("apex2_seq_molecularcell.xlsx")
rbfox_exons<-read_excel("rbfox_exons.xls")
rbfox_events_pdac <- read_excel("rbfox_events_frompdac_good.xlsx")
differential_exons_4d$rbfox<-tolower(differential_exons_4d$GENE) %in% tolower(c(rbfox_events_pdac[[1]], rbfox_exons$`hg19.kgXref.
geneSymbol` ))

differential_exons_4d$speckle_molecularcell<-tolower(differential_exons_4d$GENE) %in% tolower(speckles_molecularcell$`Table S4 - Related to Figure 2- Dual Index scores of transcripts identified with the markers belonging to each nuclear domain`)


datatable(
  arrange(differential_exons_4d[differential_exons_4d$GENE %in% c("Rbfox2",rbfox_genes),], desc(speckle_molecularcell),desc(GroupA),desc(GroupB),desc(rbfox), desc(intron_speckle_go),desc(abs(deltapsi))),
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```

## Introns

```{r final df}

differential_introns_4d$rbfox<-tolower(differential_introns_4d$GENE) %in% tolower(c(rbfox_events_pdac[[1]], rbfox_exons$`hg19.kgXref.
geneSymbol` ))

differential_introns_4d$speckle_molecularcell<-tolower(differential_introns_4d$GENE) %in% tolower(speckles_molecularcell$`Table S4 - Related to Figure 2- Dual Index scores of transcripts identified with the markers belonging to each nuclear domain`)


datatable(
  arrange(differential_introns_4d[differential_introns_4d$GENE %in% c("Rbfox2",rbfox_genes),], desc(speckle_molecularcell),desc(GroupA),desc(GroupB),desc(rbfox), desc(intron_speckle_go),desc(abs(deltapsi))),
  options = list(
    pageLength = 10,                      # Rows per page
    autoWidth = TRUE,                     # Adjust column widths automatically
    dom = 'Bfrtip',                       # Add buttons for export
    buttons = c("copy", "csv", "excel", "pdf"),  # Simplified button definitions
  rownames = FALSE,                       # Disable row names
  extensions = "Buttons"                  # Enable export buttons
))
```


# Event Densities 

```{r densities_per_event, warning=FALSE, message=FALSE, fig.width=16, fig.height=8}
event_names_exon <- c("MmuEX0028570", "MmuEX0028566", "MmuEX0028567", "MmuEX0019782", 
  "MmuEX0019783", "MmuINT1010600", "MmuEX0040282", "MmuEX1017973", 
  "MmuEX0039029", "MmuEX0039030", "MmuEX0039032", "MmuEX0012919", 
  "MmuEX0048979","MmuINT0112573","MmuINT1033613","MmuINT0095481")


# Generate individual plots and store them in a list
plots <- lapply(event_names_exon, function(eventID) {
  # Extract the corresponding gene name for the event
  geneName <- tao_events$PSI$GENE[match(eventID, tao_events$PSI$EVENT)]

  # Generate the plot
  tdensities <- plotIndividualDensitiesList(
    eventID = eventID,
    npoints = 500,
    psitable = tao_events$PSI,
    qualtable = tao_events$Qual,
    groupList = groupList_tao,
    maxDevTable = maxDevSimulationN100,
    seed = TRUE,
    CoverageWeight = FALSE
  )

  # Add titles and themes
  tdensities +
    theme_minimal(base_family = font) +
    theme(
      plot.title = element_text(size = 14, face = "bold"),  # Title size
      axis.text = element_text(size = 12),                # Axis label size
      axis.title = element_text(size = 14),               # Axis text size
      axis.text.y = element_blank(),                      # Remove Y-axis text
      axis.title.y = element_blank(),                     # Remove Y-axis title
      axis.ticks.y = element_blank()                      # Remove Y-axis tick
    ) +
    ggtitle(paste(geneName, eventID))
})

# Combine all plots with patchwork
final_plot_exons <- wrap_plots(plots, ncol = 4, byrow = TRUE) +
  plot_layout(guides = 'collect') +
  plot_annotation(
    caption = paste0("Created by AG on ", Sys.Date())
  )
# Display the combined plot
final_plot_exons
```





# System Settings

```{r session info}
sessionInfo()
```


